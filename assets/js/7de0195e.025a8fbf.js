"use strict";(self.webpackChunkblog_yongseongkim=self.webpackChunkblog_yongseongkim||[]).push([[5469],{17433:(n,e,a)=>{a.r(e),a.d(e,{assets:()=>s,contentTitle:()=>c,default:()=>h,frontMatter:()=>o,metadata:()=>t,toc:()=>l});var t=a(92444),i=a(74848),r=a(28453);const o={title:"Spring JPA TransactionTemplate Internals",tags:["spring","jpa","transaction"]},c="\ucd5c\uadfc\uc5d0 \ub9c8\uc8fc\ud55c \ubb38\uc81c\ub4e4",s={authorsImageUrls:[]},l=[{value:"\uccab\ubc88\uc9f8 \ubb38\uc81c, add column to vehicle table DDL",id:"\uccab\ubc88\uc9f8-\ubb38\uc81c-add-column-to-vehicle-table-ddl",level:2},{value:"\ub450\ubc88\uc9f8 \ubb38\uc81c, ReadReplica Transaction in Serializable Transaction",id:"\ub450\ubc88\uc9f8-\ubb38\uc81c-readreplica-transaction-in-serializable-transaction",level:2},{value:"Transaction \uc5d0 \ud544\uc694\ud55c Context \ub97c \uad6c\uc131\ud558\uae30",id:"transaction-\uc5d0-\ud544\uc694\ud55c-context-\ub97c-\uad6c\uc131\ud558\uae30",level:2},{value:"Context \ub85c \ub370\uc774\ud130\uc5d0 \uc811\uadfc\ud558\uae30",id:"context-\ub85c-\ub370\uc774\ud130\uc5d0-\uc811\uadfc\ud558\uae30",level:2},{value:"Commit \uacfc \ub9ac\uc18c\uc2a4 \uc815\ub9ac",id:"commit-\uacfc-\ub9ac\uc18c\uc2a4-\uc815\ub9ac",level:2},{value:"\uc608\uc2dc",id:"\uc608\uc2dc",level:2},{value:"\uccab\ubc88\uc9f8 \ubb38\uc81c, add column to vehicle table DDL",id:"\uccab\ubc88\uc9f8-\ubb38\uc81c-add-column-to-vehicle-table-ddl-1",level:2},{value:"\ub450\ubc88\uc9f8 \ubb38\uc81c, ReadReplica Transaction in Serializable Transaction",id:"\ub450\ubc88\uc9f8-\ubb38\uc81c-readreplica-transaction-in-serializable-transaction-1",level:2}];function d(n){const e={a:"a",code:"code",h1:"h1",h2:"h2",hr:"hr",li:"li",ol:"ol",p:"p",pre:"pre",ul:"ul",...(0,r.R)(),...n.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(e.p,{children:"\ud68c\uc0ac\uc5d0\uc11c \ud504\ub860\ud2b8 \uac1c\ubc1c\uc744 \ud558\ub2e4\uac00 \uc11c\ubc84 \uac1c\ubc1c\uc744 \uc81c\ub300\ub85c \uc2dc\uc791\ud55c\uc9c0 1\ub144 \ubc18 \uc815\ub3c4 \uc9c0\ub0ac\uc2b5\ub2c8\ub2e4.\nSpring \uad00\ub828 \uc778\ud130\ub137 \uac15\uc758, \uacf5\uc2dd \ubb38\uc11c \uc678\uc5d0\ub294 \ub530\ub85c \uacf5\ubd80\ud558\uace0 \uc788\uc9c0 \uc54a\uc558\ub294\ub370 \ud68c\uc0ac\uc5d0\uc11c \uacaa\uc740 \ubb38\uc81c\ub97c \uae30\ubc18\uc73c\ub85c Spring JPA \ub0b4\ubd80 \ucf54\ub4dc\ub97c \ud30c\uc545\ud588\ub358 \uacbd\ud5d8\uc744 \uae30\ub85d\ud574\ub450\ub824\uace0 \ud569\ub2c8\ub2e4."}),"\n",(0,i.jsx)(e.h2,{id:"\uccab\ubc88\uc9f8-\ubb38\uc81c-add-column-to-vehicle-table-ddl",children:"\uccab\ubc88\uc9f8 \ubb38\uc81c, add column to vehicle table DDL"}),"\n",(0,i.jsxs)(e.p,{children:["\ucd5c\uadfc\uc5d0 ",(0,i.jsx)(e.a,{href:"https://www.tadatada.com/",children:"\ud0c0\ub2e4"})," \uc11c\ubc84\ub97c \ubc30\ud3ec \ud558\ub358 \uc911\uc5d0 \ucc28\ub7c9 \uad00\ub828 \ud14c\uc774\ube14\uc5d0 \uceec\ub7fc\uc744 \ucd94\uac00\ud558\ub294 DDL \uacfc \ucc28\ub7c9 \uc704\uce58 \ucd94\uc801 \ub370\uc774\ud130 \ucc98\ub9ac\uc5d0\uc11c deadlock \uc774 \ubc1c\uc0dd\ud588\uc2b5\ub2c8\ub2e4.\n\ud0c0\ub2e4\uc5d0\uc11c\ub294 \ub4dc\ub77c\uc774\ubc84(driver), \uc6b4\ud589\ucc28\ub7c9(vehicle), \uc6b4\ud589(ride) \ub4f1\uc774 foreign key \ub97c \uc774\uc6a9\ud574\uc11c \ucc38\uc870\ud558\uace0 \uc788\uc2b5\ub2c8\ub2e4.\n\uadf8\ub9ac\uace0 \uc77c\ubc18 \uc815\ubcf4\ub97c \uc800\uc7a5\ud558\ub294 \ub370\uc774\ud130\ubca0\uc774\uc2a4\uc640 \ucc28\ub7c9 \uc704\uce58\ub97c \ucd94\uc801\ud558\ub294 \ub370\uc774\ud130\ubca0\uc774\uc2a4\ub97c \ub530\ub85c \uad00\ub9ac\ud558\uace0 \uc788\uc2b5\ub2c8\ub2e4."]}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-kotlin",children:'class TestController(\n  private val transactionTemplate: TransactionTemplate,\n  @Qualifier("trackerDB") private val trackerTransactionTemplate: TransactionTemplate,\n) {\n  private fun transactionInTrackerTransaction() {\n    trackerTransactionTemplate\n      .also { it.isolationLevel = IsolationLevel.SERIALIZABLE }\n      .execute {\n        val trackerRide = trackerRepository.findById("...")\n\n        // No explicit transaction\n        val acceptedRide = rideRepository.findById("...")\n\n        transactionTemplate\n          .execute {\n            driverRepository.findById("...")\n            vehicleRepository.findById("...")\n          }\n      }\n  }\n}\n'})}),"\n",(0,i.jsxs)(e.p,{children:["\ud0c0\ub2e4 \ucc28\ub7c9\uc758 \uc704\uce58\ub97c \ucc98\ub9ac\ud558\ub294 \uacfc\uc815\uc740 \uc704 \ucf54\ub4dc\uc640 \uac19\uc774 \ucc28\ub7c9 \uc704\uce58(tracker), \uc6b4\ud589\uc815\ubcf4(ride), \ub4dc\ub77c\uc774\ubc84(driver) \uadf8\ub9ac\uace0 \ucc28\ub7c9(vehicle) \ud14c\uc774\ube14\uc5d0 \uc811\uadfc\ud569\ub2c8\ub2e4.\n\uc774 \uacfc\uc815\uc740 \ub9ce\uc740 \ub4dc\ub77c\uc774\ubc84\uc758 \uc704\uce58 \uc815\ubcf4\ub97c \ucc98\ub9ac\ud574\uc57c \ud558\ubbc0\ub85c \ube48\ubc88\ud558\uac8c \ud638\ucd9c\ub429\ub2c8\ub2e4.\n\uc774\ub7ec\ud55c \uc0c1\ud669\uc5d0\uc11c vehicle \uc5d0 column \uc744 \ucd94\uac00\ud558\ub294 DDL \uc744 \uc2e4\ud589\ud558\uba74 vehicle, vehicle \uacfc foreign key \ub85c \uc5f0\uacb0\ub41c \ud14c\uc774\ube14(ride, driver, ...)\uc5d0 metadata lock \uc744 \uc7a1\uc73c\ub824\uace0 \ud569\ub2c8\ub2e4.\nDDL \uc774 vehicle \u2192 ride \ub85c metadata lock \uc744 \ud68d\ub4dd\ud558\ub294 \uacfc\uc815\uc5d0\uc11c \uc704 \ucf54\ub4dc\uc5d0\uc11c\ub294 ride \u2192 vehicle \uc21c\uc11c\ub85c metadata lock \uc744 \uc7a1\uc73c\ub824\uace0 \ud558\ub2c8 deadlock \uc0c1\ud0dc\uc5d0 \ube60\uc838\ubc84\ub838\uc2b5\ub2c8\ub2e4.\n",(0,i.jsx)(e.code,{children:"rideRepository.findById"})," \ub294 \ub370\uc774\ud130\ub97c \uac00\uc838\uc628 \ud6c4 metadata lock \uc744 \ud574\uc81c\ud574\uc57c\ud558\ub294\ub370 trackerTransactionTemplate \ubc94\uc704 \ub0b4\ub0b4 lock \uc744 \ud68d\ub4dd\ud55c \ucc44\ub85c \uc788\uc5b4 deadlock \uc5d0 \ube60\uc84c\uc2b5\ub2c8\ub2e4.\n\uc704 \ubb38\uc81c\ub294 ",(0,i.jsx)(e.code,{children:"rideRepository.findById"})," \uc744 transactionTemplate \uc73c\ub85c \uac10\uc2f8\uba74 ride \uc5d0 \ub300\ud55c metadata lock \uc774 \ube60\ub974\uac8c \ud574\uc81c\ub418\uba74\uc11c \ud574\ub2f9 \ubb38\uc81c\ub294 \ud574\uacb0\ub429\ub2c8\ub2e4."]}),"\n",(0,i.jsx)(e.h2,{id:"\ub450\ubc88\uc9f8-\ubb38\uc81c-readreplica-transaction-in-serializable-transaction",children:"\ub450\ubc88\uc9f8 \ubb38\uc81c, ReadReplica Transaction in Serializable Transaction"}),"\n",(0,i.jsxs)(e.p,{children:["\ub2e4\ub978 \uae30\ub2a5\uc744 \ubc30\ud3ec\ud558\ub294 \uacfc\uc815\uc5d0\uc11c ",(0,i.jsx)(e.code,{children:"could not execute statement [The MySQL server is running with the --read-only option so it cannot execute this statement]"})," \uc5d0\ub7ec\uac00 \ubc1c\uc0dd\ud588\uc2b5\ub2c8\ub2e4.\n\ud0c0\ub2e4\uc5d0\uc11c\ub294 \uc77d\uae30 \ubd80\ud558 \ubd84\uc0b0\uc744 \uc704\ud574 ReadReplica \ub370\uc774\ud130\ubca0\uc774\uc2a4\ub97c \uc0ac\uc6a9\ud558\uba70, TransactionTemplate\uc5d0 ",(0,i.jsx)(e.code,{children:"isReadReplicaEnabled"}),"\ub77c\ub294 \ucee4\uc2a4\ud140 \uc18d\uc131\uc744 \ucd94\uac00\ud558\uc5ec ReadReplica\ub85c \ub77c\uc6b0\ud305\ud560 \uc218 \uc788\ub3c4\ub85d \uad6c\ud604\ud588\uc2b5\ub2c8\ub2e4."]}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-kotlin",children:'@RestController\nclass TestController(\n  private val transactionTemplate: TransactionTemplate,\n) {\n  @Transactional(isolation = Isolation.SERIALIZABLE)\n  private fun readReplicaInSerializable() {\n    // \uc778\uc99d \ud1a0\ud070 \ud655\uc778\uc740 \uc544\ub798\uc640 \uac19\uc774 \uc720\uc800 \uc815\ubcf4\uc5d0 \uc811\uadfc\ud55c\ub2e4.\n    transactionTemplate\n      .also { it.isReadReplicaEnabled = true }\n      .execute {\n        userRepository.findById("...")\n      }\n    val ride = rideRepository.findById("...")\n    // update something\n    rideRepository.save(ride)\n  }\n}\n'})}),"\n",(0,i.jsxs)(e.p,{children:["\ub300\ubd80\ubd84 API \uc5d0 \ud1a0\ud070\uc5d0 \ub300\ud55c \uac80\uc99d\uc744 \ud558\ub294 \uacfc\uc815\uc774 \uc788\uc2b5\ub2c8\ub2e4. \uc774\ub54c \ub9c8\uc2a4\ud130 \ub370\uc774\ud130\ubca0\uc774\uc2a4\ub97c \ubcf4\uae30 \ubcf4\ub2e4\ub294 READ REPLICA \ub370\uc774\ud130\ubca0\uc774\uc2a4\uc5d0 \uc811\uadfc\ud574\uc11c \ubd80\ud558\ub97c \ubd84\uc0b0\ud569\ub2c8\ub2e4.\n\uadfc\ub370 \uc704\uc640 \uac19\uc774 \ucf54\ub4dc\ub97c \uc791\uc131\ud558\uba74 \uc774\ud6c4 \ub370\uc774\ud130\ub97c \uc5c5\ub370\uc774\ud2b8\ud558\ub294 ",(0,i.jsx)(e.code,{children:"rideRepository.save"})," \uc5d0\uc11c \ubb38\uc81c\uac00 \ubc1c\uc0dd\ud569\ub2c8\ub2e4.\n\uc678\ubd80 Transaction\uc774 \uba3c\uc800 \uc2dc\uc791\ub418\uc5c8\uc73c\ub2c8 \ub9c8\uc2a4\ud130 \ub370\uc774\ud130\ubca0\uc774\uc2a4 \uc5f0\uacb0\uc744 \uc0ac\uc6a9\ud558\uace0, \ub0b4\ubd80 transactionTemplate\ub3c4 \uc774\ub97c \uc7ac\ud65c\uc6a9\ud560 \uac83\uc73c\ub85c \uae30\ub300\ud588\uc9c0\ub9cc \uc2e4\uc81c\ub85c\ub294 \ub2e4\ub974\uac8c \ub3d9\uc791\ud588\uc2b5\ub2c8\ub2e4."]}),"\n",(0,i.jsx)(e.p,{children:"\ub450 \ubb38\uc81c\uc5d0 \ub300\ud574\uc11c \uc815\ud655\ud55c \uc6d0\uc778\uc744 \ud30c\uc545\ud558\uae30 \uc704\ud574\uc11c\ub294 TransactionTemplate \uc774 \uc5b4\ub5bb\uac8c \ub3d9\uc791\ud558\ub294\uc9c0, TransactionTemplate \uc774 \uc5c6\uc744 \ub54c Repository \ub85c \ub370\uc774\ud130 \uc811\uadfc\ud560 \ub54c \uc5b4\ub5bb\uac8c \ub3d9\uc791\ud558\ub294\uc9c0 \uadf8\ub9ac\uace0 \ub370\uc774\ud130\ubca0\uc774\uc2a4\uc5d0 \uc5f0\uacb0\uc744 \uc5b4\ub5bb\uac8c \ub9fa\ub294\uc9c0 \uc774\ud574\ud560 \ud544\uc694\uac00 \uc788\uc5c8\uc2b5\ub2c8\ub2e4."}),"\n",(0,i.jsx)(e.h1,{id:"\uba3c\uc800-transactiontemplate-\ub3d9\uc791-\uc774\ud574\ud558\uae30",children:"\uba3c\uc800 TransactionTemplate \ub3d9\uc791 \uc774\ud574\ud558\uae30"}),"\n",(0,i.jsxs)(e.p,{children:[(0,i.jsx)(e.code,{children:"TransactionTemplate.execute"})," \ub294 \ud06c\uac8c 3 step \uc73c\ub85c \ub098\ub20c \uc218 \uc788\uc2b5\ub2c8\ub2e4."]}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-java",children:"public <T> T execute(TransactionCallback<T> action) {\n  // Step 1: Transaction \uc5d0 \ud544\uc694\ud55c Context \ub97c \uad6c\uc131\ud558\uae30\n  TransactionStatus status = this.transactionManager.getTransaction(this);\n\n  try {\n    // Step 2: Context \ub85c \ub370\uc774\ud130\uc5d0 \uc811\uadfc\ud558\uae30\n    result = action.doInTransaction(status);\n  } catch() { /* rollback */ }\n\n  // Step 3: Commit \uacfc \ub9ac\uc18c\uc2a4 \uc815\ub9ac\n  this.transactionManager.commit(status);\n  return result;\n}\n"})}),"\n",(0,i.jsx)(e.h2,{id:"transaction-\uc5d0-\ud544\uc694\ud55c-context-\ub97c-\uad6c\uc131\ud558\uae30",children:"Transaction \uc5d0 \ud544\uc694\ud55c Context \ub97c \uad6c\uc131\ud558\uae30"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-java",children:"public final TransactionStatus getTransaction(TransactionDefinition definition) {\n  Object transaction = doGetTransaction();\n  if (isExistingTransaction(transaction)) {\n    return handleExistingTransaction(definition, transaction, debugEnabled);\n  }\n  return startTransaction(definition, transaction, debugEnabled, suspendedResources);\n}\n"})}),"\n",(0,i.jsxs)(e.p,{children:[(0,i.jsx)(e.code,{children:"AbstractPlatformTransactionManager.getTransaction"})," \uc5d0\uc11c\ub294 \uc774\ubbf8 \uc120\uc5b8\ud55c Transaction \uc774 \uc788\ub294\uc9c0, \uc774\ubbf8 Transaction \uc774 \uc9c4\ud589\uc911\uc774\ub77c\uba74 Propagation \uc815\ucc45\uc5d0 \ub530\ub77c \uc0c8\ub85c\uc6b4 Transaction \uc5d0 \ud544\uc694\ud55c Context \ub97c \ub9cc\ub4e4\uc9c0 \uc815\ud569\ub2c8\ub2e4."]}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-java",children:"// JpaTransactionManager.doGetTransaction\nEntityManagerHolder emHolder = (EntityManagerHolder) TransactionSynchronizationManager.getResource(obtainEntityManagerFactory());\nif (emHolder != null) {\n  txObject.setEntityManagerHolder(emHolder, false);\n}\nif (getDataSource() != null) {\n  ConnectionHolder conHolder = (ConnectionHolder)TransactionSynchronizationManager.getResource(getDataSource());\n  txObject.setConnectionHolder(conHolder);\n}\n"})}),"\n",(0,i.jsxs)(e.p,{children:["\uc5ec\uae30\uc11c Context(EntityManager, Connection) \ub294 ",(0,i.jsx)(e.code,{children:"TransactionSynchronizationManager"})," \ub97c \ud1b5\ud574 \uac00\uc838\uc635\ub2c8\ub2e4. ",(0,i.jsx)(e.code,{children:"TransactionSynchronizationManager"})," \ub294 Resource \ub4e4\uc744 ThreadLocal \uc5d0 \uc800\uc7a5\ud569\ub2c8\ub2e4."]}),"\n",(0,i.jsxs)(e.p,{children:["\uc0c8\ub85c \uc2dc\uc791\ud558\ub294 Transaction \uc758 \uacbd\uc6b0 \uc800\uc7a5\ub41c Context \uac00 \uc5c6\uae30 \ub54c\ubb38\uc5d0 ",(0,i.jsx)(e.code,{children:"startTransaction"})," \ud568\uc218\uc5d0\uc11c \uc0c8\ub85c \ub9cc\ub4ed\ub2c8\ub2e4."]}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-java",children:"// JpaTransactionManager.java\nif (!txObject.hasEntityManagerHolder() || txObject.getEntityManagerHolder().isSynchronizedWithTransaction()) {\n  EntityManager newEm = createEntityManagerForTransaction();\n  txObject.setEntityManagerHolder(new EntityManagerHolder(newEm), true);\n}\nEntityManager em = txObject.getEntityManagerHolder().getEntityManager();\nTransactionSynchronizationManager.bindResource(obtainEntityManagerFactory(), txObject.getEntityManagerHolder());\n\nConnectionHandle conHandle = getJpaDialect().getJdbcConnection(em, definition.isReadOnly());\nConnectionHolder conHolder = new ConnectionHolder(conHandle);\nTransactionSynchronizationManager.bindResource(getDataSource(), conHolder);\ntxObject.setConnectionHolder(conHolder);\n"})}),"\n",(0,i.jsxs)(e.p,{children:["EntityManager \ub97c \uc0c8\ub85c \ub9cc\ub4e4\uace0, JdbcConnection \uc744 ",(0,i.jsx)(e.code,{children:"TransactionSynchronizationManager"})," \uc744 \ud1b5\ud574 ThreadLocal \uc5d0 \uc800\uc7a5\ud569\ub2c8\ub2e4."]}),"\n",(0,i.jsx)(e.h2,{id:"context-\ub85c-\ub370\uc774\ud130\uc5d0-\uc811\uadfc\ud558\uae30",children:"Context \ub85c \ub370\uc774\ud130\uc5d0 \uc811\uadfc\ud558\uae30"}),"\n",(0,i.jsxs)(e.p,{children:["Context \ub97c \uac00\uc838\uc640\uc11c Callback \ud568\uc218\ub97c \ucc98\ub9ac\ud558\ub294\ub370 \ubcf4\ud1b5 Repository \ub85c \ub370\uc774\ud130\ub97c \uac00\uc838\uc624\uace0 \uc501\ub2c8\ub2e4. ",(0,i.jsx)(e.code,{children:"Repository.findById"})," \ud568\uc218\ub97c \ud638\ucd9c\ud558\uba74 Proxy \uac1d\uccb4\ub97c \ud1b5\ud574 ",(0,i.jsx)(e.code,{children:"TransactionAspectSupport.invokeWithinTransaction"})," \ub97c \ud638\ucd9c\ud569\ub2c8\ub2e4. \ud568\uc218\uba85\uc5d0\uc11c \uc720\ucd94\ud560 \uc218 \uc788\ub4ef\uc774 \uc2dc\uc791\ud55c Transaction Context \ub97c \ubd88\ub7ec\uc640\uc11c \ub370\uc774\ud130\uc5d0 \uc811\uadfc\ud569\ub2c8\ub2e4."]}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-java",children:"protected Object invokeWithinTransaction(Method method, @Nullable Class<?> targetClass, final InvocationCallback invocation) throws Throwable {\n  TransactionAttribute txAttr = (tas != null ? tas.getTransactionAttribute(method, targetClass) : null);\n  TransactionManager tm = determineTransactionManager(txAttr);\n\n  if (txAttr == null || !(ptm instanceof CallbackPreferringPlatformTransactionManager cpptm)) {\n    TransactionInfo txInfo = createTransactionIfNecessary(ptm, txAttr, joinpointIdentification);\n\n    try {\n      retVal = invocation.proceedWithInvocation();\n    } finally {\n      cleanupTransactionInfo(txInfo);\n    }\n    commitTransactionAfterReturning(txInfo);\n    return retVal;\n  }\n}\n"})}),"\n",(0,i.jsxs)(e.p,{children:[(0,i.jsx)(e.code,{children:"createTransactionIfNecessary"})," \uc5d0\uc11c\ub294 ",(0,i.jsx)(e.code,{children:"TransactionManager.getTransaction"})," \ub97c \ud638\ucd9c\ud558\uc5ec TransactionTemplate \ub3d9\uc791\uacfc \ube44\uc2b7\ud558\uac8c \uc774\ubbf8 \uc815\uc758\ud55c EntityManager, Connection \ub97c \uc774\uc6a9\ud574\uc11c \ub370\uc774\ud130\uc5d0 \uc811\uadfc\ud569\ub2c8\ub2e4. \ub370\uc774\ud130 \uc811\uadfc \uc774\ud6c4\uc5d0\ub294 ",(0,i.jsx)(e.code,{children:"commitTransactionAfterReturning"})," \uc744 \ud1b5\ud574 Transaction \uc0c1\ud0dc\uc5d0 \ub530\ub77c commit \uc744 \uc9c4\ud589\ud569\ub2c8\ub2e4."]}),"\n",(0,i.jsxs)(e.p,{children:["Transaction \uc5c6\uc774 ",(0,i.jsx)(e.code,{children:"Repository.findById"})," \ud568\uc218\ub97c \ud638\ucd9c\ud558\uba74 \uc870\uae08 \ub2e4\ub974\uac8c \ub3d9\uc791\ud569\ub2c8\ub2e4. ",(0,i.jsx)(e.code,{children:"createTransactionIfNecessary"})," \ub0b4\ubd80\uc5d0\uc11c Transaction Context \ub97c \uac00\uc838\uc624\uc9c0 \ubabb\ud569\ub2c8\ub2e4. Query \uc2e4\ud589 \ub0b4\ubd80\ub97c \ub530\ub77c\uac00\ub2e4\ubcf4\uba74 ",(0,i.jsx)(e.code,{children:"SharedEntityManagerCreator"})," proxy \uac1d\uccb4\uc5d0\uc11c EntityManager \uc9c1\uc811 \ub9cc\ub4dc\ub294 \uac78 \ucc3e\uc744 \uc218 \uc788\uc2b5\ub2c8\ub2e4."]}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-java",children:"public abstract class SharedEntityManagerCreator {\n  private static class SharedEntityManagerInvocationHandler implements InvocationHandler, Serializable {\n    public Object invoke(Object proxy, Method method, Object[] args) throws Throwable {\n      EntityManager target = EntityManagerFactoryUtils.doGetTransactionalEntityManager(this.targetFactory, this.properties, this.synchronizedWithTransaction);\n      // ...\n      if (target == null) {\n        target = this.targetFactory.createEntityManager();\n        isNewEm = true;\n      }\n    }\n  }\n}\n\npublic abstract class EntityManagerFactoryUtils {\n  public static EntityManager doGetTransactionalEntityManager(EntityManagerFactory emf, @Nullable Map<?, ?> properties, boolean synchronizedWithTransaction) throws PersistenceException {\n    EntityManagerHolder emHolder = (EntityManagerHolder) TransactionSynchronizationManager.getResource(emf);\n    if (emHolder != null) {\n      return emHolder.getEntityManager();\n    }\n    if (!TransactionSynchronizationManager.isSynchronizationActive()) {\n      return null;\n    }\n    if (em == null) {\n      em = (!CollectionUtils.isEmpty(properties) ? emf.createEntityManager(properties) : emf.createEntityManager());\n    }\n    TransactionSynchronizationManager.bindResource(emf, emHolder);\n  }\n}\n"})}),"\n",(0,i.jsxs)(e.p,{children:[(0,i.jsx)(e.code,{children:"TransactionSynchronizationManager.isSynchronizationActive"})," \ub97c \ud1b5\ud574\uc11c \ub9cc\ub4e0 EntityManager \ub97c ThreadLocal \uc5d0 \uc800\uc7a5\ud560\uc9c0 \ub9d0\uc9c0 \ud310\ub2e8\ud569\ub2c8\ub2e4. Transaction \uc774 \uc5c6\ub294 \uacbd\uc6b0\ub294 ",(0,i.jsx)(e.code,{children:"TransactionSynchronizationManager"})," \uc5d0 \uc800\uc7a5\ub41c Synchronization \uc774 \uc5c6\uc744\ud14c\ub2c8 \ub9ac\uc18c\uc2a4\ub97c \uc800\uc7a5\ud558\uc9c0 \uc54a\uace0 \ubc14\ub85c \ud574\uc81c\ud569\ub2c8\ub2e4."]}),"\n",(0,i.jsxs)(e.p,{children:["\ucc38\uace0) ",(0,i.jsx)(e.a,{href:"https://jaeseo.tistory.com/entry/SimpleJpaRepository%EC%9D%98-EntityManager%EB%8A%94-%EC%96%B4%EB%94%94%EC%84%9C-%EC%83%9D%EC%84%B1%EB%90%A0%EA%B9%8C",children:"[JPA] SimpleJpaRepository\uc758 EntityManager\ub294 \uc5b4\ub514\uc11c \uc0dd\uc131\ub420\uae4c?"})]}),"\n",(0,i.jsx)(e.h2,{id:"commit-\uacfc-\ub9ac\uc18c\uc2a4-\uc815\ub9ac",children:"Commit \uacfc \ub9ac\uc18c\uc2a4 \uc815\ub9ac"}),"\n",(0,i.jsxs)(e.p,{children:[(0,i.jsx)(e.code,{children:"TransactionManager.commit"})," \uc5d0\uc11c\ub294 commit, doAfterCommit, Context \uc815\ub9ac\ud558\ub294 \uacfc\uc815\uc744 \uac70\uce69\ub2c8\ub2e4."]}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-java",children:"if (status.isNewSynchronization()) {\n  for (TransactionSynchronization synchronization : TransactionSynchronizationManager.getSynchronizations()) {\n    TransactionSynchronizationManager.unbindResource(synchronization);\n  }\n}\n\nif (status.isNewTransaction()) {\n  doCommit(status); // Actual database commit\n}\ntriggerAfterCommit(status);\ncleanupAfterCompletion(status);\n"})}),"\n",(0,i.jsxs)(e.p,{children:["\uc774\uc804 \uc139\uc158\uc5d0\uc11c \uc5b8\uae09\ud588\ub4ef\uc774, TransactionTemplate \uc744 \uc2dc\uc791\ud560 \ub54c\uc640 Repository \uc811\uadfc\uc5d0\uc11c commit \ud568\uc218\ub97c \ubd80\ub985\ub2c8\ub2e4. \uadf8\ub54c \ubaa8\ub4e0 Transaction \uc5d0\uc11c \ub370\uc774\ud130\ubca0\uc774\uc2a4 commit \uc744 \ubd80\ub974\ub294 \uac74 \uc544\ub2c8\uace0 ",(0,i.jsx)(e.code,{children:"isNewTransaction"})," \uc744 \ud1b5\ud574\uc11c \ucd5c\uc0c1\uc704 Transaction \uc5d0\uc11c\ub9cc commit \uc744 \ud638\ucd9c\ud569\ub2c8\ub2e4."]}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-java",children:"private void cleanupAfterCompletion(DefaultTransactionStatus status) {\n  if (status.isNewSynchronization()) {\n    TransactionSynchronizationManager.clear();\n  }\n  if (status.isNewTransaction()) {\n    JpaTransactionObject txObject = status.getTransaction();\n    txObject.getEntityManagerHolder().clear();\n    // ...\n  }\n}\n"})}),"\n",(0,i.jsxs)(e.p,{children:["Context \ub97c \uc815\ub9ac\ud558\ub294 \uacfc\uc815\uc5d0\uc11c\ub294 ",(0,i.jsx)(e.code,{children:"TransactionSynchronizationManager"})," \ub97c \ud1b5\ud574\uc11c ThreadLocal\uc5d0 \uc800\uc7a5\ub418\uc5b4\uc788\ub294 \ub9ac\uc18c\uc2a4\ub4e4\uc744 \uc815\ub9ac\ud569\ub2c8\ub2e4."]}),"\n",(0,i.jsx)(e.h2,{id:"\uc608\uc2dc",children:"\uc608\uc2dc"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-kotlin",children:'transactionTemplate\n  .also { it.isolationLevel = IsolationLevel.SERIALIZABLE }\n  .execute { // 1\n    val driver = driverRepository.findByIdOrNull("DVC40729") // 2\n  }\n'})}),"\n",(0,i.jsxs)(e.ol,{children:["\n",(0,i.jsxs)(e.li,{children:["TransactionTemplate \uc758 \uc2dc\uc791\uc73c\ub85c ",(0,i.jsx)(e.code,{children:"TransactionSynchronizationManager"})," \uc5d0 \uc815\uc758\ub41c EntityManager \uac00 \uc5c6\uae30 \ub54c\ubb38\uc5d0 ",(0,i.jsx)(e.code,{children:"TransactionManager.startTransaction"})," \ub97c \ud1b5\ud574 EntityManager \ub97c \ub9cc\ub4e4\uace0 JdbcConnection \uc744 \ub9fa\uc2b5\ub2c8\ub2e4. \ub9cc\ub4e0 \uac1d\uccb4\ub294 ",(0,i.jsx)(e.code,{children:"TransactionSynchronizationManager"})," \ub97c \ud1b5\ud574 ThreadLocal \uc5d0 \uc800\uc7a5\ud569\ub2c8\ub2e4."]}),"\n",(0,i.jsxs)(e.li,{children:["Repository \ud568\uc218\ub294 Proxy \uac1d\uccb4\ub85c \ub9cc\ub4e4\uc5b4\uc838 \uc788\uc5b4 \ub0b4\ubd80\uc5d0\uc11c ",(0,i.jsx)(e.code,{children:"TransactionAspectSupport.invokeWithinTransaction"})," \ub97c \ud638\ucd9c\ud558\uace0 ",(0,i.jsx)(e.code,{children:"TransactionSynchronizationManager"})," \ub97c \ud1b5\ud574 ThreadLocal \uc5d0 \uc800\uc7a5\ub41c EntityManager \ub97c \uac00\uc838\uc640 \ub370\uc774\ud130\uc5d0 \uc811\uadfc\ud569\ub2c8\ub2e4."]}),"\n"]}),"\n",(0,i.jsx)(e.hr,{}),"\n",(0,i.jsx)(e.h1,{id:"\ucd5c\uadfc\uc5d0-\ub9c8\uc8fc\ud55c-\ubb38\uc81c\ub4e4-\ud574\uacb0\ud558\uae30",children:"\ucd5c\uadfc\uc5d0 \ub9c8\uc8fc\ud55c \ubb38\uc81c\ub4e4 \ud574\uacb0\ud558\uae30"}),"\n",(0,i.jsx)(e.p,{children:"TransactionTemplate \uacfc Repository \ub3d9\uc791\uc744 \uc774\ud574\ud588\uc73c\ub2c8 \ucc98\uc74c\uc5d0 \uc5b8\uae09\ud55c \ubb38\uc81c\ub4e4\uc744 \ucc28\ub840\ub300\ub85c \ubd84\uc11d\ud574\ubcf4\uaca0\uc2b5\ub2c8\ub2e4."}),"\n",(0,i.jsx)(e.h2,{id:"\uccab\ubc88\uc9f8-\ubb38\uc81c-add-column-to-vehicle-table-ddl-1",children:"\uccab\ubc88\uc9f8 \ubb38\uc81c, add column to vehicle table DDL"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-kotlin",children:'class TestController(\n  private val transactionTemplate: TransactionTemplate,\n  @Qualifier("trackerDB") private val trackerTransactionTemplate: TransactionTemplate,\n) {\n  private fun transactionInTrackerTransaction() {\n    trackerTransactionTemplate\n      .also { it.isolationLevel = IsolationLevel.SERIALIZABLE }\n      .execute { // 1\n        val trackerRide = trackerRepository.findById("...") // 2\n\n        val acceptedRide = rideRepository.findById("...") // 3\n\n        transactionTemplate\n          .execute { // 4\n            driverRepository.findById("...")\n            vehicleRepository.findById("...")\n          }\n      } // 5\n  }\n}\n'})}),"\n",(0,i.jsxs)(e.ol,{children:["\n",(0,i.jsxs)(e.li,{children:["\n",(0,i.jsxs)(e.p,{children:[(0,i.jsx)(e.code,{children:"TrackerDatabaseConfiguration"})," \uc5d0\uc11c \uc8fc\uc785\ud55c TransactionManager \ub97c \ud1b5\ud574 \uc0c8\ub85c\uc6b4 Transaction \uc744 \uc2dc\uc791\ud569\ub2c8\ub2e4. ",(0,i.jsx)(e.code,{children:"TransactionSynchronizationManager"})," \uc5d0 \uc815\uc758\ud55c EntityManager \uac00 \uc5c6\uc73c\ub2c8 \uc0c8\ub85c \ub9cc\ub4ed\ub2c8\ub2e4."]}),"\n"]}),"\n",(0,i.jsxs)(e.li,{children:["\n",(0,i.jsxs)(e.p,{children:[(0,i.jsx)(e.code,{children:"trackerRepository.findById"})," \ub294 ",(0,i.jsx)(e.code,{children:"TransactionAspectSupport.invokeWithinTransaction"})," \ub97c \ud638\ucd9c\ud558\uace0 1 \uc5d0\uc11c \uc815\uc758\ud55c EntityManager \ub97c \ud65c\uc6a9\ud574 \ub370\uc774\ud130\ub97c \uac00\uc838\uc635\ub2c8\ub2e4."]}),"\n"]}),"\n",(0,i.jsxs)(e.li,{children:["\n",(0,i.jsxs)(e.p,{children:[(0,i.jsx)(e.code,{children:"rideRepository.findById"})," \ub3c4 ",(0,i.jsx)(e.code,{children:"TransactionAspectSupport.invokeWithinTransaction"})," \ub97c \ud638\ucd9c\ud558\uc9c0\ub9cc, ",(0,i.jsx)(e.code,{children:"PrimaryDatabaseConfiguration"})," \uc758 EntityManagerFactory \ub97c \uc0ac\uc6a9\ud558\ubbc0\ub85c \uc0c8\ub85c\uc6b4 EntityManager \ub97c \ub9cc\ub4ed\ub2c8\ub2e4."]}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"\uc774\uc804\uc5d0 \uc5b8\uae09\ud588\ub4ef\uc774, Transaction \uc774 \uc5c6\ub294 Repository \uc811\uadfc\uc740 EntityManager \ub97c \uc0c8\ub85c \ub9cc\ub4e4\uc5b4 \uc811\uadfc \ud6c4 \ubc14\ub85c \ud574\uc81c\ud569\ub2c8\ub2e4."}),"\n",(0,i.jsxs)(e.li,{children:["\uadf8\ub7f0\ub370 Tracker Transaction \ub0b4\ubd80\uc774\uae30 \ub54c\ubb38\uc5d0 ",(0,i.jsx)(e.code,{children:"TransactionSynchronizationManager"})," \uc5d0 \uc800\uc7a5\ub41c Synchronization \uc774 \uc874\uc7ac\ud569\ub2c8\ub2e4. \uadf8\ub798\uc11c PrimaryDatabase \uc5d0 \ub300\ud55c Transaction \uc774 \uc544\ub2c8\ub354\ub77c\ub3c4 ThreadLocal \uc5d0 EntityManager \ub97c \uc800\uc7a5\ud569\ub2c8\ub2e4.","\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-java",children:"if (!TransactionSynchronizationManager.isSynchronizationActive()) {\n  return null;\n}\nif (em == null) {\n  em = (!CollectionUtils.isEmpty(properties) ? emf.createEntityManager(properties) : emf.createEntityManager());\n}\nTransactionSynchronizationManager.bindResource(emf, emHolder);\n"})}),"\n"]}),"\n",(0,i.jsxs)(e.li,{children:["\uc774\ud6c4 \ub370\uc774\ud130\ub97c \ubd88\ub7ec\uc624\uace0 \ub098\uc11c commit \ud558\uba74\uc11c \ub9ac\uc18c\uc2a4\ub97c \ud574\uc81c\ud560 \uc218 \uc788\uc9c0\ub9cc Transaction \uc774 \uc5c6\uae30 \ub54c\ubb38\uc5d0 ",(0,i.jsx)(e.code,{children:"commitTransactionAfterReturning"})," \uc5d0\uc11c commit \ub3c4 \ubd80\ub974\uc9c0 \uc54a\uc2b5\ub2c8\ub2e4.","\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-java",children:"protected Object invokeWithinTransaction(Method method, @Nullable Class<?> targetClass, final InvocationCallback invocation) throws Throwable {\n  // ...\n  try {\n    retVal = invocation.proceedWithInvocation();\n  } finally {\n    cleanupTransactionInfo(txInfo);\n  }\n  commitTransactionAfterReturning(txInfo);\n}\n"})}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(e.li,{children:["\n",(0,i.jsx)(e.p,{children:"\uc0c8\ub85c\uc6b4 PrimaryDatabase \uc758 Transaction \uc774 \uc2dc\uc791\ud569\ub2c8\ub2e4. Transaction \uc744 \uc2dc\uc791\ud560 \ub54c ThreadLocal \uc5d0 \uc800\uc7a5\ub41c, 3\ubc88\uc5d0\uc11c \ub9cc\ub4e0 EntityManager \ub97c \uc7ac\ud65c\uc6a9 \ud55c\ub2e4\uace0 \uc0dd\uac01\ud560 \uc218 \uc788\uc9c0\ub9cc \uc7ac\ud65c\uc6a9\ud558\uc9c0 \uc54a\uace0 \uc0c8\ub85c \ub9cc\ub4ed\ub2c8\ub2e4."}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsxs)(e.li,{children:["\n",(0,i.jsx)(e.p,{children:"\uc5ec\uae30\uc11c\ub294 \uc774\uc804\uc5d0 \uc5b8\uae09\ud558\uc9c0 \uc54a\uc740 suspend / resume \uc5d0 \ub300\ud574\uc11c \uc54c\uc544\uc57c\ud569\ub2c8\ub2e4."}),"\n"]}),"\n",(0,i.jsxs)(e.li,{children:["\n",(0,i.jsxs)(e.p,{children:["\uc0c8\ub85c\uc6b4 Transaction \uc744 \ub9cc\ub4e4 \ub54c \uac19\uc740 EntityManager \ub97c \uc811\uadfc\ud558\uac8c \ub418\uba74 \uc758\ub3c4\uce58 \uc54a\uc740 \uac1d\uccb4 \ubcc0\uacbd/flush \ub97c \uc720\ubc1c\ud560 \uc218 \uc788\uc2b5\ub2c8\ub2e4. \uc774\ubbf8 \uc9c4\ud589\uc911\uc778 EntityManager \ub294 suspend \ud568\uc218\ub97c \ud1b5\ud574 ",(0,i.jsx)(e.code,{children:"TransactionSynchronizationManager"})," \uc5d0\uc11c \uc81c\uac70 \ud6c4 \ud574\ub2f9 TransactionObject \uc5d0 \uc800\uc7a5\ud569\ub2c8\ub2e4. \uc0c8\ub86d\uac8c \uc5f4\ub9ac\ub294 Transaction \uc5d0\uc11c\ub294 \uc0c8\ub85c\uc6b4 EntityManager \ub97c \ub9cc\ub4e4\uace0 \ub370\uc774\ud130\ub97c \uc811\uadfc\ud569\ub2c8\ub2e4. 3\ubc88\uc5d0\uc11c \ub9cc\ub4e0 Context \ub97c suspend \ud569\ub2c8\ub2e4."]}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-java",children:"// \ucc38\uace0 [What does suspending a transaction mean?](https://stackoverflow.com/questions/33729810/what-does-suspending-a-transaction-mean)\npublic final TransactionStatus getTransaction(TransactionDefinition definition) {\n  Object transaction = doGetTransaction();\n  if (isExistingTransaction(transaction)) {\n    return handleExistingTransaction(definition, transaction, debugEnabled);\n  }\n  SuspendedResourcesHolder suspendedResources = suspend(null);\n  return startTransaction(definition, transaction, debugEnabled, suspendedResources);\n}\n\nprivate TransactionStatus handleExistingTransaction(TransactionDefinition definition, Object transaction, boolean debugEnabled) throws TransactionException {\n  // ...\n  if (definition.getPropagationBehavior() == TransactionDefinition.PROPAGATION_REQUIRES_NEW) {\n    SuspendedResourcesHolder suspendedResources = suspend(transaction);\n    try {\n      return startTransaction(definition, transaction, debugEnabled, suspendedResources);\n    }\n  }\n}\n"})}),"\n"]}),"\n",(0,i.jsxs)(e.li,{children:["\n",(0,i.jsx)(e.p,{children:"\uc0c8\ub85c\uc6b4 Transaction \uc774 \ub05d\ub0a0 \ub54c commit \uc744 \ud638\ucd9c\ud558\uace0 \ub9ac\uc18c\uc2a4\ub97c \uc815\ub9ac\ud558\ub294 \uacfc\uc815\uc5d0\uc11c resume \ud568\uc218\ub97c \ud638\ucd9c\ud558\uace0 \uc774\uc804 suspend \ud588\uc5c8\ub358 Context \ub97c \ubcf5\uad6c\ud569\ub2c8\ub2e4. \uc5ec\uae30\uc11c 3\ubc88\uc5d0\uc11c \ub9cc\ub4e0 EntityManager \ub97c \ub2e4\uc2dc ThreadLocal \uc5d0 \uc800\uc7a5\ud569\ub2c8\ub2e4."}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-java",children:"private void cleanupAfterCompletion(DefaultTransactionStatus status) {\n  // ...\n  if (status.getSuspendedResources() != null) {\n    resume(transaction, (SuspendedResourcesHolder) status.getSuspendedResources());\n  }\n}\n"})}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(e.li,{children:["\n",(0,i.jsxs)(e.p,{children:["trackerTransactionTemplate \ub97c commit \ud558\uba74\uc11c \uae30\uc874 ",(0,i.jsx)(e.code,{children:"TransactionSynchronizationManager"})," \uc5d0 \uc788\ub358 resource \ub4e4\uc744 \ubaa8\ub450 \uc815\ub9ac\ud55c\ub2e4. \uc774\ub54c 3\ubc88\uc5d0\uc11c \uc815\uc758\ud55c Context \uae4c\uc9c0 \uac19\uc774 \uc815\ub9ac\ud558\uba74\uc11c ride \ud14c\uc774\ube14\uc758 metadata lock \uc774 \ud574\uc81c\ub429\ub2c8\ub2e4."]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(e.h2,{id:"\ub450\ubc88\uc9f8-\ubb38\uc81c-readreplica-transaction-in-serializable-transaction-1",children:"\ub450\ubc88\uc9f8 \ubb38\uc81c, ReadReplica Transaction in Serializable Transaction"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-kotlin",children:'@RestController\nclass TestController(\n  private val transactionTemplate: TransactionTemplate,\n) {\n  @Transactional(isolation = Isolation.SERIALIZABLE)\n  private fun readReplicaInSerializable() {\n    // \uc778\uc99d \ud1a0\ud070 \ud655\uc778\uc740 \uc544\ub798\uc640 \uac19\uc774 \uc720\uc800 \uc815\ubcf4\uc5d0 \uc811\uadfc\ud55c\ub2e4.\n    transactionTemplate\n      .also { it.isReadReplicaEnabled = true }\n      .execute { // 1\n        userRepository.findById("...") // 2\n      }\n    val ride = rideRepository.findById("...")\n    // update something\n    rideRepository.save(ride) // 3\n  }\n}\n'})}),"\n",(0,i.jsxs)(e.ol,{children:["\n",(0,i.jsxs)(e.li,{children:["\n",(0,i.jsxs)(e.p,{children:[(0,i.jsx)(e.code,{children:"@Transactional"})," \uc5b4\ub178\ud14c\uc774\uc158\uc774 AOP\ub97c \ud1b5\ud574 \uba54\uc11c\ub4dc \uc2e4\ud589 \uc804\uc5d0 Transaction Context \ub97c \uc0c8\ub85c \ub9cc\ub4ed\ub2c8\ub2e4."]}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsxs)(e.li,{children:["\n",(0,i.jsxs)(e.p,{children:[(0,i.jsx)(e.code,{children:"JpaTransactionManager"})," \uc5d0\uc11c JdbcConnection \uc744 \uc811\uadfc\ud558\uba74\uc11c database \uc640 \uc2e4\uc81c database connection \uc744 \ub9fa\ub294\ub2e4."]}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-java",children:"ConnectionHandle conHandle = getJpaDialect().getJdbcConnection(em, definition.isReadOnly());\nif (conHandle != null) {\n  ConnectionHolder conHolder = new ConnectionHolder(conHandle);\n  TransactionSynchronizationManager.bindResource(getDataSource(), conHolder);\n  txObject.setConnectionHolder(conHolder);\n}\n"})}),"\n"]}),"\n",(0,i.jsxs)(e.li,{children:["\n",(0,i.jsxs)(e.p,{children:["\uadfc\ub370 \uc5ec\uae30\uc11c \uc8fc\uc758\ud560 \uc810\uc740, \ud604\uc7ac \ud0c0\ub2e4 \ud504\ub85c\uc81d\ud2b8\uc5d0\uc11c\ub294 ",(0,i.jsx)(e.code,{children:"LazyConnectionDataSourceProxy"})," \ub97c \uc0ac\uc6a9\ud558\uace0 \uc788\uc2b5\ub2c8\ub2e4. ",(0,i.jsx)(e.code,{children:"LazyConnectionDataSourceProxy"})," \ub294 Connection \uac1d\uccb4\ub97c \ub9cc\ub4e4\ub54c \uc2e4\uc81c\ub85c database \uc5d0 \uc5f0\uacb0\ud558\uc9c0 \uc54a\uace0 proxy \uac1d\uccb4\ub9cc \ub9cc\ub4ed\ub2c8\ub2e4. \uadf8\ub9ac\uace0 \ub370\uc774\ud130\uc5d0 \uc811\uadfc\ud560 \ub54c connection \uc744 \ub9fa\uc2b5\ub2c8\ub2e4."]}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-kotlin",children:'class PrimaryDatabaseConfiguration() {\n  @Bean\n  fun mainDataSource(): DataSource {\n    return ReadReplicaAwareDataSourceFactory(dataSource = /* master db */, replicaDataSource = /* replica db */).createInstance()\n  }\n}\n\n// LazyConnectionDataSourceProxy \uc744 \uc0ac\uc6a9\nclass ReadReplicaAwareDataSourceFactory(private val dataSource: DataSource, private val replicaDataSource: DataSource,) : DataSourceFactory {\n  override fun createInstance(): DataSource {\n    val readOnlyRoutingDataSource = ReadOnlyRoutingDataSource()\n    readOnlyRoutingDataSource.setTargetDataSources(replicaMap) // replicaMap is ["slave": replicaDataSource]\n    readOnlyRoutingDataSource.setDefaultTargetDataSource(dataSource)\n    return LazyConnectionDataSourceProxy(readOnlyRoutingDataSource)\n  }\n}\n'})}),"\n"]}),"\n",(0,i.jsxs)(e.li,{children:["\n",(0,i.jsxs)(e.p,{children:[(0,i.jsx)(e.code,{children:"LazyConnectionDataSourceProxy"})," \ub294 connection \uc744 \ud55c\ubc88 \ub9cc\ub4e0 \ub2e4\uc74c \uce90\uc2f1\ud574\ub193\uc2b5\ub2c8\ub2e4."]}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-java",children:"// LazyConnectionDataSourceProxy.java\nprivate Connection getTargetConnection(Method operation) throws SQLException {\n  if (this.target == null) {\n    // ...\n    this.target = (this.username != null) ? obtainTargetDataSource().getConnection(this.username, this.password) : obtainTargetDataSource().getConnection();\n    // ...\n  }\n}\n"})}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(e.li,{children:["\n",(0,i.jsxs)(e.p,{children:["\ub0b4\ubd80 transactionTemplate\uc73c\ub85c \uc0c8\ub85c\uc6b4 \ud2b8\ub79c\uc7ad\uc158\uc744 \uc2dc\uc791\ud558\uba70 \ucc98\uc74c \ub370\uc774\ud130\uc5d0 \uc811\uadfc\ud569\ub2c8\ub2e4. \uc774\ub54c isReadReplicaEnabled \uc635\uc158\uc774 true\ub85c \uc124\uc815\ub418\uc5b4 \uc788\uc73c\ub2c8\n",(0,i.jsx)(e.code,{children:"determineCurrentLookupKey"})," \ud568\uc218\ub97c \ud1b5\ud574 ReadReplica database \ub85c \uc5f0\uacb0\uc744 \ub9fa\uc2b5\ub2c8\ub2e4."]}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-kotlin",children:'class ReadOnlyRoutingDataSource : AbstractRoutingDataSource() {\n  // defaultTargetDataSource is "master" database.\n  private var dataSourceKeys: List<Any>? = null // "slave"\n\n  override fun determineCurrentLookupKey(): Any? {\n    return if (isReadReplicaEnabled && dataSourceKeys!!.isNotEmpty()) {\n      val randomDataSourceKey = dataSourceKeys!![getRandom(this.dataSourceKeys!!.size)]\n      return randomDataSourceKey\n    } else null\n  }\n}\n'})}),"\n"]}),"\n",(0,i.jsxs)(e.li,{children:["\n",(0,i.jsx)(e.p,{children:"\uc774\ud6c4 ReadReplica \ub370\uc774\ud130\ubca0\uc774\uc2a4\uc5d0 update \uba85\ub839\uc5b4\ub97c \uc694\uccad\ud558\ub2c8, read only \uc635\uc158\uc5d0\uc11c \uc218\ud589\ud560 \uc218 \uc5c6\ub2e4\uace0 \uc5d0\ub7ec\uac00 \ubc1c\uc0dd\ud569\ub2c8\ub2e4."}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(e.hr,{}),"\n",(0,i.jsx)(e.h1,{id:"\uc815\ub9ac",children:"\uc815\ub9ac"}),"\n",(0,i.jsxs)(e.p,{children:["\uc774\ubc88 \ubb38\uc81c\ub4e4\uc744 \ud1b5\ud574 Spring\uc758 Transaction \uad00\ub9ac\uac00 \ub2e8\uc21c\ud788 ",(0,i.jsx)(e.code,{children:"@Transactional"})," \uc5b4\ub178\ud14c\uc774\uc158\uc774\ub098 ",(0,i.jsx)(e.code,{children:"TransactionTemplate"}),"\uc744 \uc0ac\uc6a9\ud558\ub294 \uac83 \uc774\uc0c1\uc758 \ubcf5\uc7a1\ud55c \uba54\ucee4\ub2c8\uc998\uc73c\ub85c \ub3d9\uc791\ud55c\ub2e4\ub294 \uac83\uc744 \uae4a\uc774 \uc774\ud574\ud558\uac8c \ub418\uc5c8\uc2b5\ub2c8\ub2e4.\nTransaction \ucee8\ud14d\uc2a4\ud2b8\uac00 ThreadLocal\uc5d0 \uc800\uc7a5\ub418\uace0 ",(0,i.jsx)(e.code,{children:"TransactionSynchronizationManager"}),"\ub97c \ud1b5\ud574 \uad00\ub9ac\ub41c\ub2e4\ub294 \uc810, \uadf8\ub9ac\uace0 \uc5ec\ub7ec \ub370\uc774\ud130\ubca0\uc774\uc2a4\ub97c \uc0ac\uc6a9\ud560 \ub54c\ub294 \uac01 EntityManagerFactory\ubcc4\ub85c \ub3c5\ub9bd\uc801\uc73c\ub85c \uad00\ub9ac\ub41c\ub2e4\ub294 \uac83\uc744 \uc54c\uac8c \ub418\uc5c8\uc2b5\ub2c8\ub2e4.\n\ub610\ud55c ",(0,i.jsx)(e.code,{children:"LazyConnectionDataSourceProxy"}),"\ub97c \uc0ac\uc6a9\ud560 \ub54c\ub294 Connection\uc774 \ud55c \ubc88 \uc0dd\uc131\ub418\uba74 \uce90\uc2f1\ub418\ubbc0\ub85c, Transaction \ucd08\uae30\uac00 \uc544\ub2cc \uccab \ub370\uc774\ud130 \uc811\uadfc \uc2dc\uc810\uc758 \uc124\uc815\uc774 \uc804\uccb4 Transaction\uc5d0 \uc601\ud5a5\uc744 \ubbf8\uce5c\ub2e4\ub294 \uac83\ub3c4 \uc54c\uac8c \ub410\uc2b5\ub2c8\ub2e4.\n\uc5ec\ub7ec \ub370\uc774\ud130\ubca0\uc774\uc2a4\ub97c \uc0ac\uc6a9\ud558\uac70\ub098 ReadReplica\ub97c \ud65c\uc6a9\ud558\ub294 \ubcf5\uc7a1\ud55c \ud658\uacbd\uc5d0\uc11c \uad00\ub828\ub41c \uc774\ud574\uac00 \ub9ce\uc740 \ub3c4\uc6c0\uc774 \ub418\uc5c8\uc2b5\ub2c8\ub2e4."]})]})}function h(n={}){const{wrapper:e}={...(0,r.R)(),...n.components};return e?(0,i.jsx)(e,{...n,children:(0,i.jsx)(d,{...n})}):d(n)}},28453:(n,e,a)=>{a.d(e,{R:()=>o,x:()=>c});var t=a(96540);const i={},r=t.createContext(i);function o(n){const e=t.useContext(r);return t.useMemo(function(){return"function"==typeof n?n(e):{...e,...n}},[e,n])}function c(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(i):n.components||i:o(n.components),t.createElement(r.Provider,{value:e},n.children)}},92444:n=>{n.exports=JSON.parse('{"permalink":"/blog/2025/08/17/spring-transaction-template-understanding","source":"@site/blog/2025-08-17-spring-transaction-template-understanding/index.md","title":"Spring JPA TransactionTemplate Internals","description":"\ud68c\uc0ac\uc5d0\uc11c \ud504\ub860\ud2b8 \uac1c\ubc1c\uc744 \ud558\ub2e4\uac00 \uc11c\ubc84 \uac1c\ubc1c\uc744 \uc81c\ub300\ub85c \uc2dc\uc791\ud55c\uc9c0 1\ub144 \ubc18 \uc815\ub3c4 \uc9c0\ub0ac\uc2b5\ub2c8\ub2e4.","date":"2025-08-17T00:00:00.000Z","tags":[{"inline":true,"label":"spring","permalink":"/blog/tags/spring"},{"inline":true,"label":"jpa","permalink":"/blog/tags/jpa"},{"inline":true,"label":"transaction","permalink":"/blog/tags/transaction"}],"readingTime":9.29,"hasTruncateMarker":false,"authors":[],"frontMatter":{"title":"Spring JPA TransactionTemplate Internals","tags":["spring","jpa","transaction"]},"unlisted":false,"nextItem":{"title":"Auto Lotto Bot","permalink":"/blog/2024/06/22/lotto-bot"}}')}}]);