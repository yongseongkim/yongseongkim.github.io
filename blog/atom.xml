<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
    <id>https://yongseongkim.github.io/blog/</id>
    <title>yongseongkim's blog Blog</title>
    <updated>2025-08-17T00:00:00.000Z</updated>
    <generator>https://github.com/jpmonette/feed</generator>
    <link rel="alternate" href="https://yongseongkim.github.io/blog/"/>
    <subtitle>yongseongkim's blog Blog</subtitle>
    <icon>https://yongseongkim.github.io/img/favicon.ico</icon>
    <entry>
        <title type="html"><![CDATA[Spring JPA TransactionTemplate Internals]]></title>
        <id>https://yongseongkim.github.io/blog/2025/08/17/spring-transaction-template-understanding/</id>
        <link href="https://yongseongkim.github.io/blog/2025/08/17/spring-transaction-template-understanding/"/>
        <updated>2025-08-17T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[회사에서 프론트 개발을 하다가 서버 개발을 제대로 시작한지 1년 반 정도 지났습니다.]]></summary>
        <content type="html"><![CDATA[<p>회사에서 프론트 개발을 하다가 서버 개발을 제대로 시작한지 1년 반 정도 지났습니다.
Spring 관련 인터넷 강의, 공식 문서 외에는 따로 공부하고 있지 않았는데 회사에서 겪은 문제를 기반으로 Spring JPA 내부 코드를 파악했던 경험을 기록해두려고 합니다.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="첫번째-문제-add-column-to-vehicle-table-ddl">첫번째 문제, add column to vehicle table DDL<a href="https://yongseongkim.github.io/blog/2025/08/17/spring-transaction-template-understanding/#%EC%B2%AB%EB%B2%88%EC%A7%B8-%EB%AC%B8%EC%A0%9C-add-column-to-vehicle-table-ddl" class="hash-link" aria-label="Direct link to 첫번째 문제, add column to vehicle table DDL" title="Direct link to 첫번째 문제, add column to vehicle table DDL">​</a></h2>
<p>최근에 <a href="https://www.tadatada.com/" target="_blank" rel="noopener noreferrer">타다</a> 서버를 배포 하던 중에 차량 관련 테이블에 컬럼을 추가하는 DDL 과 차량 위치 추적 데이터 처리에서 deadlock 이 발생했습니다.
타다에서는 드라이버(driver), 운행차량(vehicle), 운행(ride) 등이 foreign key 를 이용해서 참조하고 있습니다.
그리고 일반 정보를 저장하는 데이터베이스와 차량 위치를 추적하는 데이터베이스를 따로 관리하고 있습니다.</p>
<div class="language-kotlin codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-kotlin codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">TestController</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">val</span><span class="token plain"> transactionTemplate</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> TransactionTemplate</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token annotation builtin">@Qualifier</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string-literal singleline string" style="color:#e3116c">"trackerDB"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">val</span><span class="token plain"> trackerTransactionTemplate</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> TransactionTemplate</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">fun</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">transactionInTrackerTransaction</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    trackerTransactionTemplate</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">also</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> it</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">isolationLevel </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> IsolationLevel</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">SERIALIZABLE </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">execute</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">val</span><span class="token plain"> trackerRide </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> trackerRepository</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">findById</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string-literal singleline string" style="color:#e3116c">"..."</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// No explicit transaction</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">val</span><span class="token plain"> acceptedRide </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> rideRepository</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">findById</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string-literal singleline string" style="color:#e3116c">"..."</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        transactionTemplate</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">execute</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            driverRepository</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">findById</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string-literal singleline string" style="color:#e3116c">"..."</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            vehicleRepository</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">findById</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string-literal singleline string" style="color:#e3116c">"..."</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p>타다 차량의 위치를 처리하는 과정은 위 코드와 같이 차량 위치(tracker), 운행정보(ride), 드라이버(driver) 그리고 차량(vehicle) 테이블에 접근합니다.
이 과정은 많은 드라이버의 위치 정보를 처리해야 하므로 빈번하게 호출됩니다.
이러한 상황에서 vehicle 에 column 을 추가하는 DDL 을 실행하면 vehicle, vehicle 과 foreign key 로 연결된 테이블(ride, driver, ...)에 metadata lock 을 잡으려고 합니다.
DDL 이 vehicle → ride 로 metadata lock 을 획득하는 과정에서 위 코드에서는 ride → vehicle 순서로 metadata lock 을 잡으려고 하니 deadlock 상태에 빠져버렸습니다.
<code>rideRepository.findById</code> 는 데이터를 가져온 후 metadata lock 을 해제해야하는데 trackerTransactionTemplate 범위 내내 lock 을 획득한 채로 있어 deadlock 에 빠졌습니다.
위 문제는 <code>rideRepository.findById</code> 을 transactionTemplate 으로 감싸면 ride 에 대한 metadata lock 이 빠르게 해제되면서 해당 문제는 해결됩니다.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="두번째-문제-readreplica-transaction-in-serializable-transaction">두번째 문제, ReadReplica Transaction in Serializable Transaction<a href="https://yongseongkim.github.io/blog/2025/08/17/spring-transaction-template-understanding/#%EB%91%90%EB%B2%88%EC%A7%B8-%EB%AC%B8%EC%A0%9C-readreplica-transaction-in-serializable-transaction" class="hash-link" aria-label="Direct link to 두번째 문제, ReadReplica Transaction in Serializable Transaction" title="Direct link to 두번째 문제, ReadReplica Transaction in Serializable Transaction">​</a></h2>
<p>다른 기능을 배포하는 과정에서 <code>could not execute statement [The MySQL server is running with the --read-only option so it cannot execute this statement]</code> 에러가 발생했습니다.
타다에서는 읽기 부하 분산을 위해 ReadReplica 데이터베이스를 사용하며, TransactionTemplate에 <code>isReadReplicaEnabled</code>라는 커스텀 속성을 추가하여 ReadReplica로 라우팅할 수 있도록 구현했습니다.</p>
<div class="language-kotlin codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-kotlin codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token annotation builtin">@RestController</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">TestController</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">val</span><span class="token plain"> transactionTemplate</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> TransactionTemplate</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token annotation builtin">@Transactional</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">isolation </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Isolation</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">SERIALIZABLE</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">fun</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">readReplicaInSerializable</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 인증 토큰 확인은 아래와 같이 유저 정보에 접근한다.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    transactionTemplate</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">also</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> it</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">isReadReplicaEnabled </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">execute</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        userRepository</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">findById</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string-literal singleline string" style="color:#e3116c">"..."</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">val</span><span class="token plain"> ride </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> rideRepository</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">findById</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string-literal singleline string" style="color:#e3116c">"..."</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// update something</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    rideRepository</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">save</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ride</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p>대부분 API 에 토큰에 대한 검증을 하는 과정이 있습니다. 이때 마스터 데이터베이스를 보기 보다는 READ REPLICA 데이터베이스에 접근해서 부하를 분산합니다.
근데 위와 같이 코드를 작성하면 이후 데이터를 업데이트하는 <code>rideRepository.save</code> 에서 문제가 발생합니다.
외부 Transaction이 먼저 시작되었으니 마스터 데이터베이스 연결을 사용하고, 내부 transactionTemplate도 이를 재활용할 것으로 기대했지만 실제로는 다르게 동작했습니다.</p>
<p>두 문제에 대해서 정확한 원인을 파악하기 위해서는 TransactionTemplate 이 어떻게 동작하는지, TransactionTemplate 이 없을 때 Repository 로 데이터 접근할 때 어떻게 동작하는지 그리고 데이터베이스에 연결을 어떻게 맺는지 이해할 필요가 있었습니다.</p>
<h1>먼저 TransactionTemplate 동작 이해하기</h1>
<p><code>TransactionTemplate.execute</code> 는 크게 3 step 으로 나눌 수 있습니다.</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">T</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token class-name">T</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">execute</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">TransactionCallback</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">T</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"> action</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// Step 1: Transaction 에 필요한 Context 를 구성하기</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token class-name">TransactionStatus</span><span class="token plain"> status </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">transactionManager</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getTransaction</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">try</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Step 2: Context 로 데이터에 접근하기</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    result </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> action</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">doInTransaction</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">status</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">catch</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">/* rollback */</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// Step 3: Commit 과 리소스 정리</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">transactionManager</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">commit</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">status</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> result</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="transaction-에-필요한-context-를-구성하기">Transaction 에 필요한 Context 를 구성하기<a href="https://yongseongkim.github.io/blog/2025/08/17/spring-transaction-template-understanding/#transaction-%EC%97%90-%ED%95%84%EC%9A%94%ED%95%9C-context-%EB%A5%BC-%EA%B5%AC%EC%84%B1%ED%95%98%EA%B8%B0" class="hash-link" aria-label="Direct link to Transaction 에 필요한 Context 를 구성하기" title="Direct link to Transaction 에 필요한 Context 를 구성하기">​</a></h2>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">final</span><span class="token plain"> </span><span class="token class-name">TransactionStatus</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">getTransaction</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">TransactionDefinition</span><span class="token plain"> definition</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token class-name">Object</span><span class="token plain"> transaction </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">doGetTransaction</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">isExistingTransaction</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">transaction</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">handleExistingTransaction</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">definition</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> transaction</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> debugEnabled</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">startTransaction</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">definition</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> transaction</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> debugEnabled</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> suspendedResources</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p><code>AbstractPlatformTransactionManager.getTransaction</code> 에서는 이미 선언한 Transaction 이 있는지, 이미 Transaction 이 진행중이라면 Propagation 정책에 따라 새로운 Transaction 에 필요한 Context 를 만들지 정합니다.</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// JpaTransactionManager.doGetTransaction</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token class-name">EntityManagerHolder</span><span class="token plain"> emHolder </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">EntityManagerHolder</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token class-name">TransactionSynchronizationManager</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getResource</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">obtainEntityManagerFactory</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">emHolder </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  txObject</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">setEntityManagerHolder</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">emHolder</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">getDataSource</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token class-name">ConnectionHolder</span><span class="token plain"> conHolder </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">ConnectionHolder</span><span class="token punctuation" style="color:#393A34">)</span><span class="token class-name">TransactionSynchronizationManager</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getResource</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">getDataSource</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  txObject</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">setConnectionHolder</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">conHolder</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p>여기서 Context(EntityManager, Connection) 는 <code>TransactionSynchronizationManager</code> 를 통해 가져옵니다. <code>TransactionSynchronizationManager</code> 는 Resource 들을 ThreadLocal 에 저장합니다.</p>
<p>새로 시작하는 Transaction 의 경우 저장된 Context 가 없기 때문에 <code>startTransaction</code> 함수에서 새로 만듭니다.</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// JpaTransactionManager.java</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">!</span><span class="token plain">txObject</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">hasEntityManagerHolder</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">||</span><span class="token plain"> txObject</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getEntityManagerHolder</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">isSynchronizedWithTransaction</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token class-name">EntityManager</span><span class="token plain"> newEm </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">createEntityManagerForTransaction</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  txObject</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">setEntityManagerHolder</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">EntityManagerHolder</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">newEm</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token class-name">EntityManager</span><span class="token plain"> em </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> txObject</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getEntityManagerHolder</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getEntityManager</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token class-name">TransactionSynchronizationManager</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">bindResource</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">obtainEntityManagerFactory</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> txObject</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getEntityManagerHolder</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token class-name">ConnectionHandle</span><span class="token plain"> conHandle </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">getJpaDialect</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getJdbcConnection</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">em</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> definition</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">isReadOnly</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token class-name">ConnectionHolder</span><span class="token plain"> conHolder </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">ConnectionHolder</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">conHandle</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token class-name">TransactionSynchronizationManager</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">bindResource</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">getDataSource</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> conHolder</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">txObject</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">setConnectionHolder</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">conHolder</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre></div></div>
<p>EntityManager 를 새로 만들고, JdbcConnection 을 <code>TransactionSynchronizationManager</code> 을 통해 ThreadLocal 에 저장합니다.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="context-로-데이터에-접근하기">Context 로 데이터에 접근하기<a href="https://yongseongkim.github.io/blog/2025/08/17/spring-transaction-template-understanding/#context-%EB%A1%9C-%EB%8D%B0%EC%9D%B4%ED%84%B0%EC%97%90-%EC%A0%91%EA%B7%BC%ED%95%98%EA%B8%B0" class="hash-link" aria-label="Direct link to Context 로 데이터에 접근하기" title="Direct link to Context 로 데이터에 접근하기">​</a></h2>
<p>Context 를 가져와서 Callback 함수를 처리하는데 보통 Repository 로 데이터를 가져오고 씁니다. <code>Repository.findById</code> 함수를 호출하면 Proxy 객체를 통해 <code>TransactionAspectSupport.invokeWithinTransaction</code> 를 호출합니다. 함수명에서 유추할 수 있듯이 시작한 Transaction Context 를 불러와서 데이터에 접근합니다.</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">protected</span><span class="token plain"> </span><span class="token class-name">Object</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">invokeWithinTransaction</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">Method</span><span class="token plain"> method</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token annotation punctuation" style="color:#393A34">@Nullable</span><span class="token plain"> </span><span class="token class-name">Class</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics operator" style="color:#393A34">?</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"> targetClass</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">final</span><span class="token plain"> </span><span class="token class-name">InvocationCallback</span><span class="token plain"> invocation</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">throws</span><span class="token plain"> </span><span class="token class-name">Throwable</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token class-name">TransactionAttribute</span><span class="token plain"> txAttr </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">tas </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">?</span><span class="token plain"> tas</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getTransactionAttribute</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">method</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> targetClass</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token class-name">TransactionManager</span><span class="token plain"> tm </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">determineTransactionManager</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">txAttr</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">txAttr </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">||</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ptm </span><span class="token keyword" style="color:#00009f">instanceof</span><span class="token plain"> </span><span class="token class-name">CallbackPreferringPlatformTransactionManager</span><span class="token plain"> cpptm</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">TransactionInfo</span><span class="token plain"> txInfo </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">createTransactionIfNecessary</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ptm</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> txAttr</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> joinpointIdentification</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">try</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      retVal </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> invocation</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">proceedWithInvocation</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">finally</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token function" style="color:#d73a49">cleanupTransactionInfo</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">txInfo</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">commitTransactionAfterReturning</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">txInfo</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> retVal</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p><code>createTransactionIfNecessary</code> 에서는 <code>TransactionManager.getTransaction</code> 를 호출하여 TransactionTemplate 동작과 비슷하게 이미 정의한 EntityManager, Connection 를 이용해서 데이터에 접근합니다. 데이터 접근 이후에는 <code>commitTransactionAfterReturning</code> 을 통해 Transaction 상태에 따라 commit 을 진행합니다.</p>
<p>Transaction 없이 <code>Repository.findById</code> 함수를 호출하면 조금 다르게 동작합니다. <code>createTransactionIfNecessary</code> 내부에서 Transaction Context 를 가져오지 못합니다. Query 실행 내부를 따라가다보면 <code>SharedEntityManagerCreator</code> proxy 객체에서 EntityManager 직접 만드는 걸 찾을 수 있습니다.</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">abstract</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">SharedEntityManagerCreator</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">SharedEntityManagerInvocationHandler</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">implements</span><span class="token plain"> </span><span class="token class-name">InvocationHandler</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">Serializable</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token class-name">Object</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">invoke</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">Object</span><span class="token plain"> proxy</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">Method</span><span class="token plain"> method</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">Object</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> args</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">throws</span><span class="token plain"> </span><span class="token class-name">Throwable</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token class-name">EntityManager</span><span class="token plain"> target </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">EntityManagerFactoryUtils</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">doGetTransactionalEntityManager</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">targetFactory</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">properties</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">synchronizedWithTransaction</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">target </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        target </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">targetFactory</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">createEntityManager</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        isNewEm </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">abstract</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">EntityManagerFactoryUtils</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token class-name">EntityManager</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">doGetTransactionalEntityManager</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">EntityManagerFactory</span><span class="token plain"> emf</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token annotation punctuation" style="color:#393A34">@Nullable</span><span class="token plain"> </span><span class="token class-name">Map</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics operator" style="color:#393A34">?</span><span class="token generics punctuation" style="color:#393A34">,</span><span class="token generics"> </span><span class="token generics operator" style="color:#393A34">?</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"> properties</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">boolean</span><span class="token plain"> synchronizedWithTransaction</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">throws</span><span class="token plain"> </span><span class="token class-name">PersistenceException</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">EntityManagerHolder</span><span class="token plain"> emHolder </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">EntityManagerHolder</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token class-name">TransactionSynchronizationManager</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getResource</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">emf</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">emHolder </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> emHolder</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getEntityManager</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">!</span><span class="token class-name">TransactionSynchronizationManager</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">isSynchronizationActive</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">em </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      em </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">!</span><span class="token class-name">CollectionUtils</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">isEmpty</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">properties</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">?</span><span class="token plain"> emf</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">createEntityManager</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">properties</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> emf</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">createEntityManager</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">TransactionSynchronizationManager</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">bindResource</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">emf</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> emHolder</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p><code>TransactionSynchronizationManager.isSynchronizationActive</code> 를 통해서 만든 EntityManager 를 ThreadLocal 에 저장할지 말지 판단합니다. Transaction 이 없는 경우는 <code>TransactionSynchronizationManager</code> 에 저장된 Synchronization 이 없을테니 리소스를 저장하지 않고 바로 해제합니다.</p>
<p>참고) <a href="https://jaeseo.tistory.com/entry/SimpleJpaRepository%EC%9D%98-EntityManager%EB%8A%94-%EC%96%B4%EB%94%94%EC%84%9C-%EC%83%9D%EC%84%B1%EB%90%A0%EA%B9%8C" target="_blank" rel="noopener noreferrer">[JPA] SimpleJpaRepository의 EntityManager는 어디서 생성될까?</a></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="commit-과-리소스-정리">Commit 과 리소스 정리<a href="https://yongseongkim.github.io/blog/2025/08/17/spring-transaction-template-understanding/#commit-%EA%B3%BC-%EB%A6%AC%EC%86%8C%EC%8A%A4-%EC%A0%95%EB%A6%AC" class="hash-link" aria-label="Direct link to Commit 과 리소스 정리" title="Direct link to Commit 과 리소스 정리">​</a></h2>
<p><code>TransactionManager.commit</code> 에서는 commit, doAfterCommit, Context 정리하는 과정을 거칩니다.</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">status</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">isNewSynchronization</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">TransactionSynchronization</span><span class="token plain"> synchronization </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">TransactionSynchronizationManager</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getSynchronizations</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">TransactionSynchronizationManager</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">unbindResource</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">synchronization</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">status</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">isNewTransaction</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">doCommit</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">status</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// Actual database commit</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">triggerAfterCommit</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">status</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">cleanupAfterCompletion</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">status</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre></div></div>
<p>이전 섹션에서 언급했듯이, TransactionTemplate 을 시작할 때와 Repository 접근에서 commit 함수를 부릅니다. 그때 모든 Transaction 에서 데이터베이스 commit 을 부르는 건 아니고 <code>isNewTransaction</code> 을 통해서 최상위 Transaction 에서만 commit 을 호출합니다.</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">cleanupAfterCompletion</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">DefaultTransactionStatus</span><span class="token plain"> status</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">status</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">isNewSynchronization</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">TransactionSynchronizationManager</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">clear</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">status</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">isNewTransaction</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">JpaTransactionObject</span><span class="token plain"> txObject </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> status</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getTransaction</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    txObject</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getEntityManagerHolder</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">clear</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p>Context 를 정리하는 과정에서는 <code>TransactionSynchronizationManager</code> 를 통해서 ThreadLocal에 저장되어있는 리소스들을 정리합니다.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="예시">예시<a href="https://yongseongkim.github.io/blog/2025/08/17/spring-transaction-template-understanding/#%EC%98%88%EC%8B%9C" class="hash-link" aria-label="Direct link to 예시" title="Direct link to 예시">​</a></h2>
<div class="language-kotlin codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-kotlin codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">transactionTemplate</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">also</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> it</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">isolationLevel </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> IsolationLevel</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">SERIALIZABLE </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">execute</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">val</span><span class="token plain"> driver </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> driverRepository</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">findByIdOrNull</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string-literal singleline string" style="color:#e3116c">"DVC40729"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<ol>
<li>TransactionTemplate 의 시작으로 <code>TransactionSynchronizationManager</code> 에 정의된 EntityManager 가 없기 때문에 <code>TransactionManager.startTransaction</code> 를 통해 EntityManager 를 만들고 JdbcConnection 을 맺습니다. 만든 객체는 <code>TransactionSynchronizationManager</code> 를 통해 ThreadLocal 에 저장합니다.</li>
<li>Repository 함수는 Proxy 객체로 만들어져 있어 내부에서 <code>TransactionAspectSupport.invokeWithinTransaction</code> 를 호출하고 <code>TransactionSynchronizationManager</code> 를 통해 ThreadLocal 에 저장된 EntityManager 를 가져와 데이터에 접근합니다.</li>
</ol>
<hr>
<h1>최근에 마주한 문제들 해결하기</h1>
<p>TransactionTemplate 과 Repository 동작을 이해했으니 처음에 언급한 문제들을 차례대로 분석해보겠습니다.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="첫번째-문제-add-column-to-vehicle-table-ddl-1">첫번째 문제, add column to vehicle table DDL<a href="https://yongseongkim.github.io/blog/2025/08/17/spring-transaction-template-understanding/#%EC%B2%AB%EB%B2%88%EC%A7%B8-%EB%AC%B8%EC%A0%9C-add-column-to-vehicle-table-ddl-1" class="hash-link" aria-label="Direct link to 첫번째 문제, add column to vehicle table DDL" title="Direct link to 첫번째 문제, add column to vehicle table DDL">​</a></h2>
<div class="language-kotlin codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-kotlin codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">TestController</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">val</span><span class="token plain"> transactionTemplate</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> TransactionTemplate</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token annotation builtin">@Qualifier</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string-literal singleline string" style="color:#e3116c">"trackerDB"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">val</span><span class="token plain"> trackerTransactionTemplate</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> TransactionTemplate</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">fun</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">transactionInTrackerTransaction</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    trackerTransactionTemplate</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">also</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> it</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">isolationLevel </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> IsolationLevel</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">SERIALIZABLE </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">execute</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">val</span><span class="token plain"> trackerRide </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> trackerRepository</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">findById</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string-literal singleline string" style="color:#e3116c">"..."</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">val</span><span class="token plain"> acceptedRide </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> rideRepository</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">findById</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string-literal singleline string" style="color:#e3116c">"..."</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 3</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        transactionTemplate</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">execute</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 4</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            driverRepository</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">findById</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string-literal singleline string" style="color:#e3116c">"..."</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            vehicleRepository</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">findById</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string-literal singleline string" style="color:#e3116c">"..."</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 5</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<ol>
<li>
<p><code>TrackerDatabaseConfiguration</code> 에서 주입한 TransactionManager 를 통해 새로운 Transaction 을 시작합니다. <code>TransactionSynchronizationManager</code> 에 정의한 EntityManager 가 없으니 새로 만듭니다.</p>
</li>
<li>
<p><code>trackerRepository.findById</code> 는 <code>TransactionAspectSupport.invokeWithinTransaction</code> 를 호출하고 1 에서 정의한 EntityManager 를 활용해 데이터를 가져옵니다.</p>
</li>
<li>
<p><code>rideRepository.findById</code> 도 <code>TransactionAspectSupport.invokeWithinTransaction</code> 를 호출하지만, <code>PrimaryDatabaseConfiguration</code> 의 EntityManagerFactory 를 사용하므로 새로운 EntityManager 를 만듭니다.</p>
<ul>
<li>이전에 언급했듯이, Transaction 이 없는 Repository 접근은 EntityManager 를 새로 만들어 접근 후 바로 해제합니다.</li>
<li>그런데 Tracker Transaction 내부이기 때문에 <code>TransactionSynchronizationManager</code> 에 저장된 Synchronization 이 존재합니다. 그래서 PrimaryDatabase 에 대한 Transaction 이 아니더라도 ThreadLocal 에 EntityManager 를 저장합니다.<!-- -->
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">!</span><span class="token class-name">TransactionSynchronizationManager</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">isSynchronizationActive</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">em </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  em </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">!</span><span class="token class-name">CollectionUtils</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">isEmpty</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">properties</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">?</span><span class="token plain"> emf</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">createEntityManager</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">properties</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> emf</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">createEntityManager</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token class-name">TransactionSynchronizationManager</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">bindResource</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">emf</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> emHolder</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre></div></div>
</li>
<li>이후 데이터를 불러오고 나서 commit 하면서 리소스를 해제할 수 있지만 Transaction 이 없기 때문에 <code>commitTransactionAfterReturning</code> 에서 commit 도 부르지 않습니다.<!-- -->
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">protected</span><span class="token plain"> </span><span class="token class-name">Object</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">invokeWithinTransaction</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">Method</span><span class="token plain"> method</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token annotation punctuation" style="color:#393A34">@Nullable</span><span class="token plain"> </span><span class="token class-name">Class</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics operator" style="color:#393A34">?</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"> targetClass</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">final</span><span class="token plain"> </span><span class="token class-name">InvocationCallback</span><span class="token plain"> invocation</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">throws</span><span class="token plain"> </span><span class="token class-name">Throwable</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">try</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    retVal </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> invocation</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">proceedWithInvocation</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">finally</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">cleanupTransactionInfo</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">txInfo</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">commitTransactionAfterReturning</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">txInfo</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
</li>
</ul>
</li>
<li>
<p>새로운 PrimaryDatabase 의 Transaction 이 시작합니다. Transaction 을 시작할 때 ThreadLocal 에 저장된, 3번에서 만든 EntityManager 를 재활용 한다고 생각할 수 있지만 재활용하지 않고 새로 만듭니다.</p>
<ul>
<li>
<p>여기서는 이전에 언급하지 않은 suspend / resume 에 대해서 알아야합니다.</p>
</li>
<li>
<p>새로운 Transaction 을 만들 때 같은 EntityManager 를 접근하게 되면 의도치 않은 객체 변경/flush 를 유발할 수 있습니다. 이미 진행중인 EntityManager 는 suspend 함수를 통해 <code>TransactionSynchronizationManager</code> 에서 제거 후 해당 TransactionObject 에 저장합니다. 새롭게 열리는 Transaction 에서는 새로운 EntityManager 를 만들고 데이터를 접근합니다. 3번에서 만든 Context 를 suspend 합니다.</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// 참고 [What does suspending a transaction mean?](https://stackoverflow.com/questions/33729810/what-does-suspending-a-transaction-mean)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">final</span><span class="token plain"> </span><span class="token class-name">TransactionStatus</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">getTransaction</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">TransactionDefinition</span><span class="token plain"> definition</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token class-name">Object</span><span class="token plain"> transaction </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">doGetTransaction</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">isExistingTransaction</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">transaction</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">handleExistingTransaction</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">definition</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> transaction</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> debugEnabled</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token class-name">SuspendedResourcesHolder</span><span class="token plain"> suspendedResources </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">suspend</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">startTransaction</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">definition</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> transaction</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> debugEnabled</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> suspendedResources</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token class-name">TransactionStatus</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">handleExistingTransaction</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">TransactionDefinition</span><span class="token plain"> definition</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">Object</span><span class="token plain"> transaction</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">boolean</span><span class="token plain"> debugEnabled</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">throws</span><span class="token plain"> </span><span class="token class-name">TransactionException</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">definition</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getPropagationBehavior</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token class-name">TransactionDefinition</span><span class="token punctuation" style="color:#393A34">.</span><span class="token constant" style="color:#36acaa">PROPAGATION_REQUIRES_NEW</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">SuspendedResourcesHolder</span><span class="token plain"> suspendedResources </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">suspend</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">transaction</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">try</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">startTransaction</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">definition</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> transaction</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> debugEnabled</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> suspendedResources</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
</li>
<li>
<p>새로운 Transaction 이 끝날 때 commit 을 호출하고 리소스를 정리하는 과정에서 resume 함수를 호출하고 이전 suspend 했었던 Context 를 복구합니다. 여기서 3번에서 만든 EntityManager 를 다시 ThreadLocal 에 저장합니다.</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">cleanupAfterCompletion</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">DefaultTransactionStatus</span><span class="token plain"> status</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">status</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getSuspendedResources</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">resume</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">transaction</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">SuspendedResourcesHolder</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> status</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getSuspendedResources</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
</li>
</ul>
</li>
<li>
<p>trackerTransactionTemplate 를 commit 하면서 기존 <code>TransactionSynchronizationManager</code> 에 있던 resource 들을 모두 정리한다. 이때 3번에서 정의한 Context 까지 같이 정리하면서 ride 테이블의 metadata lock 이 해제됩니다.</p>
</li>
</ol>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="두번째-문제-readreplica-transaction-in-serializable-transaction-1">두번째 문제, ReadReplica Transaction in Serializable Transaction<a href="https://yongseongkim.github.io/blog/2025/08/17/spring-transaction-template-understanding/#%EB%91%90%EB%B2%88%EC%A7%B8-%EB%AC%B8%EC%A0%9C-readreplica-transaction-in-serializable-transaction-1" class="hash-link" aria-label="Direct link to 두번째 문제, ReadReplica Transaction in Serializable Transaction" title="Direct link to 두번째 문제, ReadReplica Transaction in Serializable Transaction">​</a></h2>
<div class="language-kotlin codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-kotlin codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token annotation builtin">@RestController</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">TestController</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">val</span><span class="token plain"> transactionTemplate</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> TransactionTemplate</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token annotation builtin">@Transactional</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">isolation </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Isolation</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">SERIALIZABLE</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">fun</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">readReplicaInSerializable</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 인증 토큰 확인은 아래와 같이 유저 정보에 접근한다.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    transactionTemplate</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">also</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> it</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">isReadReplicaEnabled </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">execute</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        userRepository</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">findById</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string-literal singleline string" style="color:#e3116c">"..."</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">val</span><span class="token plain"> ride </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> rideRepository</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">findById</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string-literal singleline string" style="color:#e3116c">"..."</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// update something</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    rideRepository</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">save</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ride</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 3</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<ol>
<li>
<p><code>@Transactional</code> 어노테이션이 AOP를 통해 메서드 실행 전에 Transaction Context 를 새로 만듭니다.</p>
<ul>
<li>
<p><code>JpaTransactionManager</code> 에서 JdbcConnection 을 접근하면서 database 와 실제 database connection 을 맺는다.</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token class-name">ConnectionHandle</span><span class="token plain"> conHandle </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">getJpaDialect</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getJdbcConnection</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">em</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> definition</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">isReadOnly</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">conHandle </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token class-name">ConnectionHolder</span><span class="token plain"> conHolder </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">ConnectionHolder</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">conHandle</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token class-name">TransactionSynchronizationManager</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">bindResource</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">getDataSource</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> conHolder</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  txObject</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">setConnectionHolder</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">conHolder</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
</li>
<li>
<p>근데 여기서 주의할 점은, 현재 타다 프로젝트에서는 <code>LazyConnectionDataSourceProxy</code> 를 사용하고 있습니다. <code>LazyConnectionDataSourceProxy</code> 는 Connection 객체를 만들때 실제로 database 에 연결하지 않고 proxy 객체만 만듭니다. 그리고 데이터에 접근할 때 connection 을 맺습니다.</p>
<div class="language-kotlin codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-kotlin codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">PrimaryDatabaseConfiguration</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token annotation builtin">@Bean</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">fun</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">mainDataSource</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> DataSource </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">ReadReplicaAwareDataSourceFactory</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">dataSource </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">/* master db */</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> replicaDataSource </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">/* replica db */</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">createInstance</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// LazyConnectionDataSourceProxy 을 사용</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">ReadReplicaAwareDataSourceFactory</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">val</span><span class="token plain"> dataSource</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> DataSource</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">val</span><span class="token plain"> replicaDataSource</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> DataSource</span><span class="token punctuation" style="color:#393A34">,</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> DataSourceFactory </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">override</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">fun</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">createInstance</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> DataSource </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">val</span><span class="token plain"> readOnlyRoutingDataSource </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">ReadOnlyRoutingDataSource</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    readOnlyRoutingDataSource</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">setTargetDataSources</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">replicaMap</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// replicaMap is ["slave": replicaDataSource]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    readOnlyRoutingDataSource</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">setDefaultTargetDataSource</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">dataSource</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">LazyConnectionDataSourceProxy</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">readOnlyRoutingDataSource</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
</li>
<li>
<p><code>LazyConnectionDataSourceProxy</code> 는 connection 을 한번 만든 다음 캐싱해놓습니다.</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// LazyConnectionDataSourceProxy.java</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token class-name">Connection</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">getTargetConnection</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">Method</span><span class="token plain"> operation</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">throws</span><span class="token plain"> </span><span class="token class-name">SQLException</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">target </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">target </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">username </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">?</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">obtainTargetDataSource</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getConnection</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">username</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">password</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">obtainTargetDataSource</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getConnection</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
</li>
</ul>
</li>
<li>
<p>내부 transactionTemplate으로 새로운 트랜잭션을 시작하며 처음 데이터에 접근합니다. 이때 isReadReplicaEnabled 옵션이 true로 설정되어 있으니
<code>determineCurrentLookupKey</code> 함수를 통해 ReadReplica database 로 연결을 맺습니다.</p>
<div class="language-kotlin codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-kotlin codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> ReadOnlyRoutingDataSource </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">AbstractRoutingDataSource</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// defaultTargetDataSource is "master" database.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> dataSourceKeys</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> List</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">Any</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token operator" style="color:#393A34">?</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// "slave"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">override</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">fun</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">determineCurrentLookupKey</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Any</span><span class="token operator" style="color:#393A34">?</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">isReadReplicaEnabled </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> dataSourceKeys</span><span class="token operator" style="color:#393A34">!!</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">isNotEmpty</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">val</span><span class="token plain"> randomDataSourceKey </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> dataSourceKeys</span><span class="token operator" style="color:#393A34">!!</span><span class="token punctuation" style="color:#393A34">[</span><span class="token function" style="color:#d73a49">getRandom</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">dataSourceKeys</span><span class="token operator" style="color:#393A34">!!</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">size</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> randomDataSourceKey</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
</li>
<li>
<p>이후 ReadReplica 데이터베이스에 update 명령어를 요청하니, read only 옵션에서 수행할 수 없다고 에러가 발생합니다.</p>
</li>
</ol>
<hr>
<h1>정리</h1>
<p>이번 문제들을 통해 Spring의 Transaction 관리가 단순히 <code>@Transactional</code> 어노테이션이나 <code>TransactionTemplate</code>을 사용하는 것 이상의 복잡한 메커니즘으로 동작한다는 것을 깊이 이해하게 되었습니다.
Transaction 컨텍스트가 ThreadLocal에 저장되고 <code>TransactionSynchronizationManager</code>를 통해 관리된다는 점, 그리고 여러 데이터베이스를 사용할 때는 각 EntityManagerFactory별로 독립적으로 관리된다는 것을 알게 되었습니다.
또한 <code>LazyConnectionDataSourceProxy</code>를 사용할 때는 Connection이 한 번 생성되면 캐싱되므로, Transaction 초기가 아닌 첫 데이터 접근 시점의 설정이 전체 Transaction에 영향을 미친다는 것도 알게 됐습니다.
여러 데이터베이스를 사용하거나 ReadReplica를 활용하는 복잡한 환경에서 관련된 이해가 많은 도움이 되었습니다.</p>]]></content>
        <category label="spring" term="spring"/>
        <category label="jpa" term="jpa"/>
        <category label="transaction" term="transaction"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[Auto Lotto Bot]]></title>
        <id>https://yongseongkim.github.io/blog/2024/06/22/lotto-bot/</id>
        <link href="https://yongseongkim.github.io/blog/2024/06/22/lotto-bot/"/>
        <updated>2024-06-22T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[회사를 다니기 막 시작할 때 지인들이 로또를 매주 구매하는게 낭비라고 생각했었다.]]></summary>
        <content type="html"><![CDATA[<p>회사를 다니기 막 시작할 때 지인들이 로또를 매주 구매하는게 낭비라고 생각했었다.
매우 낮은 확률에 일주일에 5천원씩, 한달에 약 3만원 정도를 소비하는게 꽤 큰 금액이라고 생각했다.</p>
<p>요즘 들어서 아무 일도 일어나지 않는 확률 0 보다는 가능성이라도 있는 0.0001% 확률이 낫다고 생각이 들었다. 일주일에 5천원이라 스타벅스 커피 한잔 더 마셨다 자기합리화를 하고 구매를 하기 시작했다.</p>
<p><img decoding="async" loading="lazy" alt="meme" src="https://yongseongkim.github.io/assets/images/meme-ef41d9624a3c090b086b4c039e0dd1c1.png" width="1629" height="768" class="img_ev3q"></p>
<p>처음에는 온라인 <a href="https://dhlottery.co.kr/" target="_blank" rel="noopener noreferrer">동행복권</a> 에서 주기적으로 구매헀으나 일하기 바빠 매주 구매하는 걸 까먹기도 했다.
그래서 자동 구매를 찾아보니 구매 프로그램이 있으나 공식 프로그램도 아니어서 보안 이슈를 고려, 다양한 툴 사용 경험도 늘릴겸 (조금이라도 개발 내공에 도움이 되지 않을까) 자동 구매 봇을 만들기로 결심했다.</p>
<p>마침 <a href="https://www.clien.net/service/board/lecture/16835687" target="_blank" rel="noopener noreferrer">자동 구매 스크립트 글</a>을 보았고 간단한 작업 &amp; 짧은 시간만 소모하므로 AWS lambda 를 써보기로 했다.
lightsail instance 하나 구매해서 다양한 스크립트 실행을 할까 했으나 우선 람다는 가격이 거의 무료에 가까워서 람다를 사용하기로 했다. (chromium 이 메모리를 많이 먹고 느려서 비용 걱정이 돼서 다시 계산해봐도 매우 저렴했다.)</p>
<img src="https://yongseongkim.github.io/assets/images/aws-lambda-pricing-d312b1216b683407bef29a4e3accc728.png" width="50%">
<p>(0.0000000267 _ 1000 _ 20초) * 4회 = <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0.002136</mn><mo stretchy="false">(</mo><mtext>대략한달에</mtext></mrow><annotation encoding="application/x-tex">0.002136 (대략 한달에 </annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord">0.002136</span><span class="mopen">(</span><span class="mord hangul_fallback">대략한달에</span></span></span></span>0.002-0.003)</p>
<p><a href="https://www.clien.net/service/board/lecture/16835687" target="_blank" rel="noopener noreferrer">자동 구매 스크립트 글</a>을 참고해서 playwright + chromium 으로 구성했다.
lambda 에서 chromium 을 구성하기 위해 찾아보니
<a href="https://github.com/alixaxel/chrome-aws-lambda" target="_blank" rel="noopener noreferrer">chrome-aws-lambda</a>, <a href="https://github.com/JupiterOne/playwright-aws-lambda" target="_blank" rel="noopener noreferrer">playwright-aws-lambda</a> 가 있었는데
마지막 커밋 내역도 오래되고 버전도 매우 낮았다.
위 repo 에서 이어서 작업하고 있는 <a href="https://github.com/Sparticuz/chromium" target="_blank" rel="noopener noreferrer">chromium</a> 를 발견했고 50MB 정도 되어서 S3 업로드, lambda layer 로 만들었다.
원글은 python 으로 작성되어 있는데 기존 lambda 봇들을 js 로 짜고 있어 통일할 겸, playwright 문서도 읽는 겸 nodejs 로 작성했다.</p>
<p>로컬에서 간단하게 돌려보고 성공, 이후 lambda 에서 돌려봤지만 모바일 페이지로 이동해서 구매 실패로 이어졌다.
동행복권은 아래 이미지와 같이 모바일 구매를 막는다.</p>
<img src="https://yongseongkim.github.io/assets/images/mobile-lottery-7c7573e54d62fda41026ba99f1b0292b.jpg" width="40%">
<p><a href="https://www.branch.io/" target="_blank" rel="noopener noreferrer">Branch</a>, <a href="https://www.appsflyer.com/" target="_blank" rel="noopener noreferrer">Appsflyer</a> 에서 제공하는 AppLinks/UniversalLink 들을 클릭했을 때
User-Agent 를 따라 앱을 실행할지/웹페이지를 띄울지 redirect 했던 기억이 있어 User-Agent 를 모바일로 설정했다.
하지만 또 실패.
<a href="https://playwright.dev/docs/api/class-browser#browser-new-context-option-is-mobile" target="_blank" rel="noopener noreferrer">playwright 설정에도 isMobile 이라는 옵션</a>이 있었지만 기본으로 false 라 문제가 아니었다.</p>
<p>동행 복권 페이지를 들어갈 때 redirect 하는 것 같아, <a href="https://el.dhlottery.co.kr/game/TotalGame.jsp?LottoId=LO40" target="_blank" rel="noopener noreferrer">로또 구매 페이지</a>를 curl 로 요청해보니 navigator.platform 을 보고 redirect 하고 있었다.</p>
<div class="language-js codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-js codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> filter </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"win16|win32|win64|macintel"</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token dom variable" style="color:#36acaa">navigator</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">platform</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">!</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">filter</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">indexOf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token dom variable" style="color:#36acaa">navigator</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">platform</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">toLowerCase</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&gt;=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token dom variable" style="color:#36acaa">location</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">href</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"https://m.dhlottery.co.kr/"</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p>navigator 를 필터에 해당하는 기기로 설정하니 정상적으로 페이지 진입이 가능했고 구매도 가능했다.</p>
<div class="language-js codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-js codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token known-class-name class-name">Object</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">defineProperty</span><span class="token punctuation" style="color:#393A34">(</span><span class="token known-class-name class-name">Object</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">getPrototypeOf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token dom variable" style="color:#36acaa">navigator</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"platform"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">value</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"macintel"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre></div></div>
<p>또한, chromium 을 띄우는 과정에서 lambda timeout 이 발생했는데, <a href="https://github.com/sparticuz/chrome-aws-lambda?tab=readme-ov-file#usage-with-playwright" target="_blank" rel="noopener noreferrer">문서를 보니</a> 메모리를 꽤 차지하는 것처럼 보였다.
<code>"You should allocate at least 512 MB of RAM to your Lambda, however 1600 MB (or more) is recommended."</code></p>
<p>그래서 timeout 을 늘리고 메모리를 1024MB 로 설정하니 20초 가량 걸려서 구매를 완료했다.
2048MB 로 설정해도 한달에 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0.002</mn><mo>−</mo></mrow><annotation encoding="application/x-tex">0.002-</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em"></span><span class="mord">0.002</span><span class="mord">−</span></span></span></span>0.003 라서 문제 없다고 생각한다. 계속 lambda 를 이용할 예정이다.</p>
<h1>Reference</h1>
<ul>
<li><a href="https://www.clien.net/service/board/lecture/16835687" target="_blank" rel="noopener noreferrer">파이썬으로 동행복권 로또 매주 자동 구매하기</a></li>
</ul>]]></content>
        <category label="bot" term="bot"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[Synchronization Techniques in Game Development]]></title>
        <id>https://yongseongkim.github.io/blog/2022/03/10/game-synchronizations/</id>
        <link href="https://yongseongkim.github.io/blog/2022/03/10/game-synchronizations/"/>
        <updated>2022-03-10T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[모빌리티 플랫폼 '타다' 개발에서 탑승 플로우(호출 - 호출 중 - 매칭 - 탑승 - 탑승 완료)를 앱에서 잘 보여주는 것이 매우 중요합니다.]]></summary>
        <content type="html"><![CDATA[<p>모빌리티 플랫폼 '타다' 개발에서 탑승 플로우(호출 - 호출 중 - 매칭 - 탑승 - 탑승 완료)를 앱에서 잘 보여주는 것이 매우 중요합니다.
호출을 하고 있다가 시간 만료로 취소가 되거나 매칭이 되었지만 드라이버가 사정이 생겨 취소하는 경우 등 탑승자의 아무런 입력 없이도 앱에서 탑승 상태를 잘 나타내야 합니다.
서버에 탑승 상태를 모바일 앱에서 잘 보여주기 위한 방법들을 고민하다가 멀티플레이어 게임에서의 어떻게 다른 플레이어들과 동시간대에 있는 것처럼 동기화가 잘되는지가 궁금해졌습니다.
멀티플레이어 게임을 하다보면 다양한 플레이어들의 상호작용이 있는데 이걸 어떻게 끊김 없이 보여주고 있는지 궁금해져서 관련된 기술들을 찾아서 정리해봤습니다.</p>
<p>여러 사용자가 참여하는 게임에서 동기화 방식은 다양합니다.
발생한 입력을 모아 클라이언트가 시뮬레이션하거나 서버에서 입력을 모아 시뮬레이션 후 클라이언트에서는 해당 상태를 자연스럽게 보여줄 수 있습니다.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="lockstep">Lockstep<a href="https://yongseongkim.github.io/blog/2022/03/10/game-synchronizations/#lockstep" class="hash-link" aria-label="Direct link to Lockstep" title="Direct link to Lockstep">​</a></h2>
<p><img decoding="async" loading="lazy" alt="lockstep-process" src="https://yongseongkim.github.io/assets/images/lockstep-process-967ce9196f15864dc7392ea3ebfd855d.png" width="773" height="588" class="img_ev3q">
출처: <a href="https://blog.naver.com/linegamedev/221061964789" target="_blank" rel="noopener noreferrer">멀티플레이 게임의 동기화 기법 시리즈 2편: 이벤트 동기화</a></p>
<p>Lockstep 은 라운드마다 서버가 플레이어들의 입력을 모아서 클라이언트들에 전송하여 시뮬레이션을 클라이언트에서 진행합니다.
일관성 유지를 위해 모든 단계를 맞춰가면서 진행됩니다.
하나의 라운드 내에서 모든 이벤트들에 순서가 매겨지게 되며, 예외가 발생하는 것을 미리 방지합니다.
가장 처리가 느린 클라이언트 위주로 진행되기 때문에 레이턴시가 큰 유저가 있으면 멈춤이 발생합니다.
참가자 수가 적은 RTS 에서 사용하고 참가자 수가 늘어날 수록 입력 패킷 도달 지연이 발생할 가능성이 큽니다.</p>
<p><img decoding="async" loading="lazy" alt="lockstep-fixed-time-interval" src="https://yongseongkim.github.io/assets/images/lockstep-fixed-time-interval-d3388a7e36f233c85199a87face64240.png" width="773" height="595" class="img_ev3q"></p>
<p>출처: <a href="https://blog.naver.com/linegamedev/221061964789" target="_blank" rel="noopener noreferrer">멀티플레이 게임의 동기화 기법 시리즈 2편: 이벤트 동기화</a></p>
<p>서로 다른 클라이언트 간 지연으로 피하기 위해 시간을 정해 라운드를 진행할 수도 있습니다.</p>
<p>아래 그림은 클라이언트에서 입력만을 교환해서 시뮬레이션하는 lockstep 에 대한 예시입니다.
서로의 상태를 hash value 로 항상 비교합니다.
주로 RTS 혹은 과거 AOS 게임에서 쓰는 방식입니다.</p>
<p><img decoding="async" loading="lazy" alt="lockstep-table-step1" src="https://yongseongkim.github.io/assets/images/lockstep-table-step1-7959f82a2a056459dbaa2186e654d489.png" width="1662" height="802" class="img_ev3q"></p>
<p>출처: <a href="https://youtu.be/j3eQNm-Wk04" target="_blank" rel="noopener noreferrer">[NDC] CAP 이론을 통한 네트워크 동기화 기법</a></p>
<p>1초에 20번 업데이트하는 게임에서 50ms 당 라운드를 가집니다.
각 클라이언트는 이벤트 큐가 존재하고 라운드마다 이벤트를 처리합니다.
네트워크 상황에 따라 이벤트를 처리하는 시점이 다를텐데 여기서 '나' 와 '상대2' 에 대한 이벤트를 받았지만 '상대1' 에 대한 이벤트는 받지 못한 상황입니다.</p>
<p><img decoding="async" loading="lazy" alt="lockstep-table-step2" src="https://yongseongkim.github.io/assets/images/lockstep-table-step2-7d7722739d42fe2bceb8f1e60c4c740b.png" width="1884" height="868" class="img_ev3q"></p>
<p>출처: <a href="https://youtu.be/j3eQNm-Wk04" target="_blank" rel="noopener noreferrer">[NDC] CAP 이론을 통한 네트워크 동기화 기법</a></p>
<p>'상대1' 의 이벤트까지 모이면 해당 라운드를 시뮬레이션해서 처리합니다.</p>
<p><img decoding="async" loading="lazy" alt="lockstep-table-step3" src="https://yongseongkim.github.io/assets/images/lockstep-table-step3-4f9e5496aa18c6033bfe9f783a184304.png" width="2338" height="864" class="img_ev3q"></p>
<p>출처: <a href="https://youtu.be/j3eQNm-Wk04" target="_blank" rel="noopener noreferrer">[NDC] CAP 이론을 통한 네트워크 동기화 기법</a></p>
<p>'나' 와 '상대2' 의 이벤트는 계속 전달되고 있지만 '상대1' 은 네트워크 불안정으로 인해 이벤트를 받지 못한다면 해당 라운드 처리가 불가합니다.</p>
<p>| 상대방을 기다리는 상황 | 기다리다 상대방을 내쫓은 상황 |
| <img decoding="async" loading="lazy" alt="lockstep-starcraft-wating-for-players" src="https://yongseongkim.github.io/assets/images/lockstep-starcraft-wating-for-players-popup-0ff45d976993c3febb63aed4f1f0ce82.jpg" width="601" height="448" class="img_ev3q"> | <img decoding="async" loading="lazy" alt="lockstep-starcraft-drop-player" src="https://yongseongkim.github.io/assets/images/lockstep-starcraft-drop-player-0d834b8d24e787f3d3a30c3f0e5f5514.png" width="640" height="480" class="img_ev3q"> |</p>
<p>출처: <a href="http://starcraft.burningblade.org/stories/index.html" target="_blank" rel="noopener noreferrer">Robocop's Starcraft Page</a></p>
<p>게임 스타크래프트를 해봤으면 위와 같은 팝업들을 많이 보셨을 겁니다. 라운드 처리를 위해 상대방 이벤트를 기다리다가 쫓은 상황입니다.</p>
<p><img decoding="async" loading="lazy" alt="lockstep-starcraft-network-options" src="https://yongseongkim.github.io/assets/images/lockstep-starcraft-network-options-d7a557c91f17de7dd5d07c662b9198f3.png" width="265" height="313" class="img_ev3q"></p>
<p>출처: <a href="http://starcraft.burningblade.org/stories/index.html" target="_blank" rel="noopener noreferrer">Robocop's Starcraft Page</a></p>
<p>위와 같은 상황처럼 lockstep 에서는 동기화 주기가 중요합니다.
스타크래프트에서는 위 이미지와 같은 네트워크 옵션 선택이 있었는데 low latency 는 자주 동기화 하겠다는 뜻입니다.
자주 동기화하면 플레이어가 빠른 반응을 느낄 수 있지만 한 플레이어라도 늦으면 바로 멈추는 상황이 생겨버립니다.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="authoritative-server">Authoritative Server<a href="https://yongseongkim.github.io/blog/2022/03/10/game-synchronizations/#authoritative-server" class="hash-link" aria-label="Direct link to Authoritative Server" title="Direct link to Authoritative Server">​</a></h2>
<p>라운드를 가지는 lockstep 과 다르게 라운드 없이 모든 이벤트를 지속적으로 받아 서버가 판단하는 방식입니다.
클라이언트에서 발생하는 이벤트를 서버로 전달, 서버에서는 이벤트를 모아 시뮬레이션하여 상태 변화를 클라이언트로 보냅니다.
클라이언트는 과거의 서버 상태를 재생하는 형태입니다. 그래서 클라이언트마다 일관성이 안맞을 수 있습니다.</p>
<p><img decoding="async" loading="lazy" src="https://post-phinf.pstatic.net/MjAxNzEyMjRfMTY1/MDAxNTE0MDkyMzQ5MjA4._A49iM-itpHIoKJE_uJStJQ71lkJhJBMsXcwQoFHIUQg.SZw0b1lbLY0ceErbxejgJpHw684oLDFAKWOCYQ1ROh0g.GIF/honeycam_2017-12-22_18-57-33.gif?type=w1200" alt="배틀그라운드 트레이서 현상" class="img_ev3q"></p>
<p>출처: <a href="https://m.post.naver.com/viewer/postView.nhn?volumeNo=11513471&amp;memberNo=16036253" target="_blank" rel="noopener noreferrer">배틀그라운드 트레이서 현상</a></p>
<p>위 영상은 실제로 버그였지만 위 영상과 같이 클라이언트와 서버 상태가 다른 경우 그에 맞게 다시 되돌아가는 현상이 생길 수 있습니다.</p>
<p><img decoding="async" loading="lazy" alt="server-authoritative-overwatch-tracer-server-stunned" src="https://yongseongkim.github.io/assets/images/server-authoritative-overwatch-tracer-server-stunned-6eb6c3accece4cfa1d725f25150038d7.png" width="1500" height="902" class="img_ev3q"></p>
<p>출처: <a href="https://youtu.be/W3aieHjyNvw" target="_blank" rel="noopener noreferrer">Overwatch Gameplay Architecture and Netcode</a></p>
<p>게임 오버워치에서 '트레이서' 라는 캐릭터가 클라이언트에서는 움직이고 있다가 다른 플레이어의 공격으로 인해 기절한 상황입니다.
서버에서 기절 상태를 전송받기 전까지는 클라이언트는 계속 이동상태를 보여줍니다.</p>
<p><img decoding="async" loading="lazy" alt="server-authoritative-overwatch-tracer-client-stunned" src="https://yongseongkim.github.io/assets/images/server-authoritative-overwatch-tracer-client-stunned-1769c1ab27d4781aaef5fae798bafefc.png" width="1500" height="902" class="img_ev3q"></p>
<p>출처: <a href="https://youtu.be/W3aieHjyNvw" target="_blank" rel="noopener noreferrer">Overwatch Gameplay Architecture and Netcode</a></p>
<p>서버에서 기절 상태를 받게 되면 그 시점부터 일정 시간 동안 클라이언트에서 기절 상태를 보여줍니다.</p>
<p><img decoding="async" loading="lazy" alt="server-authoritative-overwatch-tracer-client-stunned-finished" src="https://yongseongkim.github.io/assets/images/server-authoritative-overwatch-tracer-client-stunned-finished-94333dbd6c224826e836ca20496fa5b6.png" width="1500" height="902" class="img_ev3q"></p>
<p>출처: <a href="https://youtu.be/W3aieHjyNvw" target="_blank" rel="noopener noreferrer">Overwatch Gameplay Architecture and Netcode</a></p>
<p>서버에서 받은 정보를 기반으로 기절 상태가 언제 끝나는지 클라이언트가 알기 때문에 기절 상태가 끝나면 원래 상태로 복구합니다.
위 이미지에서는 30-32 frame 이 클라이언트에서 기절 시간 후에 원래 상태로 복구하는 것을 나타냅니다.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="time-synchronization">Time Synchronization<a href="https://yongseongkim.github.io/blog/2022/03/10/game-synchronizations/#time-synchronization" class="hash-link" aria-label="Direct link to Time Synchronization" title="Direct link to Time Synchronization">​</a></h3>
<p>먼저 서버와 다수의 클라이언트에서 사용하는 시간 정보를 맞춰야 클라이언트에서 발생하는 이벤트 순서를 정할 수 있습니다.
이벤트 순서에 따라 그 이후에 이루어지는 상황이 변할 수 있으니 시간 동기화는 굉장히 중요합니다.
머신에서 제공하는 타임스탬프 값을 사용하여 이벤트가 발생한 시점 정보를 공유할 수 있는데,&nbsp;문제는 머신마다 시간 정보에 미세한 차이가 있을 수 있습니다.
그래서 서버에서 시간을 결정하고 클라이언트에게는 현재 시간을 파악하는 API 를 제공합니다.</p>
<p><img decoding="async" loading="lazy" alt="time-synchronization-estimation" src="https://yongseongkim.github.io/assets/images/time-synchronization-estimation-d2ff50d584304c8f2875bc4e93f883f3.png" width="539" height="357" class="img_ev3q"></p>
<p>출처: <a href="https://blog.naver.com/linegamedev/221060368580" target="_blank" rel="noopener noreferrer">멀티플레이 게임의 동기화 기법 시리즈 1편: 시간 동기화</a></p>
<p>위 그림처럼 클라이언트가 현재 시간을 알려달라는 API 를 호출 - 서버는 클라이언트 요청을 받아 현재 시간을 반환 - 반환한 값이 클라이언트까지 돌아오게 됩니다.
실제로 서버가 응답을 받았을 때에 대한 시간을 클라이언트가 알기 어렵기 때문에 통계적으로 추정합니다.
간단한 방법으로, 여러 번 API 를 호출하여 평균과 표준편차를 구해 구간을 벗어나는 데이터는 전부 이상치로 간주할 수도 있습니다.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="tick-rate">Tick Rate<a href="https://yongseongkim.github.io/blog/2022/03/10/game-synchronizations/#tick-rate" class="hash-link" aria-label="Direct link to Tick Rate" title="Direct link to Tick Rate">​</a></h3>
<p>서버에서는 클라이언트의 입력을 받아 시뮬레이션 한 결과값을 클라이언트에 알려주는데 이러한 과정을 얼마나 자주할지도 게임을 플레이하는 플레이어한테 많은 영향을 끼칩니다.
자주하게 되면 더 정확한 판정, 되감기에도 유리하지만 높은 네트워크 대역과 CPU 를 요구하기 때문에 회사에서는 큰 비용을 부담해야 합니다.
오버워치는 Broadcast 비율을 20Hz 정도로 서버에서 1번 업데이트가 클라이언트에서는 3-4 frame 을 차지합니다.
1 frmae 은 16ms 정도로 서버의 약 48ms 늦은 상태를 보고 있다는 뜻입니다.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="area-of-interest">Area of Interest<a href="https://yongseongkim.github.io/blog/2022/03/10/game-synchronizations/#area-of-interest" class="hash-link" aria-label="Direct link to Area of Interest" title="Direct link to Area of Interest">​</a></h3>
<p>서버는 클라이언트에게 시뮬레이션 한 결과값을 알려주는데 Tick Rate 는 얼마나 자주할건지에 대한 얘기라면 Area of Interest 는 어디까지 알려줘야하는가 입니다.
범위가 넓으면 패킷 처리량이 많아지고 보안에 좋지 않습니다.
배틀그라운드의 경우 원거리 저격에 떄문에 멀리 있는 적 정보까지 동기화 해야 하는데, 클라이언트 메모리 정보만으로 많은 정보들을 확보할 수 있어 다양한 핵이 나올 수 있습니다.
범위가 좁다면 갑자기 다른 플레이어가 튀어 나오는 경험 등 플레이어에게 안좋은 경험이기 때문에 개발사는 범위를 잘 고려해야 합니다.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="snapshot-and-delta">Snapshot and Delta<a href="https://yongseongkim.github.io/blog/2022/03/10/game-synchronizations/#snapshot-and-delta" class="hash-link" aria-label="Direct link to Snapshot and Delta" title="Direct link to Snapshot and Delta">​</a></h3>
<p>클라이언트가 입력을 보내면 서버가 시뮬레이션을 진행한 후 스냅샷을 배포하면 클라이언트들은 그 스냅샷을 적용합니다.
모든 객체의 상태를 동기화하기 때문에 객체가 늘어나면 스냅샷 크기가 커집니다.
스냅샷 크기를 조절하기 위해 수신자별 우선순위가 높은 변경점을 우선해서 발송하거나 발송빈도를 높여 스냅샷 크기 자체를 줄일 수도 있습니다.</p>
<h1>Synchronization Details</h1>
<p><img decoding="async" loading="lazy" alt="client-server-request-response-delay" src="https://yongseongkim.github.io/assets/images/client-server-request-response-delay-bc5d964d9fcac730df8b991546f35092.png" width="430" height="249" class="img_ev3q"></p>
<p>출처: <a href="https://www.gabrielgambetta.com/client-server-game-architecture.html" target="_blank" rel="noopener noreferrer">Fast-Paced Multiplayer (Part I): Client-Server Game Architecture</a></p>
<p>클라이언트와 서버 통신으로 인해 실제로 플레이어가 요청한 입력은 일정 시간 후에 처리됩니다.</p>
<p><img decoding="async" loading="lazy" alt="client-server-request-response-animation-after-delay" src="https://yongseongkim.github.io/assets/images/client-server-request-response-animation-after-delay-a0fda3bb3f1c840bd1907fae1ca8b381.png" width="484" height="383" class="img_ev3q"></p>
<p>출처: <a href="https://www.gabrielgambetta.com/client-side-prediction-server-reconciliation.html" target="_blank" rel="noopener noreferrer">Fast-Paced Multiplayer (Part II): Client-Side Prediction and Server Reconciliation</a></p>
<p>일정 시간 후에 동작하는 움직임은 플레이어들에게 그리 좋지 않은 경험입니다.</p>
<p><img decoding="async" loading="lazy" alt="client-server-request-response-animation-delay-other-players" src="https://yongseongkim.github.io/assets/images/client-server-request-response-delay-other-players-0c1d581f42527aef53b57388445c44b4.png" width="738" height="452" class="img_ev3q"></p>
<p>출처: <a href="https://www.gabrielgambetta.com/entity-interpolation.html" target="_blank" rel="noopener noreferrer">Fast-Paced Multiplayer (Part III): Entity Interpolation</a></p>
<p>변경된 상태를 서버에서 다른 클라이언트까지 보내는 데 추가로 시간이 들기 때문에 실제로 플레이어들은 일관성이 맞지 않는 경험을 자주 할 수 있습니다.</p>
<p>실제로 우리가 게임할 때 동시에 일어나는 것처럼 느끼는데 이러한 제약을 어떻게 극복하고 있는지를 찾아봤습니다.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="prediction-and-reconciliation">Prediction and Reconciliation<a href="https://yongseongkim.github.io/blog/2022/03/10/game-synchronizations/#prediction-and-reconciliation" class="hash-link" aria-label="Direct link to Prediction and Reconciliation" title="Direct link to Prediction and Reconciliation">​</a></h2>
<p><img decoding="async" loading="lazy" alt="prediction-reconciliation-move-first-before-response" src="https://yongseongkim.github.io/assets/images/prediction-reconciliation-move-first-before-response-a3436a3e830547beaf2e1f4831e4b8ab.png" width="484" height="452" class="img_ev3q"></p>
<p>출처: <a href="https://www.gabrielgambetta.com/client-side-prediction-server-reconciliation.html" target="_blank" rel="noopener noreferrer">Fast-Paced Multiplayer (Part II): Client-Side Prediction and Server Reconciliation</a></p>
<p>간단한 해결책으로 서버 응답을 기다리지 않고 먼저 움직이는 것입니다.
근데 그렇게 하면 이후 서버에서 응답이 왔을 때 다시 전위치로 돌아갔다가 제위치로 돌아오게 됩니다.</p>
<p><img decoding="async" loading="lazy" alt="prediction-reconciliation-move-first-reconciliation" src="https://yongseongkim.github.io/assets/images/prediction-reconciliation-move-first-reconciliation-7014f4e18c9ecde99af90e4ed39bbb04.png" width="543" height="452" class="img_ev3q"></p>
<p>출처: <a href="https://www.gabrielgambetta.com/client-side-prediction-server-reconciliation.html" target="_blank" rel="noopener noreferrer">Fast-Paced Multiplayer (Part II): Client-Side Prediction and Server Reconciliation</a></p>
<p>위 문제를 해결하기 위해 클라이언트는 입력 요청들을 저장해놓고 서버에서 오는 응답을 받을 때 이전 요청들이 처리되었는지 파악합니다.
처리 되었으면 저장된 입력 요청을 버리고 또 다시 오는 응답들을 저장한 입력과 비교해가면서 적용해갈 수 있습니다.</p>
<p><a href="https://www.gabrielgambetta.com/client-side-prediction-live-demo.html" target="_blank" rel="noopener noreferrer">Fast-Paced Multiplayer: Sample Code and Live Demo</a> 를 들어가서
Prediction(서버 응답이 오기 전에 미리 움직이기) 만 키면 먼저 움직였다가 돌아오는 걸 볼 수 있습니다.
여기서 Reconciliation(요청을 저장하고 서버에서 온 응답을 처리해가면서 적용) 을 키면 원래 자리로 돌아가지 않고 부드럽게 반영되는 걸 볼 수 있습니다.</p>
<p><img decoding="async" loading="lazy" alt="client-server-request-response-delay-other-players" src="https://yongseongkim.github.io/assets/images/client-server-request-response-delay-other-players-0c1d581f42527aef53b57388445c44b4.png" width="738" height="452" class="img_ev3q"></p>
<p>출처: <a href="https://www.gabrielgambetta.com/client-side-prediction-server-reconciliation.html" target="_blank" rel="noopener noreferrer">Fast-Paced Multiplayer (Part II): Client-Side Prediction and Server Reconciliation</a></p>
<p>내가 움직이는 모습을 부드럽게 하는 건 어느 정도 처리한 것 같은데 다른 플레이어들과의 상황은 어떻게 처리할 수 있을까요?</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="dead-reckoning">Dead Reckoning<a href="https://yongseongkim.github.io/blog/2022/03/10/game-synchronizations/#dead-reckoning" class="hash-link" aria-label="Direct link to Dead Reckoning" title="Direct link to Dead Reckoning">​</a></h2>
<p><img decoding="async" loading="lazy" alt="server-response-interpolated-from-past-positions" src="https://yongseongkim.github.io/assets/images/server-response-interpolated-from-past-positions-453947fc75ceefa8920061fc3b1e0990.png" width="617" height="512" class="img_ev3q"></p>
<p>출처: <a href="https://www.gabrielgambetta.com/entity-interpolation.html" target="_blank" rel="noopener noreferrer">Fast-Paced Multiplayer (Part III): Entity Interpolation</a></p>
<p>Dead Reckoning(DR)은 '추측 항법' 으로 쓰이기도 하는데 거리 및 방향을 계산하여 위치를 추적하는 기술입니다.
게임에서 Dead Reckoning 은 캐릭터의 이동경로를 예측하는 방법이라고 할 수 있습니다.
단순히 패킷에 좌표만 담는 게 아니라 속도, 가속도를 담아 전달하면 다른 클라이언트에서는 마지막으로 확인된 패킷의 정보를 통해 현재 위치를 유추할 수 있습니다.
즉, 위치, 향하는 방향 그리고 속도를 알고 있고 현재가 그 시점으로부터 어느 정도 시간이 흘렀는지를 알고 있다면 현재 위치를 계산할 수 있습니다.</p>
<p><img decoding="async" loading="lazy" alt="interpolation-extrapolation-cartrider" src="https://yongseongkim.github.io/assets/images/interpolation-extrapolation-cartrider-0cf47812f9ec637b861172e9a7c79f27.png" width="2000" height="882" class="img_ev3q"></p>
<p>출처: <a href="https://youtu.be/r4ZaolMQOzE" target="_blank" rel="noopener noreferrer">〈카트라이더〉 0.001초 차이의 승부 - 300km/h 물체의 네트워크 동기화 모델 구현기</a></p>
<p>카트라이더 같은 차량 경주 게임에서는 이러한 요소들이 굉장히 중요합니다.
순위를 가르는 경쟁에서 실제 서버에서는 내 위치가 상대방 보다 뒤에 있는데 앞에 있다고 보이면 안되니까요.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="interpoliation-and-extrapolation">Interpoliation and Extrapolation<a href="https://yongseongkim.github.io/blog/2022/03/10/game-synchronizations/#interpoliation-and-extrapolation" class="hash-link" aria-label="Direct link to Interpoliation and Extrapolation" title="Direct link to Interpoliation and Extrapolation">​</a></h3>
<iframe width="560" height="315" src="https://www.youtube.com/embed/r4ZaolMQOzE?start=650&amp;end=725" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"></iframe>
<p>Interpolation 은 0 과 1 값이 있을 때 0 과 1 사잇 값을 유추하는 거라면, Extrapolation Range 를 넘어선 2, 3을 유추하는 과정입니다.
패킷을 보낸 시각, 카트의 위치, 카트의 선형 속도, 각속도 등을 이용하여 상대방의 위치를 유추합니다.
클라이언트 간 시간을 맞추기 위해 서버 시간을 이용, 서버는 클라이언트에 현재 시간을 보냅니다.
클라이언트 시계와 서버 시계를 비교하여 델타를 구해 서버의 시간을 유추하고 패킷에 담습니다.</p>
<p><img decoding="async" loading="lazy" alt="extrapolation-cartrider" src="https://yongseongkim.github.io/assets/images/extrapolation-cartrider-dcce3e6cd7a5929eac5e2abdf5cdb4f2.png" width="2206" height="852" class="img_ev3q"></p>
<p>출처: <a href="https://youtu.be/r4ZaolMQOzE" target="_blank" rel="noopener noreferrer">〈카트라이더〉 0.001초 차이의 승부 - 300km/h 물체의 네트워크 동기화 모델 구현기</a></p>
<p>현재 위츠는 이전 프레임에서 계산된 위치입니다.
패킷을 받은 후에 속도와 시간을 이용하여 다음 위치를 계산, 여기서 Interpolation 한번 더해서 새로운 위치를 계산합니다. 각도도 같은 방법으로 계산합니다.
구체적인 내용은 <a href="https://youtu.be/r4ZaolMQOzE" target="_blank" rel="noopener noreferrer">영상</a>을 참고해주세요.</p>
<p>위와 같은 계산을 이용하면 20ms 레이턴시를 가질 때 영상입니다.</p>
<iframe width="560" height="315" src="https://www.youtube.com/embed/r4ZaolMQOzE?start=840&amp;end=869" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"></iframe>
<p>200ms 레이턴시를 가질 때 영상입니다.</p>
<iframe width="560" height="315" src="https://www.youtube.com/embed/r4ZaolMQOzE?start=880&amp;end=920" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"></iframe>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="remove-animations">Remove Animations<a href="https://yongseongkim.github.io/blog/2022/03/10/game-synchronizations/#remove-animations" class="hash-link" aria-label="Direct link to Remove Animations" title="Direct link to Remove Animations">​</a></h2>
<p><img decoding="async" loading="lazy" alt="remove-animations-attacks-at-diffrent-times-before" src="https://yongseongkim.github.io/assets/images/remove-animations-attacks-at-diffrent-times-before-d6260396c5a05e4d4be37d7896300ceb.png" width="2040" height="1288" class="img_ev3q"></p>
<p>출처: <a href="https://noti.st/eiaserinnys/jCpSbp" target="_blank" rel="noopener noreferrer">네트웍 동기화 개론과 고급 동기화 기법</a></p>
<p>상대방은 타격 요청을 하고 바로 애니메이션이 시작하는데 서버에서 상대방의 타격 요청을 알려줬을 때는 상대방 클라이언트에서 이미 타격 애니메이션이 꽤나 진행된 상태일 것입니다.
실제로 동시에 타격판정이 일어나지 않아 보일 수 있다는 것이죠.</p>
<p><img decoding="async" loading="lazy" alt="remove-animations-attacks-at-diffrent-times-after" src="https://yongseongkim.github.io/assets/images/remove-animations-attacks-at-diffrent-times-after-3cbc614b14814ed82c39fdfad162f827.png" width="1404" height="868" class="img_ev3q"></p>
<p>출처: <a href="https://noti.st/eiaserinnys/jCpSbp" target="_blank" rel="noopener noreferrer">네트웍 동기화 개론과 고급 동기화 기법</a></p>
<p>동시에 타격이 일어나게 하기 위해 중간에 애니메이션을 삭제하거나 빠르게 진행할 수 있습니다.</p>
<p>| 처리하지 않았을 때 | 동기화 처리를 했을 때 |
| <img decoding="async" loading="lazy" alt="remove-animations-non-converging-prediction" src="https://yongseongkim.github.io/assets/images/remove-animations-non-converging-prediction-e080b56d80191f3c2db8f0b51ae22b7e.png" width="964" height="782" class="img_ev3q"> | <img decoding="async" loading="lazy" alt="remove-animations-converging-prediction" src="https://yongseongkim.github.io/assets/images/remove-animations-converging-prediction-e2e3060da6cd7273315ff9c2066d325f.png" width="1344" height="644" class="img_ev3q"> |</p>
<video width="80%" controls=""><source src="/assets/medias/remove-animations-pico-tanks-bec29ae87d1824975ca2140604600f97.mp4" type="video/mp4"></video>
<p>출처: <a href="https://twitter.com/PickTanks/status/1097623864966819840" target="_blank" rel="noopener noreferrer">PickoTanks Twitter</a></p>
<p>위 영상 약 10초 부분에서 파란 탱크의 미사일이 갑자기 중간에 생기는 것을 볼 수 있습니다.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="hit-registration-and-lag-compensation">Hit Registration and Lag Compensation<a href="https://yongseongkim.github.io/blog/2022/03/10/game-synchronizations/#hit-registration-and-lag-compensation" class="hash-link" aria-label="Direct link to Hit Registration and Lag Compensation" title="Direct link to Hit Registration and Lag Compensation">​</a></h2>
<p>실제 타격 피해에 대해서는 클라이언트에서 처리하면 많은 부정행위 떄문에 플레이어들이 떠날 수 있습니다.
그래서 서버에서 클라이언트 상태, 지연시간 등을 고려, 서버에서 정보를 재구성하고 타격 처리를 진행합니다.</p>
<p><img decoding="async" loading="lazy" alt="hit-registration-boundary-overwatch-example" src="https://yongseongkim.github.io/assets/images/hit-registration-boundary-overwatch-example-27864f5403272bb3ae8b8d6c09e9d22e.png" width="1920" height="1072" class="img_ev3q"></p>
<p>출처: <a href="https://youtu.be/W3aieHjyNvw" target="_blank" rel="noopener noreferrer">Overwatch Gameplay Architecture and Netcode</a></p>
<p>오버워치에서는 타격 판정을 위해 객체에 대한 Bounding Volume 을 계산합니다.
해당 객체가 0.5초 정도 사이에 움직일 수 있는 영역을 계산하여 영역에 총알이 들어 갔을 때 해당 객체의 정보를 재구성하는지 판단합니다.
위 이미지에서 총을 쐈을 때 라인하르트(오른쪽에 방패들고 있는 애) 에 대한 정보를 재구성하지 않습니다.</p>
<iframe width="560" height="315" src="https://www.youtube.com/embed/W3aieHjyNvw?start=2270&amp;end=2305" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"></iframe>
<p>오버워치에서 타격 판정을 위해 어떻게 계산하는지 시각적으로 보여주는 영상입니다.</p>
<p>아래 2개의 영상은 클라이언트에서는 타격했다고 판정해서 애니메이션을 보여주지만 실제로 서버가 재구성했을 때는 타격이 아니라고 판정하는 경우입니다.</p>
<ul>
<li>Overwatch: Ana and Mei</li>
</ul>
<p>총을 발포했지만 메이의 스킬로 인해 발포자의 위치가 바뀌어 실제로 타격이 일어나지 않았다 고 판단한 경우입니다.</p>
<iframe width="560" height="315" src="https://www.youtube.com/embed/W3aieHjyNvw?start=2440&amp;end=2500" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"></iframe>
<ul>
<li>Overwatch: Hanzo and Reaper</li>
</ul>
<p>한조가 화살을 쏴서 타격 애니메이션이 발동했지만 리퍼의 스킬로 인해 실제로 맞지 않았다고 판단한 경우입니다. 실제로 피해를 입었다면 상단에 체력바가 뜹니다.</p>
<iframe width="560" height="315" src="https://www.youtube.com/embed/W3aieHjyNvw?start=2500&amp;end=2535" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"></iframe>
<p><img decoding="async" loading="lazy" alt="lag-compensation" src="https://yongseongkim.github.io/assets/images/lag-compensation-0b4058172b455edc062c9af5e8f58b71.png" width="690" height="372" class="img_ev3q"></p>
<p>출처: <a href="https://developer.valvesoftware.com/wiki/Source_Multiplayer_Networking#Lag_compensation" target="_blank" rel="noopener noreferrer">ValveSofteware Wiki - LagCompensation</a></p>
<p>지연에 대해서 서버에서 위치를 보정하는 로직을 시각화한 예입니다.
붉은색 박스가 총 쏘는 입장에서 캐릭터 위치, 파란색 박스가 서버에서는 실제 캐릭터 위치를 100ms 뒤로 이동시킨 위치입니다.
타격이 파란색 박스 어느정도 겹치면 히트 판정하는 식입니다.</p>
<p><img decoding="async" loading="lazy" alt="lag-compenstion-graph-shooting" src="https://yongseongkim.github.io/assets/images/lag-compenstion-graph-shooting-da894b1a8e62c0c2e8e0030f6ce7088b.png" width="1826" height="1058" class="img_ev3q"></p>
<p>출처: <a href="https://youtu.be/j3eQNm-Wk04" target="_blank" rel="noopener noreferrer">[NDC] CAP 이론을 통한 네트워크 동기화 기법</a></p>
<p>클라이언트는 과거 서버의 상태를 보여주기 때문에 타격이 실행된 시점과 현 시점의 상대방의 위치는 다를 수 있습니다.</p>
<p><img decoding="async" loading="lazy" alt="lag-compenstion-graph-shooting-rewind" src="https://yongseongkim.github.io/assets/images/lag-compenstion-graph-shooting-rewind-ca6e0b556941b55cf2927321fa71d139.png" width="1826" height="1058" class="img_ev3q"></p>
<p>출처: <a href="https://youtu.be/j3eQNm-Wk04" target="_blank" rel="noopener noreferrer">[NDC] CAP 이론을 통한 네트워크 동기화 기법</a></p>
<p>서버는 클라이언트의 지연을 고려해서 클라이언트가 보던 과거의 시점으로 상황을 돌려 판정합니다.</p>
<ol>
<li>클라이언트가 입력을 받아 시뮬레이션도 처리. 결과를 서버에 전달.</li>
<li>서버가 해당 패킷을 받으면 클라이언트의 입력 처리 시점으로 되돌린다. 클라이언트에서 보내준 결과 = 서버에서 시뮬레이션한 결과가 같으면 OK, 다르면 동기화 깨졌다고 클라이언트에 알려준다.</li>
<li>서버에서 처리한 결과를 클라이언트에서 보정.</li>
</ol>
<p>재보정 로직은 FPS 게임에서 이미 많이 쓰이고 있습니다.
리그오브레전드에서도 일부 적용되어 있는 걸 볼 수 있는데, 게임하는 도중 랜선을 뽑아보면 틱당 골드가 증가하다가 1초 정도 지나면 멈추거나 롤백되는 걸 볼 수 있다고 합니다.
위 재보정으로 피격자가 엄폐물 뒤로 숨었는데 피격될 수 있기 때문에 플레이어의 불쾌감을 어느 정도 감안하고 재구성합니다.
일반적으로 FPS 는 공격의 횟수가 피격의 횟수보다 절대적으로 많기 때문에, 현대 FPS 게임은 총 쏘는 사람 입장을 더 쾌적하게 하는 것을 주로 선택한다고 합니다.
게임 필드 전체를 되감기 하는 것이 아니라 관련 있는 플레이어들만 되감습니다.
되감기를 위해 상태를 어느 정도 길이로 저장할거냐에 대한 문제도 있습니다. 서버 - 클라이언트 간 최대 레이턴시 안에서 결정할 수 있습니다.</p>
<h1>Closing</h1>
<p>게임 개발에서 서버 - 클라이언트 간의 동기화를 위한 다양한 기술들을 알아봤습니다.
위에 언급한 이슈 외에도 다양한 이슈가 있습니다.
스타크래프트와 같이 클라이언트에서 이벤트를 시뮬레이션하는 경우 랜덤의 요소가 존재한다면 문제가 될 수 있습니다.
예를 들어 마린 데미지가 6 - 10 인데 히드라의 피가 8 남았다고 했을 때, 어떤 클라이언트에서는 죽고 어떤 클라이언트에서는 안죽는 상황이 발생할 수 있습니다.
이런 경우 동기화가 되는 서버 프레임을 Seed 로 써서 같은 난수 값이 나오게 하여 같은 결과를 얻게 만들 수 있습니다.
또한 같은 물리 계산식이라도 머신마다 부동소수점이 달라질 수 있습니다. 최적화 방식이 컴파일러마다 다르고 CPU 마다 다르기 때문에 크로스 플랫폼 멀티플레이 게임 제작 시 주의 필요가 필요합니다.</p>
<h1>Reference</h1>
<ul>
<li><a href="https://www.gabrielgambetta.com/client-server-game-architecture.html" target="_blank" rel="noopener noreferrer">Fast-Paced Multiplayer Series</a></li>
<li><a href="https://noti.st/eiaserinnys/jCpSbp" target="_blank" rel="noopener noreferrer">네트웍 동기화 개론과 고급 동기화 기법</a></li>
<li><a href="https://developer.valvesoftware.com/wiki/Source_Multiplayer_Networking#Lag_compensation" target="_blank" rel="noopener noreferrer">ValveSofteware Wiki - LagCompensation</a></li>
<li><a href="https://youtu.be/r4ZaolMQOzE" target="_blank" rel="noopener noreferrer">[NDC] 〈카트라이더〉 0.001초 차이의 승부 - 300km/h 물체의 네트워크 동기화 모델 구현기</a></li>
<li><a href="https://youtu.be/j3eQNm-Wk04" target="_blank" rel="noopener noreferrer">[NDC] CAP 이론을 통한 네트워크 동기화 기법</a></li>
<li><a href="https://youtu.be/W3aieHjyNvw" target="_blank" rel="noopener noreferrer">Overwatch Gameplay Architecture and Netcode</a></li>
<li><a href="https://blog.naver.com/linegamedev/221060368580" target="_blank" rel="noopener noreferrer">멀티플레이 게임의 동기화 기법 시리즈 1편: 시간 동기화</a></li>
<li><a href="https://blog.naver.com/linegamedev/221061964789" target="_blank" rel="noopener noreferrer">멀티플레이 게임의 동기화 기법 시리즈 2편: 이벤트 동기화</a></li>
</ul>]]></content>
        <category label="game" term="game"/>
        <category label="synchronization" term="synchronization"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[UILabel Alignment]]></title>
        <id>https://yongseongkim.github.io/blog/2021/09/25/uilabel-alignment/</id>
        <link href="https://yongseongkim.github.io/blog/2021/09/25/uilabel-alignment/"/>
        <updated>2021-09-25T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[디자이너 분들과 일할 때 AutoLayout Constraint 를 제대로 걸었음에도 "중앙정렬이 안맞는 것 같아요. 여기 텍스트 정렬이 어색해요" 와 같은 얘기를 들을 때가 종종 있었습니다.]]></summary>
        <content type="html"><![CDATA[<p>디자이너 분들과 일할 때 AutoLayout Constraint 를 제대로 걸었음에도 "중앙정렬이 안맞는 것 같아요. 여기 텍스트 정렬이 어색해요" 와 같은 얘기를 들을 때가 종종 있었습니다.
실제로 UILabel 은 지정한 Font 크기보다 크게 잡히며 중앙정렬이 안되어 있는 것처럼 보였습니다.
이와 관련해서 왜 더 크게 잡히는지, 정렬이 어떤 식으로 동작하는지, Font 가 Label 에 어떤 영향을 미치는지 간단한 용어와 개념부터 소개하겠습니다.</p>
<p>정렬이 왜 이상한지를 설명하기에 앞서 먼저 용어를 알고 갈 필요가 있습니다. 아래 보이는 이미지는 애플 문서 Font Handling 에 있는 이미지로 글자를 그릴 때 필요한 선들을 나타냅니다.</p>
<p><img decoding="async" loading="lazy" alt="typography-terminology" src="https://yongseongkim.github.io/assets/images/typography-terminology-35e202052c0db5cc150d2837e7db069c.png" width="1596" height="899" class="img_ev3q"></p>
<p>출처: <a href="https://developer.apple.com/library/archive/documentation/TextFonts/Conceptual/CocoaTextArchitecture/FontHandling/FontHandling.html" target="_blank" rel="noopener noreferrer">Apple Font Handling</a></p>
<p>많은 용어들이 있음에도 이 글에서 필요한 <code>Baseline</code>, <code>Ascent(Ascender)</code>, <code>Descent(Descender)</code>, <code>CapHeight</code>, <code>x-Height</code>, <code>LineHeight</code>, <code>Leading(Line gap)</code> 정도만 알면 됩니다.</p>
<p><img decoding="async" loading="lazy" alt="typography-terminology-list" src="https://yongseongkim.github.io/assets/images/typography-terminology-list-e55cbcee3604a4ac18d12a6f9d5a2f7c.png" width="468" height="1024" class="img_ev3q"></p>
<p>출처: <a href="https://www.rightpoint.com/rplabs/ios-tracking-typography" target="_blank" rel="noopener noreferrer">iOS Tracking Typography</a></p>
<p>먼저 <code>Baseline</code> 은 문자가 서있는 보이지 않는 선입니다. 이 선을 기준으로 문자들을 만듭니다.
<code>Ascent(Ascender)</code> 는 Baseline 으로부터 문자의 가장 윗 부분까지 거리를 나타냅니다.
<code>Descent(Descender</code> 는 Baseline 으로부터 문자의 가장 아랫 부분까지 거리를 나타냅니다. 여기서 줄간격 <code>Leading</code>은 포함하지 않습니다.
<code>CapHeight</code> 는 basline 으로부터 대문자가 차지하는 높이, <code>x-Height</code> 는 baseline 으로부터 소문자 x 가 차지하는 높이입니다.
<code>LineHeight</code> 는 한 줄이 차지하는 높이를 말하며, 애플 문서에 있는 그림은 줄간격 <code>Leading</code> 을 포함하고 있습니다.
허나 실제로 iOS 개발에서는 포함되지 않습니다. 그래서 <code>LineHeight</code> 는 <code>Ascent</code> + <code>Descent</code> 의 합이 됩니다.</p>
<p><a href="https://medium.com/mobimeo-technology/what-if-your-designers-want-a-baseline-grid-on-ios-d5234c7b52c0" target="_blank" rel="noopener noreferrer">What If Your Designers Want a Baseline Grid on iOS?</a> 글을 참조하여 여러 TextStyle 의 정보를 출력하면 <code>LineHeight</code> 에 <code>Leading</code> 이 포함되지 않는 걸 알 수 있습니다.
예를 들어 Title 이 lineHeight: 71.6015625, ascender: 57.12890625, descender: -14.47265625, leading: -1.6015624999999956 와 같이 나오면서 lineHeight = ascender + descender 임을 알 수 있습니다.</p>
<h1>Alignment Examples</h1>
<p>위에서 정의한 개념들을 통해 몇몇 문제가 되는 정렬들을 살펴보고 해결해보려 합니다.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="baseline-offset">Baseline Offset<a href="https://yongseongkim.github.io/blog/2021/09/25/uilabel-alignment/#baseline-offset" class="hash-link" aria-label="Direct link to Baseline Offset" title="Direct link to Baseline Offset">​</a></h2>
<p>몇몇 사람들은 디자인의 90%가 타이포그래피 라고 합니다. 그만큼 사람들한테 글을 잘 읽히게 하려면 줄 간격도 중요합니다.
그래서 많은 디자이너 분들이 lineHeight 를 수정하여 가독성을 좋게 만드려고 노력합니다.</p>
<div class="language-swift codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-swift codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> style </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">NSMutableParagraphStyle</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">style</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">maximumLineHeight </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> lineHeight</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">style</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">minimumLineHeight </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> lineHeight</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> attributes</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token class-name">NSAttributedString</span><span class="token punctuation" style="color:#393A34">.</span><span class="token class-name">Key</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Any</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">paragraphStyle</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> style</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> attrString </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">NSAttributedString</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">string</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> text</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> attributes</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> attributes</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">attributedText </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> attrString</span><br></span></code></pre></div></div>
<p>iOS 에서는 위와 같이 코드를 작성하여 원하는 lineHeight 를 설정할 수 있습니다.</p>
<p><img decoding="async" loading="lazy" alt="loren-ipsum-custom-line-height" src="https://yongseongkim.github.io/assets/images/loren-ipsum-custom-line-height-1970556bc67bcef53e21cce9675df3c7.png" width="2262" height="368" class="img_ev3q"></p>
<p>출처: <a href="https://www.belkadigital.com/articles/uilabel-line-height-in-swift" target="_blank" rel="noopener noreferrer">UILabel line height in Swift</a></p>
<p>근데 위 이미지와 같이 문자들이 중앙정렬 되는 게 아니라 아랫부분에 붙어 있어서 예상치 못하게 상단 부분이 비어 보일 수 있습니다.
여러 줄의 UILabel 을 화면 중앙에 정렬해도 상단이 비어보이면서 중앙 정렬이 아닌 것처럼 보일 수 있습니다.</p>
<div class="language-swift codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-swift codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// 출처: https://stackoverflow.com/questions/19487369/center-two-fonts-with-different-different-sizes-vertically-in-an-nsattributedstr</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> smallStr </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string-literal string" style="color:#e3116c">"Hello"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> bigStr </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string-literal string" style="color:#e3116c">"World"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> fullStr </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">NSMutableAttributedString</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">string</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string-literal string" style="color:#e3116c">"</span><span class="token string-literal interpolation-punctuation punctuation" style="color:#393A34">\(</span><span class="token string-literal interpolation">smallStr</span><span class="token string-literal interpolation-punctuation punctuation" style="color:#393A34">)</span><span class="token string-literal string" style="color:#e3116c"> </span><span class="token string-literal interpolation-punctuation punctuation" style="color:#393A34">\(</span><span class="token string-literal interpolation">bigStr</span><span class="token string-literal interpolation-punctuation punctuation" style="color:#393A34">)</span><span class="token string-literal string" style="color:#e3116c">"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> smallStrRange </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">NSMakeRange</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> smallStr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">count</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> bigStrRange </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">NSMakeRange</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">smallStr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">count </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> bigStr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">count</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fullStr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">addAttributes</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">[</span><span class="token class-name">NSAttributedString</span><span class="token punctuation" style="color:#393A34">.</span><span class="token class-name">Key</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">font</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">UIFont</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">systemFont</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ofSize</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">28</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> range</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> smallStrRange</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fullStr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">addAttributes</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">[</span><span class="token class-name">NSAttributedString</span><span class="token punctuation" style="color:#393A34">.</span><span class="token class-name">Key</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">font</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">UIFont</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">systemFont</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ofSize</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">42</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> range</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> bigStrRange</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<p>또 다른 상황으로 NSAttributedText 에 다른 Font 크기를 지정하면 baseline 을 기준으로 정렬됩니다.</p>
<p><img decoding="async" loading="lazy" alt="hello-world-alignment" src="https://yongseongkim.github.io/assets/images/hello-world-alignment-265440e2e03b4d97f61aeb0fcc0e241a.png" width="917" height="106" class="img_ev3q"></p>
<p>출처: <a href="https://www.belkadigital.com/articles/uilabel-line-height-in-swift" target="_blank" rel="noopener noreferrer">UILabel line height in Swift</a></p>
<p>왼쪽 이미지가 아닌 오른쪽 이미지처럼 중앙 정렬을 원하는 경우는 어떻게 해야 할까요?</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="solution---baselineoffset">Solution - baselineOffset<a href="https://yongseongkim.github.io/blog/2021/09/25/uilabel-alignment/#solution---baselineoffset" class="hash-link" aria-label="Direct link to Solution - baselineOffset" title="Direct link to Solution - baselineOffset">​</a></h3>
<p>위와 같은 문제들을 NSAttributedString 의 baselineOffset 설정으로 해결할 수 있습니다. 문자들을 Baseline 으로부터 간격을 주어서 중앙에 정렬하는 것처럼 보이게 합니다.</p>
<p><img decoding="async" loading="lazy" alt="shy-difference-between-lineheight-fontsize" src="https://yongseongkim.github.io/assets/images/shy-difference-between-lineheight-fontsize-4f92032f6151a577f1b5136234cc575f.png" width="448" height="251" class="img_ev3q"></p>
<p>출처: <a href="https://www.belkadigital.com/articles/uilabel-line-height-in-swift" target="_blank" rel="noopener noreferrer">UILabel line height in Swift</a></p>
<p>baseline offset 은 Baseline 으로 부터 얼마나 떨어져 있는 지를 나타냅니다. 설정한 lineHeight 에서 Font 크기를 빼고 나누기 2 한 값을 offset 으로 설정하면 될 것 같습니다.</p>
<div class="language-swift codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-swift codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// offset 을 (custom line height - font.lineHeight) / 2 로 줘야 할 것 같지만</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// (custom line height - font.lineHeight) / 4 를 줘야 중앙에 배치한다.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> attributes</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token class-name">NSAttributedString</span><span class="token punctuation" style="color:#393A34">.</span><span class="token class-name">Key</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Any</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">paragraphStyle</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> style</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">baselineOffset</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">lineHeight </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> font</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">lineHeight</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">/</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">4</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">]</span><br></span></code></pre></div></div>
<p>하지만 실제로는 나누기 2 가 아닌 나누기 4 를 해야 중앙 정렬이 됩니다. (내부적으로 scale 계산을 하는 건지, 여러 블로그글을 참고했으나 아직까지 정확한 사유를 파악하지 못했습니다.)</p>
<p><img decoding="async" loading="lazy" alt="loren-ipsum-custom-line-height-with-baseline-offset" src="https://yongseongkim.github.io/assets/images/loren-ipsum-custom-line-height-with-baseline-offset-4efeafb1dbbe99c6f215467679a9a2b1.png" width="2554" height="496" class="img_ev3q"></p>
<p>출처: <a href="https://www.belkadigital.com/articles/uilabel-line-height-in-swift" target="_blank" rel="noopener noreferrer">UILabel line height in Swift</a></p>
<ul>
<li>첫번째 이미지는 baselineOffset 을 적용하기 전,</li>
<li>두번째 이미지는 baselineOffset 을 <code>(lineHeight - font.lineHeight) / 4</code> 으로 적용한 상황</li>
<li>세번째 이미지는 baselineOffset 을 <code>(lineHeight - font.lineHeight) / 4</code> 을 적용하고 <code>(lineHeight - font.lineHeight) / 2</code> 를 이용하여 빨간 선을 그려주었습니다.</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="capheight-alignment">CapHeight Alignment<a href="https://yongseongkim.github.io/blog/2021/09/25/uilabel-alignment/#capheight-alignment" class="hash-link" aria-label="Direct link to CapHeight Alignment" title="Direct link to CapHeight Alignment">​</a></h2>
<p>다음은 Font 크기가 다른 두 UILabel 을 상단으로 맞추는 경우 입니다.</p>
<p><img decoding="async" loading="lazy" alt="twenty-five-minute-top-alignment" src="https://yongseongkim.github.io/assets/images/twenty-five-minute-top-alignment-b6b64a98324eb57f0d64b6f27a8b552e.png" width="988" height="244" class="img_ev3q"></p>
<p>Font 크기가 다른 두 UILabel 상단을 맞췄음에도 불구하고 왼쪽 이미지처럼 실제로 보이는 글자 정렬은 이상해보입니다.
오른쪽 처럼 이쁘게 정렬되게 하려면 어떻게 해야 할까요?</p>
<p><img decoding="async" loading="lazy" alt="twenty-five-minute-alignment-with-redline" src="https://yongseongkim.github.io/assets/images/twenty-five-minute-alignment-with-redline-28e5ce7908e0d2cfab4952cfb2912129.png" width="600" height="188" class="img_ev3q"></p>
<p>출처: <a href="https://www.rightpoint.com/rplabs/ios-tracking-typography" target="_blank" rel="noopener noreferrer">iOS Tracking Typography</a></p>
<p>왼쪽 이미지 처럼 UILabel 의 상단을 맞추는 것이 아닌 CapHeight 선을 맞추면 오른쪽 그림처럼 깔끔하게 해결할 수 있습니다.</p>
<div class="language-swift codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-swift codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// 두 UILabel 의 상단에 있는 빈공간의 차를 `Minute` UILabel top constraint 값으로 넣어준다.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">minuteLabelTopConstraint</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">constant </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">twentyFiveLabel</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">font</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ascender </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> twentyFiveLabel</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">font</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">capHeight</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">minuteLabel</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">font</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ascender </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> minuteLabel</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">font</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">capHeight</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<p>가장 쉬운 구현으로는 위 코드 처럼 두 UILabel 의 상단을 맞추던 AutoLayout Constraint 에 (Ascender - CapHeight) 차이를 설정하는 방법이 있습니다.</p>
<div class="language-swift codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-swift codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// 출처: https://www.atimi.com/cap-height-alignment-for-ios-auto-layout/</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// View "top alignment" 의 정의를 바꾼다. cap height 를 이용하여 쉽게 해결할 수 있다.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">override</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> alignmentRectInsets</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">UIEdgeInsets</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> insets </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">UIEdgeInsets</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">zero</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> alignCapHeight </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        insets</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">top </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">round</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">font</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ascender </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> font</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">capHeight</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> insets</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// Boolean 을 정의하여 사용자가 쉽게 껐다켰다 할 수 있게 개발할 수 있다.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> alignCapHeight</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">Bool</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">didSet</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// As the alignment method is only called during layout,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// We also need to ensure that Auto Layout is rerun whenever the property changes.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">setNeedsUpdateConstraints</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p>다른 방법으로는 UIView 의 <code>alignmentRectInsets</code> 값을 이용하는 방법입니다.
값을 override 하면서 View 내부에서 top 에 대한 정의를 바꿉니다.</p>
<p><img decoding="async" loading="lazy" alt="alignment-rect-insets-example" src="https://yongseongkim.github.io/assets/images/alignment-rect-insets-example-675eb963db0c38a6bb473bd09bba159d.png" width="800" height="162" class="img_ev3q"></p>
<p>위 이미지는 <code>alignmentRectInsets</code> 를 덮어쓰는 <code>CapAlignmentLabel</code> 를 정의하여 비교해본 결과입니다.
왼쪽 이미지는 스토리보드에서의 프리뷰이며 오른쪽 이미지는 실제로 디바이스에서 작동한 결과입니다.
연한 초록색이 <code>CapAlignmentLabel</code> 영역을 나타냅니다.
파란색 View 밑에 25 가 써진 <code>CapAlignmentLabel</code> 를 붙인 후 양 옆에 Label 들을 25 가 써진 <code>CapAlignmentLabel</code> 상단에 맞췄습니다.
<code>font.ascender - font.capHeight</code> 만큼 텍스트가 위로 올라간 걸 볼 수 있습니다.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="more-accurate-capheight">More Accurate CapHeight<a href="https://yongseongkim.github.io/blog/2021/09/25/uilabel-alignment/#more-accurate-capheight" class="hash-link" aria-label="Direct link to More Accurate CapHeight" title="Direct link to More Accurate CapHeight">​</a></h3>
<p>좀 더 정확한 위치를 잡기 위해서는 실제로 Text 가 UILabel 에서 어떻게 그려지는 지 파악해 볼 필요가 있습니다.
Helvetica Font 24pt 는 lineHeight 27.6, ascender 22.08, descender -5.52, capHeight 17.27 값을 가집니다.
iOS 에서는 실제로 Text 를 그릴 때 이러한 Fractional part(pxiel 영역으로 나눠지지 않는 값들)를 anti-aliasing 을 사용하여 그립니다.</p>
<p><img decoding="async" loading="lazy" alt="label-pixel-boundary-example" src="https://yongseongkim.github.io/assets/images/label-pixel-boundary-example-5c70443ca8af08f9c6c57b3da555e225.png" width="556" height="203" class="img_ev3q"></p>
<p>출처: <a href="https://www.atimi.com/cap-height-alignment-for-ios-auto-layout/" target="_blank" rel="noopener noreferrer">Cap Height Alignment for iOS Auto Layout</a></p>
<p>글자들은 Baseline 위에서 그려지는데, 이 Baseline 은 pixel 영역이라서 Fractional part 를 pixel 영역에 맞게 처리해야 합니다.
근데 여기서 round 를 써서 실제 글자가 차지하는 pixel 보다 작아지면 잘릴 수도 있으니 ceil 을 이용하여 한 픽셀 정도 넉넉하게 잡아줍니다.</p>
<div class="language-swift codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-swift codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// ceil(lineHeight) = ceil(ascender) + ceil(descender) 는 항상 성립하지 않는다.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 일반적으로, 많은 글자들이 descender 에 우선순위를 가진다. 그래서 `ceil(lineHeight) – ceil(-descender) – round(capHeight)` 계산식을 이용한다.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">override</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> alignmentRectInsets</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">UIEdgeInsets</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> insets </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">UIEdgeInsets</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">zero</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// rounding 은 pixel boundary 에서 발생하므로 정확한 계산을 위해 screen scaling 을 고려한다.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> alignCapHeight</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> scale </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> window</span><span class="token operator" style="color:#393A34">?</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">screen</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">scale </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        insets</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">top </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token function" style="color:#d73a49">ceil</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">font</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">lineHeight </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> scale</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            – </span><span class="token function" style="color:#d73a49">ceil</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">font</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">descender </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> scale</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            – </span><span class="token function" style="color:#d73a49">round</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">font</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">capHeight </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> scale</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">/</span><span class="token plain"> scale</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> insets</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="baseline-alignment">Baseline Alignment<a href="https://yongseongkim.github.io/blog/2021/09/25/uilabel-alignment/#baseline-alignment" class="hash-link" aria-label="Direct link to Baseline Alignment" title="Direct link to Baseline Alignment">​</a></h2>
<p>또한, iOS 에서 firstBaselineAnchor, lastBaselineAnchor 를 Auto Layout 으로 제공하여 Baseline 에 맞게 정렬할 수 있습니다.</p>
<div class="language-swift codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-swift codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// 출처: https://milyo-codingstories.tistory.com/51</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> baseLabel </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">UILabel</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">baseLabel</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">text </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string-literal string" style="color:#e3116c">"Base Label\nBase Label\nBase Label"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">baseLabel</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">lineBreakMode </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">byWordWrapping</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">baseLabel</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">numberOfLines </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token class-name">NSLayoutConstraint</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">activate</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    baseLabel</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">leadingAnchor</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">constraint</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">equalTo</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> view</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">safeAreaLayoutGuide</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">leadingAnchor</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">constant</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">8</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> newLabel </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">UILabel</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">newLabel</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">text </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string-literal string" style="color:#e3116c">"new"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token class-name">NSLayoutConstraint</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">activate</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    newLabel</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">leadingAnchor</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">constraint</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">equalTo</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> baseLabel</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">trailingAnchor</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">constant</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">8</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Baseline 정렬</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    newLabel</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">topAnchor</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">constraint</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">equalTo</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> baseLabel</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">firstBaselineAnchor</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<p><img decoding="async" loading="lazy" alt="base-label-baselineanchor" src="https://yongseongkim.github.io/assets/images/base-label-baselineanchor-7a3ee4e7a27a863b01d57db79a82634c.png" width="600" height="164" class="img_ev3q"></p>
<p>출처: <a href="https://milyo-codingstories.tistory.com/51" target="_blank" rel="noopener noreferrer">FirstBaseLineNachor &amp; LastBaseLineAnchor</a></p>
<p>"new" Label 상단을 "Base Label" 의 firstBaselineAnchor 에 걸게 되면 왼쪽 이미지와 같이 나타납니다.
오른쪽 이미지는 lastBaselineAnchor 를 이용했습니다.</p>
<h1>Conclusion</h1>
<p>이번 글에서는 Font 에서 쓰이는 간단한 개념들과 그 개념들을 어떻게 이용할 수 있는 지를 정리해봤습니다.
개발을 하면서 이상항 정렬로 Typography 에 대해 공부해봐야겠다고 생각했던 적이 있었는데, 간단한 용어만 알아도 실무에서 요구하는 디자인 문제는 어느 정도 해결할 수 있을 것 같습니다.
가독성을 위해 LineHeight 를 직접 설정하는 경우, Font 크기가 다른 두 Label 을 정렬하는 경우는 꽤 빈번해서 위에서 설명한 개념들을 유용하게 쓸 수 있을 것 같습니다.</p>
<h1>Reference</h1>
<ul>
<li><a href="https://www.atimi.com/cap-height-alignment-for-ios-auto-layout/" target="_blank" rel="noopener noreferrer">Cap height Alignment for iOS Auto Layout</a></li>
<li><a href="https://www.belkadigital.com/articles/uilabel-line-height-in-swift" target="_blank" rel="noopener noreferrer">UILabel line height in Swift</a></li>
<li><a href="https://sujinnaljin.medium.com/swift-label%EC%9D%98-line-height-%EC%84%A4%EC%A0%95-%EB%B0%8F-%EA%B0%80%EC%9A%B4%EB%8D%B0-%EC%A0%95%EB%A0%AC-962f7c6e7512" target="_blank" rel="noopener noreferrer">Label 의 LineHeight 설정 및 가운데 정렬</a></li>
<li><a href="https://www.rightpoint.com/rplabs/ios-tracking-typography" target="_blank" rel="noopener noreferrer">iOS Tracking Typography</a></li>
<li><a href="https://blog.eppz.eu/uilabel-line-height-letter-spacing-and-more-uilabel-typography-extensions/" target="_blank" rel="noopener noreferrer">UILabel line height, letter spacing and more </a></li>
<li><a href="https://medium.com/mobimeo-technology/what-if-your-designers-want-a-baseline-grid-on-ios-d5234c7b52c0" target="_blank" rel="noopener noreferrer">What If Your Designers Want a Baseline Grid on iOS?</a></li>
<li><a href="https://www.figma.com/blog/line-height-changes/" target="_blank" rel="noopener noreferrer">Getting to the bottom of line height in Figma</a></li>
</ul>]]></content>
        <category label="label" term="label"/>
        <category label="alignment" term="alignment"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[How To Open An App By URL]]></title>
        <id>https://yongseongkim.github.io/blog/2021/06/25/how-to-open-app-by-url/</id>
        <link href="https://yongseongkim.github.io/blog/2021/06/25/how-to-open-app-by-url/"/>
        <updated>2021-06-25T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[Question About Deeplink]]></summary>
        <content type="html"><![CDATA[<p><img decoding="async" loading="lazy" alt="Question About Deeplink" src="https://yongseongkim.github.io/assets/images/question_about_deeplink-ee3d60e13c39714a0b9e08fa4108becb.jpg" width="1143" height="222" class="img_ev3q">
최근에 서비스에서 중요한 기능을 개발하면서 해당 화면으로 사람들을 유도할 수 있는 링크에 대한 질문을 많이 받았습니다.
이와 관련된 답변을 준비하다 보니 url 을 통해 어떻게 설치되어 있으면 앱을 열고 설치되어 있지 않은 앱들은 앱스토어로 보내는 지에 대한 이해가 부족하다고 느꼈습니다.
관련된 3rd party 서비스 <a href="https://branch.io/" target="_blank" rel="noopener noreferrer">Branch</a> 가 어떤 기능들을 제공해주는지에 대한 이해도 필요했습니다.
관련된 기능을 개발해본 적 없는 모바일 개발자 혹은 모바일 플랫폼에 대한 이해도가 부족한 서버 개발자분들의 이해를 돕고자 간단하게 정리했습니다. 설명은 iOS 중심으로 정리되어 있습니다.</p>
<p>"탑승내역을 보여주는 화면으로 보내는 딥링크가 뭐에요?" 와 같이 공지사항 혹은 여러 마케팅 이벤트를 통해 사용자를 특정 화면으로 유도하려는 노력을 많이 합니다.
이와 같이 딥링크란 사용자를 도메인 내의 어떤 곳으로 안내하는 링크를 말합니다.</p>
<ul>
<li><a href="https://nytimes.com/" target="_blank" rel="noopener noreferrer">https://nytimes.com</a> 는 최상위 도메인으로 도메인 내 더 깊은 곳으로 안내하지 않기 때문에 딥링크가 아닙니다.</li>
<li><a href="https://www.hbe.io/about" target="_blank" rel="noopener noreferrer">https://www.hbe.io/about</a> 는 도메인 내 상세정보에 해당하는 about 페이지, 특정 화면으로 향하는 딥링크입니다.</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="scheme-path-parameter">Scheme, Path, Parameter<a href="https://yongseongkim.github.io/blog/2021/06/25/how-to-open-app-by-url/#scheme-path-parameter" class="hash-link" aria-label="Direct link to Scheme, Path, Parameter" title="Direct link to Scheme, Path, Parameter">​</a></h2>
<p>URL(Uniform Resource Locator) 은 <code>scheme://host:port/path?query</code> 의 형태로 리소스에 대한 위치를 나타냅니다.
모바일 플랫폼에서 각 서비스는 자신들의 앱을 띄울 수 있는 scheme 을 정의할 수 있습니다. 페이스북은 <code>fb://</code> 를 scheme 으로 쓰고 있어 사파리에서 <code>fb://</code> 와 같이 입력하면 시스템은 입력한 scheme 해당하는 앱(페이스북)을 엽니다.</p>
<p>모바일 개발자들은 custom scheme 으로 정의된 URL 을 통해 사용자를 어떤 화면으로 보내고 어떤 행동을 유도할 지 설계합니다.
예를 들어 메신저로 쿠폰을 선물하여 링크를 눌렀을 때 쿠폰화면을 보여주면서 선물 받은 쿠폰 코드를 자동으로 입력하는 기획이 나왔습니다.
<code>custom-app-scheme://coupons?code=오픈기념이벤트</code> 로 path 는 쿠폰 화면 이동을, query 로는 쿠폰 코드를 전달하여 사용자 경험을 개선할 수 있습니다.</p>
<div class="language-swift codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-swift codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">switch</span><span class="token plain"> url</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">host</span><span class="token operator" style="color:#393A34">?</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">lowercased</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> </span><span class="token string-literal string" style="color:#e3116c">"coupons"</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> actionableItem</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">ensureLoggedIn</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">onStep </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> mainActionableItem </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">/* 로그인 되었는지 확인하여 메인 화면을 띄운다. */</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">onStep </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> menuActionableItem </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">/* 쿠폰화면을 띄운다 */</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">onStep </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> couponActionableItem </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">/* 입력창에 쿠폰 번호를 채운다. */</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> </span><span class="token string-literal string" style="color:#e3116c">"..."</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">/* Handle cases. */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p>이렇게 개발자들이 정의해놓은 URL 에 대해서만 사용자를 원하는 화면으로 도달하게 할 수 있습니다.
정의되어 있지 않은 경우에는 개발자가 URL 에 대한 처리를 추가하여 앱을 업데이트해야 합니다.
<code>custom-app-scheme://web?url=www.example.com/features</code> 와 같이 웹페이지 띄우는 처리를 정의해놓으면 다양한 이벤트를 유연하게 대응할 수 있습니다.
어떤 앱이 어떤 scheme 을 쓰고 어떤 화면을 띄우는지 파악할 수 있으면 앱을 자유롭게 띄워 정보를 전달하여 사용성을 높일 수 있습니다.
예를 들어 내 위치를 친구에게 공유하고 싶을 때 line://message="" 딥링크를 사용하여 친구에게 바로 메세지를 전달할 수 있게 하면 사용자에게 좀 더 부드러운 경험을 제공할 수 있습니다.</p>
<p>iOS 에서는 <code>UIApplication.shared.canOpenURL</code> 이라는 API 를 이용하여 앱의 설치 유무도 파악할 수 있었습니다. 이 기능을 활용하면 내 앱을 사용하는 사람이 어떤 앱을 설치했는지도 파악할 수 있었습니다.
하지만 iOS 9 부터 개인정보보호를 위해 이런 API 의 사용을 제한합니다. 다른 앱을 띄우려면, 혹은 위와 같이 <code>canOpenURL</code> API 를 이용하려면 whitelist 에 등록해야 합니다.
whitelist 에 등록하지 않은 앱을 띄우려 시도하면 "This app is now allowed to query for scheme xxx" 로그가 찍히며 시스템 API 가 동작하지 않습니다.</p>
<p>또한 정의한 scheme 으로 앱을 여는 과정은 중복을 따로 막지 않았기 때문에 모방하는 앱에 대한 대응도 어려웠습니다.
예를 들어 Reddit 을 모방하는 Redd1t 이 <code>reddit://</code> scheme 을 쓰게 되면 어떤 앱이 뜰지 보장할 수 없는 상태였습니다.
Universal Link 는 URL 진입 시 URL 에 맞는 앱이 설치되어 있으면 앱을 띄우고 설치되어 있지 않다면 브라우저를 띄우는 기능입니다.
예를 들면 링크 <a href="https://www.facebook.com/watch" target="_blank" rel="noopener noreferrer">https://www.facebook.com/watch</a> 클릭 시 페이스북이 설치되어 있으면 페이스북 앱에서 watch 탭으로 이동하고 아니면 페이스북 watch 페이지를 브라우저에서 띄웁니다.
앱이 없으면 그에 대응하는 웹페이지를 볼 수 있으니 앱이 없을 때 아무 동작하지 않는 scheme 처리보다 사용자에게 더 좋은 경험을 줄 수 있다.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="behind-the-scenes">Behind the scenes<a href="https://yongseongkim.github.io/blog/2021/06/25/how-to-open-app-by-url/#behind-the-scenes" class="hash-link" aria-label="Direct link to Behind the scenes" title="Direct link to Behind the scenes">​</a></h2>
<p><img decoding="async" loading="lazy" alt="How to get AASA files from server" src="https://yongseongkim.github.io/assets/images/how-to-get-aasa-from-server-d20cb4bfb36ea3a27e6a46412904e5d6.png" width="900" height="716" class="img_ev3q">
출처: <a href="https://developer.apple.com/videos/play/wwdc2020/10098/" target="_blank" rel="noopener noreferrer">WWDC 2020 What's new in Universal Link</a>
Universal Link 를 활성화 시키기 위해서는 앱에 어떤 도메인을 쓸 것인지 명시해야 합니다.
시스템은 앱을 다운 받아 설치할 때, 등록된 도메인의 AASA 파일을 파싱하여 Universal Link 를 활성화 시킵니다.</p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// AASA JSON Example</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">"applinks"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">"apps"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">"details"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">"appIDs"</span><span class="token operator" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token string" style="color:#e3116c">"A1B2C3D4E5.com.example.app"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token string" style="color:#e3116c">"F1G2H3I4J5.com.example.app"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">"components"</span><span class="token operator" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">"/"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"/*/order/"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">"/"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"/taco/*"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">"?"</span><span class="token operator" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token property" style="color:#36acaa">"cheese"</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">"?*"</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">"#"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"coupon-1???"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">"exclude"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">"/"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">""</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">"#"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"coupon-????"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p>사용자가 앱스토어에서 앱을 다운받아 설치하면 시스템에서 앱에 등록된 도메인의 AASA 파일을 다운, 파싱하여 Universal Link 를 활성화 시킵니다.
시스템은 AASA 의 업데이트 된 내용을 반영하기 위해 주기적으로 AASA 파일을 다운로드 합니다.</p>
<p><img decoding="async" loading="lazy" alt="How to get AASA files from Apple CDN" src="https://yongseongkim.github.io/assets/images/how-to-get-aasa-from-apple-cdn-9a2c16a5e7c8021cdda9d92621af4036.png" width="978" height="722" class="img_ev3q"></p>
<p>"applinks", "apps" 는 템플릿의 형태로 Universal Link 선언이라고 보면 됩니다.</p>
<p>"details" 부분이 어떤 앱을 처리할지, 어떤 경로를 처리할지 명시하는 부분으로 여기서 appID 는 teamID 와 bundleID 의 조합입니다.
예를 들어 <a href="https://tadatada.com/" target="_blank" rel="noopener noreferrer">타다</a>는 bundleID = kr.co.vcnc.tada 이기 때문에 A1B2C3F4D5.kr.co.vcnc.tada 와 같이 appID 를 정의할 수 있습니다.
도메인은 고유하고 어떤 앱이 뜰지 명시되어 있기 때문에 모방하는 서비스가 뜰 일은 없게 됩니다.
(<a href="https://www.skyscanner.co.kr/apple-app-site-association" target="_blank" rel="noopener noreferrer">스카이스캐너 AASA</a> 를 보면 bundleID <code>net.skyscanner.iphone-china</code> 를 보아 중국 쪽 아이폰 앱을 따로 제공하는 걸 볼 수 있습니다.)</p>
<p>"components" 리스트를 처리하는 부분을 하나씩 보면, "/*/order/" 는 2번째 order 들어오는 모든 path 를 처리합니다.
예를 들면 <a href="https://example.com/taco/order/" target="_blank" rel="noopener noreferrer">https://example.com/taco/order/</a>, <a href="https://example.com/salad/order/" target="_blank" rel="noopener noreferrer">https://example.com/salad/order/</a> 는 앱이 설치되어 있으면 앱을 띄웁니다.</p>
<p>예를 들어 <a href="https://example.com/#coupon-1234" target="_blank" rel="noopener noreferrer">https://example.com#coupon-1234</a> 와 달리 <a href="https://example.com/#coupon-5678" target="_blank" rel="noopener noreferrer">https://example.com#coupon-5678</a> 는 universal link 처리됩니다.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="branch-quick-links">Branch Quick Links<a href="https://yongseongkim.github.io/blog/2021/06/25/how-to-open-app-by-url/#branch-quick-links" class="hash-link" aria-label="Direct link to Branch Quick Links" title="Direct link to Branch Quick Links">​</a></h2>
<p>링크 설정에서는 사용자가 앱이 설치되어 있지 않았을 때 어디로 보낼지 정할 수 있습니다. 보통 모바일 플랫폼에서는 해당 스토어로 보내고 PC 에서 링크를 접속했을 때는 대표 홈페이지로 이동합니다.</p>
<p>AASA 파일에 exclude 옵션을 이용하여 <code>/e/*</code> 를 제외시키도록 등록해놓고 <a href="https://tadatada.test-app.link/e/6us6DGSmg3" target="_blank" rel="noopener noreferrer">https://tadatada.test-app.link/e/6us6DGSmg3</a> 처럼 바꿔 Universal Link 가 동작하지 않게 합니다.
<img decoding="async" loading="lazy" alt="Branch Quick Links Link Data" src="https://yongseongkim.github.io/assets/images/branch_quick_links_link_data-96468f22be4d17d83f4b586704deeaa8.png" width="2032" height="346" class="img_ev3q">
Link Data 설정에서는 <code>$deeplink_path</code> 를 이용하여 사용자를 어디로 보낼지 명시할 수 있습니다.</p>
<p>위에서 <a href="https://tadatada.test-app.link/6us6DGSmg3" target="_blank" rel="noopener noreferrer">https://tadatada.test-app.link/6us6DGSmg3</a> 링크를 만들어 앱이 설치되어 있는 경우에는 쿠폰함으로, 앱이 설치되어 있지 않은 경우에는 앱스토어로 이동하게 설정하였습니다.</p>
<p>앱 개발자는 앱이 어떤 URL 을 통해서 열렸는지 처리할 수 있습니다.
Branch SDK 에게 앱 관련된 이벤트를 알려주면 해당 URL 에 맞는 정보들을 내려주고 앱 개발자는 그 정보에 맞춰 사용자를 원하는 화면으로 이동시킵니다.</p>
<div class="language-js codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-js codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token dom variable" style="color:#36acaa">window</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method-variable function-variable method function property-access" style="color:#d73a49">onload</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token dom variable" style="color:#36acaa">window</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">top</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">location</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">validateProtocol</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">"tada-rider://coupons?link_click_id=933889898695179390"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">setTimeout</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">timeout</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token dom variable" style="color:#36acaa">document</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">webkitHidden</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">||</span><span class="token plain"> </span><span class="token dom variable" style="color:#36acaa">document</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">hidden</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 유효한 링크, 버전 체크한 후 다른 페이지로 이동한다.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">isSafari12Dot3OrGreater</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token dom variable" style="color:#36acaa">window</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">confirm</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"Open in App Store?"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token dom variable" style="color:#36acaa">window</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">top</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">location</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">validateProtocol</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token string" style="color:#e3116c">"https://tadatada-alternate.test-app.link/6us6DGSmg3?__branch_flow_type=viewapp&amp;__branch_flow_id=933889898728733824&amp;_t=933889898695179390"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#00009f">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token dom variable" style="color:#36acaa">window</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">top</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">location</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">validateProtocol</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">"https://tadatada-alternate.test-app.link/6us6DGSmg3?__branch_flow_type=viewapp&amp;__branch_flow_id=933889898728733824&amp;_t=933889898695179390"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">250</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre></div></div>
<p>자바스크립트는 URL 이 유효한지 파악하고 잠시 후 <a href="https://tadatada-alternate.test-app.link/6us6DGSmg3?__branch_flo" target="_blank" rel="noopener noreferrer">https://tadatada-alternate.test-app.link/6us6DGSmg3?__branch_flo</a>... 로 이동시킵니다.
Redirect 된 URL 에서 파라미터들은 사용자가 어떤 경로로 유입됐는지 파악하기 위한 값으로 추정됩니다. Redirect 된 URL 은 사용자를 다시 앱스토어로 이동시킵니다.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">curl</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token parameter variable" style="color:#36acaa">-i</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --user-agent </span><span class="token string" style="color:#e3116c">"Mozilla/5.0 (iPhone; CPU iPhone OS 12_2 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Mobile/15E148"</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  https://tadatada-alternate.test-app.link/6us6DGSmg3</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain">?__branch_flow_type</span><span class="token punctuation" style="color:#393A34">\</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">viewapp</span><span class="token punctuation" style="color:#393A34">\</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">__branch_flow_id</span><span class="token punctuation" style="color:#393A34">\</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">.</span><span class="token punctuation" style="color:#393A34">\</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">_t</span><span class="token punctuation" style="color:#393A34">\</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># HTTP/2 307</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># location: itms-apps://apps.apple.com/app/id1422751774</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># server: openresty</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># date: Fri, 18 Jun 2021 05:57:09 GMT</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># x-powered-by: Express</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># set-cookie: _s=BWZNsu%2Buq5%2FpiBuSvq%2BnG4sHM4PMjC9uHvkp3nVZoXCqsJFF0keX%2BDLaMDCVWt5b; Max-Age=31536000; Domain=.test-app.link; Path=/; Expires=Sat, 18 Jun 2022 05:57:09 GMT</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># x-cache: Miss from cloudfront</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># via: 1.1 6417e2f7bfaa7aa3312c9889248048c4.cloudfront.net (CloudFront)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># x-amz-cf-pop: ICN54-C3</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># x-amz-cf-id: dRzKRp0aI0dyjdjbLIUkfO05plWxKYyRbkuIWXHOvOGpj4lDSCha1w==</span><br></span></code></pre></div></div>
<p><a href="https://tadatada.test-app.link/6us6DGSmg3" target="_blank" rel="noopener noreferrer">https://tadatada.test-app.link/6us6DGSmg3</a> 를 PC 에서 접속하면 설정해놓은 대표 홈페이지로 바로 이동시킵니다.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">curl</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token parameter variable" style="color:#36acaa">-i</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --user-agent </span><span class="token string" style="color:#e3116c">"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.106 Safari/537.36"</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  https://tadatada.test-app.link/6us6DGSmg3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># HTTP/2 307</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># location: https://tadatada.com/?_branch_match_id=940263651360554710&amp;utm_medium=marketing</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># server: openresty</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># date: Fri, 18 Jun 2021 05:52:36 GMT</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># x-powered-by: Express</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># set-cookie: _s=M1lGlTim6AxpMnxz8MbAf9xPim3iWchdngQ5h3bxIiHwbjKbSHV%2BhaQxl%2FvWA%2B8E; Max-Age=31536000; Domain=.test-app.link; Path=/; Expires=Mon, 04 Jul 2022 16:02:30 GMT; Secure; SameSite=None</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># last-modified: Sun, 04 Jul 2021 16:02:30 GMT</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># x-cache: Miss from cloudfront</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># via: 1.1 fd68ec93b50a400ce670e5ce6a8134ba.cloudfront.net (CloudFront)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># x-amz-cf-pop: ICN55-C1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># x-amz-cf-id: lL-kCf8mMMKiVID6exN_-vbPgx5T1-I8OaMccsD271DF9uuwx3ywPg==</span><br></span></code></pre></div></div>
<h1>Conclusion</h1>
<p>Universal Link 는 URL 클릭 시 바로 앱으로 진입하거나, 앱이 설치되어 있지 않은 경우 웹페이지를 띄워 사용자에게 더 좋은 경험을 제공합니다.
동작 방식은 거의 동일하며 AASA 파일과 동치되는 JSON 파일을 웹서버에서 제공하면 됩니다. (<a href="https://www.facebook.com/.well-known/assetlinks.json" target="_blank" rel="noopener noreferrer">https://www.facebook.com/.well-known/assetlinks.json</a>, 페이스북 App Links 파일)
그래서 WebView 의 custom user agent 를 일반 포맷과 다른 형태로 설정하고 웹페이지에서 Branch 링크를 사용하면 원하는 방향으로 동작 안할 수 있습니다.</p>
<ul>
<li><a href="https://developer.apple.com/videos/play/wwdc2019/717/" target="_blank" rel="noopener noreferrer">WWDC 2019 What's new in Universal Links</a></li>
<li><a href="https://developer.apple.com/videos/play/wwdc2020/10098/" target="_blank" rel="noopener noreferrer">WWDC 2020 What's new in Universal Links</a></li>
</ul>]]></content>
        <category label="universallink" term="universallink"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[Memory Management in Swift]]></title>
        <id>https://yongseongkim.github.io/blog/2020/06/14/swift-memory-management/</id>
        <link href="https://yongseongkim.github.io/blog/2020/06/14/swift-memory-management/"/>
        <updated>2020-06-14T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[영어 읽는 습관을 기르고 기술적인 내용을 많이 접하기 위해 Medium 글들을 많이 읽으려고 노력합니다.]]></summary>
        <content type="html"><![CDATA[<p>영어 읽는 습관을 기르고 기술적인 내용을 많이 접하기 위해 <a href="https://medium.com/" target="_blank" rel="noopener noreferrer">Medium</a> 글들을 많이 읽으려고 노력합니다.
많은 글들을 접하던 중 <a href="https://medium.com/swlh/can-you-answer-this-simple-swift-question-correctly-3d2836cff7b1" target="_blank" rel="noopener noreferrer">Can You Answer This Simple Swift Question Correctly?</a> 글을 읽었는데
Closure 안에서 변수 접근에 대한 질문에 많은 사람들이 제대로 답을 하지 못했다 라고 합니다.
평소에 중요하게 생각했던 부분이었고 면접 준비를 위해 정리하기로 했습니다.</p>
<p>아래 질문들에 답변을 할 수 있다면 내용은 읽을 필요 없습니다 :)</p>
<div class="language-swift codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-swift codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// Question 1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> variable </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string-literal string" style="color:#e3116c">"Value before defining closure"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> closure </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">variable</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">variable </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string-literal string" style="color:#e3116c">"Value after defining closure"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">closure</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// ?</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// Question 2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> variable </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string-literal string" style="color:#e3116c">"Value before defining closure"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> closure </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">variable</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">variable</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">variable </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string-literal string" style="color:#e3116c">"Value after defining closure"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">closure</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// ?</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// Question 3</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">Object</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">String</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">init</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">String</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">name </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> obj </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">Object</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string-literal string" style="color:#e3116c">"Value before defining closure"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> closure </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">obj</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">obj</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">name</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">obj</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">name </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string-literal string" style="color:#e3116c">"Value after defining closure"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">closure</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// ?</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// Question 4</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function-definition function" style="color:#d73a49">makeIncrementer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">forIncrement amount</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">Int</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token class-name">Int</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> runningTotal </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function-definition function" style="color:#d73a49">incrementer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token class-name">Int</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        runningTotal </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> amount</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> runningTotal</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> incrementer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> incrementByTen </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">makeIncrementer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">forIncrement</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">10</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">incrementByTen</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// returns ?</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">incrementByTen</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// returns ?</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">incrementByTen</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// returns ?</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> incrementBySeven </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">makeIncrementer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">forIncrement</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">7</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">incrementBySeven</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// returns ?</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">incrementByTen</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// returns ?</span><br></span></code></pre></div></div>
<p>ARC 는 Automatic Reference Counting 의 약자로 자동으로 Reference Count 를 자동으로 관리해주는 방식입니다.
Reference Counting 방식은 Reference 의 갯수를 보고 해당 객체가 필요한지 여부를 판단합니다.
Reference 의 갯수가 0 이면 해당 객체는 필요없다고 판단하여 메모리 해제시키는 방식입니다.
JVM 에서 작동하는 Garbage Collection 은 프로그램 실행 중에 더 이상 필요 없는 객체들을 주기적으로 찾아 메모리 해제시켜 버립니다.
이와 다르게 ARC 는 컴파일 시점에 구문을 분석하여 적절하게 Reference Counting 코드를 삽입하여 메모리 할당, 해제를 합니다.
원래 iOS 4 전에는 Objective-C 코드로 <code>alloc</code>, <code>new</code>, <code>retain</code> <code>release</code> 등 직접 코드로 작성하여 메모리 할당, 해제 했습니다.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="how-reference-counting-works">How Reference Counting Works<a href="https://yongseongkim.github.io/blog/2020/06/14/swift-memory-management/#how-reference-counting-works" class="hash-link" aria-label="Direct link to How Reference Counting Works" title="Direct link to How Reference Counting Works">​</a></h2>
<div class="language-swift codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-swift codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">Point</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> x</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> y</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">Double</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> point1 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">Point</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> y</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> point2 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> point1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">point2</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">x </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5</span><br></span></code></pre></div></div>
<p><img decoding="async" loading="lazy" alt="How Reference Counting Works" src="https://yongseongkim.github.io/assets/images/how_reference_counting_works-835b927c6f132036a7ae7f8cb1c4e290.png" width="1376" height="590" class="img_ev3q"></p>
<p>출처: <a href="https://developer.apple.com/videos/play/wwdc2016/416/" target="_blank" rel="noopener noreferrer">WWDC 2016 Understanding Swift Performance</a></p>
<p>위 그림에서와 같이 point2 변수가 같은 객체를 가리키면서 reference count 는 2 가 됩니다.
모든 동작이 끝나고 Reference 가 없어지면서 Point 객체는 메모리에서 해제됩니다.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="strong-weak-unowned">Strong, Weak, Unowned<a href="https://yongseongkim.github.io/blog/2020/06/14/swift-memory-management/#strong-weak-unowned" class="hash-link" aria-label="Direct link to Strong, Weak, Unowned" title="Direct link to Strong, Weak, Unowned">​</a></h2>
<p>객체에 대한 모든 Reference 가 Reference Counting 에 영향을 주는 것은 아닙니다.
Weak, Unowned 는 객체의 Reference Count 를 증가시키지 않기 때문에 메모리에서 해제될 수도 있습니다.</p>
<p>Strong Reference 는 위에서 설명한 특성으로 인해 잘못 사용하면 Memory leak 이 발생할 수 있습니다.
필요 없어진 객체가 Reference Count 가 0 이 되지 않아 메모리를 차지하게 되는 상황이죠.
시간이 지나 서비스를 사용할 수록 메모리가 증가하면서 이상하게 동작할 수가 있습니다.</p>
<div class="language-swift codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-swift codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">ObjectA</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> b</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">ObjectB</span><span class="token operator" style="color:#393A34">?</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">ObjectB</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> c</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">ObjectC</span><span class="token operator" style="color:#393A34">?</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">ObjectC</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> b</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">ObjectB</span><span class="token operator" style="color:#393A34">?</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> objA </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">ObjectA</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> objB </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">ObjectB</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> objC </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">ObjectC</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">objA</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">b </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> objB</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">objB</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">c </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> objC</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">objC</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">b </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> objB</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">objA</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">b </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token nil constant" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// ObjectB 에 대한 참조가 끊어져도 Reference Cycle 로 인해 메모리 해제되지 않습니다.</span><br></span></code></pre></div></div>
<p>위 코드의 경우 ObjectA 가 ObjectB 에 대한 reference 를 없애도 ObjectB, ObjectC 서로 가리키고 있습니다.
시간이 지남에 따라 이러한 객체들이 엄청난 메모리를 잡아먹으면서 서비스가 먹통이 될 수 있습니다.</p>
<p>Weak, Unowned Reference 는 Strong Reference 와 달리 Reference Count 를 증가시키지 않습니다.
Weak Reference 는 해당 객체를 Optional 하게 참조합니다. 반면에 Unowned Reference 는 해당 객체가 절대 nil 이 될 수 없다는 가정의 reference 입니다.
Unowned Reference 로 참조한 객체가 메모리 해제됐음에도 접근을 시도하면 에러가 납니다.
Weak Reference 는 참조하고 있는 객체가 메모리 해제된 경우 <code>?</code> 로 접근하기 때문에 에러가 나지 않습니다.
위 예제에서 ObjectB 와 ObjectC 사이에 Weak, Unowned Reference 를 사용하여 Reference Cycle 을 없앨 수 있습니다.</p>
<h1>Reference Type vs. Value Type</h1>
<p>ARC 는 보통 Reference Type 에 적용됩니다.
Swift 에서는 많은 데이터들이 Reference Type 외에도 Value Type 으로도 존재합니다.
Value Type 과 Reference Type 에 대해서 정리해봤습니다.</p>
<p>Stack 에는 Int, Double, enum, array, set, dictionary 등을 저장합니다.
함수가 불렸을 때, 함수 내 지역 변수와 매개 변수들도 Stack 에 저장됩니다.
CPU 가 메모리를 효율적으로 구성하고 pointer 위치만 변화시키기 때문에 읽고 쓰는 속도가 굉장히 빠릅니다.
Heap 에는 Class, Protocol 을 구현한 Struct, Closure 등을 저장합니다.
Heap 은 메모리를 관리하는 데 thread safety overhead 가 존재합니다.
Reference Counting 이 atomic 하게 동작하기 때문에 Stack 보다 상대적으로 느립니다.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="struct-vs-class">Struct vs. Class<a href="https://yongseongkim.github.io/blog/2020/06/14/swift-memory-management/#struct-vs-class" class="hash-link" aria-label="Direct link to Struct vs. Class" title="Direct link to Struct vs. Class">​</a></h2>
<p>보통 데이터를 모아서 다루는 경우 struct 와 class 사이를 고민합니다.
struct 는 Stack 에 데이터가 저장되며 다른 변수에 할당하게 되면 데이터를 복사합니다.
같은 객체를 쓰는 것이 아니기 때문에 값을 변경해도 다른 객체에 영향을 주지 않습니다.
값에 의해 객체를 구분하기 때문에 Equatable 을 구현해야 합니다.
<img decoding="async" loading="lazy" alt="Struct vs. Class Array of Struct" src="https://yongseongkim.github.io/assets/images/struct_vs_class_struct_array-f1f536278f4b70309a6b3f449b1764f1.png" width="3024" height="1432" class="img_ev3q"></p>
<p>출처: <a href="https://developer.apple.com/videos/play/wwdc2015/409/" target="_blank" rel="noopener noreferrer">WWDC 2015 Optimizing Swift Performance</a>
class 객체는 heap 에 데이터를 저장합니다. 다른 변수에 할당하면 reference 를 복사하기 떄문에 같은 객체에 대한 접근이 여러 변수를 통해서 가능합니다.
class 는 객체의 identitiy 가 중요하거나 inheritance, indirect storage 등의 목적으로 쓰입니다.</p>
<p><img decoding="async" loading="lazy" alt="Struct vs. Class Array of Struct" src="https://yongseongkim.github.io/assets/images/struct_vs_class_class_array-a5e846c7eda974d42a67508b10119ec8.png" width="2962" height="1090" class="img_ev3q"></p>
<p>출처: <a href="https://developer.apple.com/videos/play/wwdc2015/409/" target="_blank" rel="noopener noreferrer">WWDC 2015 Optimizing Swift Performance</a></p>
<p>프로토콜을 구현한 struct 는 일반적인 struct 와는 조금 다른 형태를 가집니다.
위 코드에서 <code>drawables</code> 변수는 프로토콜 배열입니다. 하지만 Point 와 Line 객체는 다른 크기를 가집니다.
같은 프로토콜을 구현했지만 다른 크기를 가지는 경우를 생각해서 Swift 에서는 Existential Container 이용합니다.
<img decoding="async" loading="lazy" alt="Struct: Protocol Implementation" src="https://yongseongkim.github.io/assets/images/protocol_implementation_struct-8ca04dc37f52d9a0c30262879a984c0e.png" width="1448" height="458" class="img_ev3q"></p>
<p>출처: <a href="https://developer.apple.com/videos/play/wwdc2015/409/" target="_blank" rel="noopener noreferrer">WWDC 2015 Optimizing Swift Performance</a></p>
<p>위 그림에서 흰색 사각형과 같이 Existential Container 는 3 words 크기의 데이터를 가질 수 있는데 그보다 크면 Heap 에 메모리를 할당하고 Reference 를 가집니다.
그림에서 왼쪽 구조가 크기가 작은 struct, 오른쪽 구조가 크기가 큰 struct 입니다.
사용하는 데에 있어서 일반 struct 와 다른 점은 없지만 Heap 에 할당하기 때문에 일반 struct 에 비해 성능이 안좋을 수 있습니다.
Existential Container 는 Value Witness Table 을 이용하여 값을 생성, 복사하고
더 자세한 내용은 <a href="https://developer.apple.com/videos/play/wwdc2016/416/" target="_blank" rel="noopener noreferrer">WWDC 2016 Understanding Swift Performance</a> 를 참고하세요.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="parameters-in-function">Parameters in Function<a href="https://yongseongkim.github.io/blog/2020/06/14/swift-memory-management/#parameters-in-function" class="hash-link" aria-label="Direct link to Parameters in Function" title="Direct link to Parameters in Function">​</a></h2>
<p>함수가 불렸을 때, 함수 내 지역 변수와 매개 변수는 stack 에 저장됩니다.
복사되는 값이기 때문에 함수 내 변경은 함수 밖 변수에 영향을 끼치지 않습니다.
(현재 Swift 5 에서는 Value Type 의 매개 변수를 수정하려고 하면 컴파일 에러가 납니다. <code>Left side of mutating operator isn't mutable</code>)</p>
<div class="language-swift codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-swift codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function-definition function" style="color:#d73a49">plus</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">score</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">inout</span><span class="token plain"> </span><span class="token class-name">Int</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    score </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> score</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">Int</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string-literal string" style="color:#e3116c">"before updating - score: </span><span class="token string-literal interpolation-punctuation punctuation" style="color:#393A34">\(</span><span class="token string-literal interpolation">score</span><span class="token string-literal interpolation-punctuation punctuation" style="color:#393A34">)</span><span class="token string-literal string" style="color:#e3116c">"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// "before updating - score: 0"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">plus</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">score</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">score</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string-literal string" style="color:#e3116c">"after updating - score: </span><span class="token string-literal interpolation-punctuation punctuation" style="color:#393A34">\(</span><span class="token string-literal interpolation">score</span><span class="token string-literal interpolation-punctuation punctuation" style="color:#393A34">)</span><span class="token string-literal string" style="color:#e3116c">"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// "after updating - score: 1"</span><br></span></code></pre></div></div>
<p>Stack 에 함수의 Reference 를 복사하기 때문에 실제로 바깥 영역과 함수 내 영역의 변수가 같은 객체를 가리키고 있습니다.
그래서 함수 내부에서 값을 변경해면 바깥까지 영향을 미칩니다.</p>
<div class="language-swift codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-swift codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">ScoreBoard</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> score</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">Int</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function-definition function" style="color:#d73a49">updateScore</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">board</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">ScoreBoard</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    board</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">score </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> board </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">ScoreBoard</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string-literal string" style="color:#e3116c">"before updating - score: </span><span class="token string-literal interpolation-punctuation punctuation" style="color:#393A34">\(</span><span class="token string-literal interpolation">board</span><span class="token string-literal interpolation punctuation" style="color:#393A34">.</span><span class="token string-literal interpolation">score</span><span class="token string-literal interpolation-punctuation punctuation" style="color:#393A34">)</span><span class="token string-literal string" style="color:#e3116c">"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// "before updating - score: 0"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">updateScore</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">board</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> board</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string-literal string" style="color:#e3116c">"after updating - score: </span><span class="token string-literal interpolation-punctuation punctuation" style="color:#393A34">\(</span><span class="token string-literal interpolation">board</span><span class="token string-literal interpolation punctuation" style="color:#393A34">.</span><span class="token string-literal interpolation">score</span><span class="token string-literal interpolation-punctuation punctuation" style="color:#393A34">)</span><span class="token string-literal string" style="color:#e3116c">"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// "after updating score: 1"</span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="capturing-values-in-closure">Capturing Values in Closure<a href="https://yongseongkim.github.io/blog/2020/06/14/swift-memory-management/#capturing-values-in-closure" class="hash-link" aria-label="Direct link to Capturing Values in Closure" title="Direct link to Capturing Values in Closure">​</a></h2>
<p>Closure 는 기본적으로 변수의 Strong Reference 를 가집니다.
어떤 상황에서 Weak Reference 를 사용하여 Memory leak 을 방지하는 지 정리해봤습니다.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="escaping-vs-non-escaping">Escaping vs. Non-escaping<a href="https://yongseongkim.github.io/blog/2020/06/14/swift-memory-management/#escaping-vs-non-escaping" class="hash-link" aria-label="Direct link to Escaping vs. Non-escaping" title="Direct link to Escaping vs. Non-escaping">​</a></h3>
<p>Closure 는 Escaping 과 Non-escaping 두 타입으로 나눌 수 있습니다.
함수에서 Closure 를 매개 변수로 전달 받았을 때 함수 내에서만 쓰이면 Non-escaping (탈출하지 않는다.) 으로 정의합니다.
함수 외에서 쓰이면 Escaping(탈출한다.)로 정의합니다.
예를 들어 매개 변수로 넘어온 Closure 를 변수로 저장해서 추후에 계속 쓰는 경우, <code>DispatchQueue.async</code> 를 이용해서 비동기 처리를 하는 경우 등이 있습니다.
함수의 매개 변수로 전달된 Closure 는 기본으로 Non-escaping 으로 선언됩니다.
하지만 매개 변수 Closure 가 Optional 이거나 Tuple 등으로 감싸여진 경우도 Escaping 에 속합니다.</p>
<p>함수 내에서만 쓰이는 Non-escaping Closure 에서는 어떤 메모리를 참조하던 함수가 끝나면 동시에 메모리 해제하기 때문에 Memory leak 이 발생하지 않습니다.
하지만 Escaping Closure 에서 변수를 가리키게 되면 Closure 의 생명 주기에 따라가기 때문에 예상치 못하게 동작하는 경우가 생길 수 있습니다.
그래서 Escaping Closure 를 사용하는 경우 Weak Reference 를 사용하여 Memory leak 을 방지합니다.</p>
<div class="language-swift codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-swift codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// Non-escaping Closure</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">protocol</span><span class="token plain"> </span><span class="token class-name">KotlinCompatible</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">extension</span><span class="token plain"> </span><span class="token class-name">KotlinCompatible</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// @non-esacping</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function-definition function" style="color:#d73a49">apply</span><span class="token punctuation" style="color:#393A34">(</span><span class="token omit keyword" style="color:#00009f">_</span><span class="token plain"> block</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">Self</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token class-name">Void</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Self</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">block</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">self</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">self</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// Escaping Closure</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">final</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">Coordinator</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">NSObject</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> onPickDocuments</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">[</span><span class="token constant" style="color:#36acaa">URL</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token class-name">Void</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> onCancelPick</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token class-name">Void</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// property 로 저장되는 것은 함수 밖으로 빠져나올 수 있으니 @escaping</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">init</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">onPickDocuments</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token attribute atrule" style="color:#00a4db">@escaping</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">[</span><span class="token constant" style="color:#36acaa">URL</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token class-name">Void</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> onCancelPick</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token attribute atrule" style="color:#00a4db">@escaping</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token class-name">Void</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">onPickDocuments </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> url </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">url</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">onCancelPick </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> onCancelPick</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="capture-list">Capture list<a href="https://yongseongkim.github.io/blog/2020/06/14/swift-memory-management/#capture-list" class="hash-link" aria-label="Direct link to Capture list" title="Direct link to Capture list">​</a></h3>
<p>Closure 내의 변수들을 보통 Strong Reference 로 가리키고 있기 때문에 Memory leak, Delayed Deallocation 등 예상치 못한 상황을 겪을 수 있습니다.
Swift 에서는 Capture List 기능을 제공하는데 이 기능을 이용해서 이러한 상황을들 예방할 수 있습니다.
Capture List 는 변수를 <code>[]</code> 로 감싸 선언합니다.</p>
<div class="language-swift codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-swift codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// 출처: https://docs.swift.org/swift-book/ReferenceManual/Expressions.html#ID544</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// Value Type</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> a </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> b </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> closure </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">a</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Capture List 로 선언하면서 a 는 복사되어</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// scope 밖 변수 a 에 영향을 끼치지 않습니다.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">a</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> b</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">10</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">b </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">10</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">closure</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// "0 10"</span><br></span></code></pre></div></div>
<p>Reference Type 은 Reference 를 Capture 하기 때문에 Closure 안, 밖의 데이터 변경이 서로에게 영향을 줄 수 있습니다.</p>
<div class="language-swift codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-swift codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// 출처: https://docs.swift.org/swift-book/ReferenceManual/Expressions.html#ID544</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">SimpleClass</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> value</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">Int</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> x </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">SimpleClass</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> y </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">SimpleClass</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> closure </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Capturing reference</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">value</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> y</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">value</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">value </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">10</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">y</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">value </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">10</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">closure</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// "10 10"</span><br></span></code></pre></div></div>
<p>Capture list 에 weak, unowned 을 같이 선언하여 Reference Counting 에 영향을 주지 않을 수 있습니다.</p>
<div class="language-swift codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-swift codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// 출처: https://docs.swift.org/swift-book/ReferenceManual/Expressions.html#ID544</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">myFunction </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token keyword" style="color:#00009f">self</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">title</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain">              </span><span class="token comment" style="color:#999988;font-style:italic">// explicit strong capture</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">myFunction </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token keyword" style="color:#00009f">weak</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">self</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">self</span><span class="token operator" style="color:#393A34">!</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">title</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// weak capture</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">myFunction </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token keyword" style="color:#00009f">unowned</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">self</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">title</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic">// unowned capture</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">myFunction </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token keyword" style="color:#00009f">weak</span><span class="token plain"> parent </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">parent</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">parent</span><span class="token operator" style="color:#393A34">!</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">title</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Weak capture of "self.parent" as "parent"</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="usages-of-weak-self-in-closure">Usages of [weak self] in Closure<a href="https://yongseongkim.github.io/blog/2020/06/14/swift-memory-management/#usages-of-weak-self-in-closure" class="hash-link" aria-label="Direct link to Usages of [weak self] in Closure" title="Direct link to Usages of [weak self] in Closure">​</a></h3>
<p>Weak Reference 를 통해 Memory leak, Delayed Deallocation 등을 예방할 수 있습니다.</p>
<p>첫 예제는 애니메이션 관련된 예제입니다.
애니메이션이 끝나는 시점에 동작을 <code>addCompletion</code> 을 통해 정의합니다.
<code>addCompletion</code> 에서 <code>ContentView</code> 를 접근하고 <code>ContentView</code> 가 <code>addCompletion</code> 을 정의한 Animator 를 가리키면서 Reference Cycle 이 생깁니다.
(ContentView → Animator → Completion Closure → ContentView)</p>
<div class="language-swift codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-swift codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// 출처: https://medium.com/flawless-app-stories/you-dont-always-need-weak-self-a778bec505ef</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">ContentView</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">UIView</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// ContentView -&gt; Animation Module -&gt; Closure -&gt; ContentView</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function-definition function" style="color:#d73a49">setupAnimation</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> anim </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">UIViewPropertyAnimator</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">duration</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2.0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> curve</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">linear</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic">// Do something with self.view</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        anim</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">addCompletion </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token omit keyword" style="color:#00009f">_</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic">// Do something with self.view</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">animationStorage </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> anim</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p>두 번째는 GCD 와 관련된 예제입니다. GCD 는 멀티스레드 사용을 위한 API 입니다.
예제에서는 DispatchQueue 를 이용하여 다른 스레드에서 이미지를 처리할 때 Closure 내에서 self 를 참조합니다.
근데 여기서는 <code>[weak self]</code> 를 썼으니 Reference Cycle 문제가 발생하지 않습니다.
하지만 Closure 내의 동작이 많은 시간이 걸리는 경우 객체에 대한 참조를 없애도 작업이 완료되지 않아 메모리 해제가 되지 않는 문제가 발생할 수 있습니다.
이럴 땐 guard let 구문을 없애서 Optional Self 를 이용하여 객체가 사라졌을 때 그 다음 작업을 처리 안하게 할 수 있습니다.</p>
<div class="language-swift codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-swift codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// 출처: https://medium.com/flawless-app-stories/you-dont-always-need-weak-self-a778bec505ef</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function-definition function" style="color:#d73a49">process</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">image</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">UIImage</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> completion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token attribute atrule" style="color:#00a4db">@escaping</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">UIImage</span><span class="token operator" style="color:#393A34">?</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token class-name">Void</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">DispatchQueue</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">global</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">qos</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">userInteractive</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">async</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token keyword" style="color:#00009f">weak</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">self</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">guard</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">self</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">self</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> firstProcessed </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">doHeavyWork1</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">image</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> image</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> secondProcessed </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">doHeavyWork2</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">image</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> firstProcessed</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> thirdProcessed </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">doHeavyWork3</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">image</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> secondProcessed</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">completion</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">processedImage</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p>마지막으로 URLSession 을 이용하여 네트워크 통신 후 응답 값을 처리하는 Closure 에 대한 예제입니다.
예제 Closure 는 네트워크 통신 후 응답 값이 도착할 때까지 self 를 강하게 참조하면서 self 의 메모리 해제를 방해할 수 있습니다.
네트워크 요청을 한 화면이 사라졌음에도 네트워크 응답을 처리하면서 필요 없는 자원을 소모할 수 있습니다.
아래와 같은 상황도 <code>[weak self]</code> Capture list 를 이용하여 이미 사라진 객체에 대한 처리를 하지 않게 할 수 있습니다.</p>
<div class="language-swift codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-swift codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// 출처: https://medium.com/flawless-app-stories/you-dont-always-need-weak-self-a778bec505ef</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function-definition function" style="color:#d73a49">delayedAllocAsyncCall</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">/* ... */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> session </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">URLSession</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">configuration</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> sessionConfig</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> task </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> session</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">downloadTask</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">with</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> url</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> localURL</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token omit keyword" style="color:#00009f">_</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> error </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">guard</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> localURL </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> localURL </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">/*</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">            Do something with `self`</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">            ex) print(self.view)</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">        */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    task</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">resume</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<h1>Conclusion</h1>
<p>Swift 메모리 참조에 대해서 알아봤습니다. 위에 내용을 바탕으로 이제는 위에 질문들에 답을 쉽게 할 수 있을 것 같네요.</p>
<div class="language-swift codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-swift codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// Question 1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> variable </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string-literal string" style="color:#e3116c">"Value before defining closure"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> closure </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">variable</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">variable </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string-literal string" style="color:#e3116c">"Value after defining closure"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">closure</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// "Value after defining closure"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// Question 2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> variable </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string-literal string" style="color:#e3116c">"Value before defining closure"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> closure </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">variable</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Value Type Capture</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 값을 복사하기 때문에 closure 선언 이후에 수정해도 영향을 끼치지 않습니다.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">variable</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">variable </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string-literal string" style="color:#e3116c">"Value after defining closure"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">closure</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// "Value before defining closure"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// Question 3</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">Object</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">String</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">init</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">String</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">name </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> obj </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">Object</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string-literal string" style="color:#e3116c">"Value before defining closure"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> closure </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">obj</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Reference Type Capture</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 같은 객체를 바라보기 때문에 안과 밖 데이터 변경이 서로 영향을 줍니다.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">obj</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">name</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">obj</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">name </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string-literal string" style="color:#e3116c">"Value after defining closure"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">closure</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// "Value after defining closure"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// Question 4</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function-definition function" style="color:#d73a49">makeIncrementer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">forIncrement amount</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">Int</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token class-name">Int</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> runningTotal </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function-definition function" style="color:#d73a49">incrementer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token class-name">Int</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// Closure 에서 Stack 에 저장된 값을 참조하는 경우</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// Heap 에 복사되어 Closure 가 실행될 때 접근이 가능합니다.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        runningTotal </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> amount</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> runningTotal</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> incrementer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> incrementByTen </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">makeIncrementer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">forIncrement</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">10</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">incrementByTen</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// returns a value of 10</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">incrementByTen</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// returns a value of 20</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">incrementByTen</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// returns a value of 30</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> incrementBySeven </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">makeIncrementer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">forIncrement</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">7</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">incrementBySeven</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// returns a value of 7</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">incrementByTen</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// returns a value of 40</span><br></span></code></pre></div></div>
<h1>Reference</h1>
<ul>
<li><a href="https://academy.realm.io/kr/posts/letswift-swift-performance/" target="_blank" rel="noopener noreferrer">Swift 성능 이해하기: Value 타입, Protocol과 스위프트의 성능 최적화</a></li>
<li><a href="https://heartbeat.fritz.ai/memory-management-in-swift-heaps-stacks-baa755abe16a" target="_blank" rel="noopener noreferrer">Memory Management in Swift: Heaps &amp; Stacks</a></li>
<li><a href="https://docs.swift.org/swift-book/LanguageGuide/AutomaticReferenceCounting.html" target="_blank" rel="noopener noreferrer">Automatic Reference Counting - The Swift Programming Language (Swift 5.2)</a></li>
<li><a href="https://swiftsenpai.com/swift/can-you-answer-this-simple-swift-question-correctly/" target="_blank" rel="noopener noreferrer">Can You Answer This Simple Swift Question Correctly? - Swift Senpai</a></li>
<li><a href="https://medium.com/swlh/differences-between-classes-and-structures-in-swift-ab2e27956665" target="_blank" rel="noopener noreferrer">Differences Between Classes and Structures in Swift</a></li>
<li><a href="https://medium.com/rocknnull/ios-gcd-what-the-weak-is-going-on-d5a10fc682a" target="_blank" rel="noopener noreferrer">iOS - GCD what the __weak is going on?</a></li>
<li><a href="https://medium.com/flawless-app-stories/you-dont-always-need-weak-self-a778bec505ef" target="_blank" rel="noopener noreferrer">You don't (always) need [weak self]</a></li>
<li><a href="https://docs.swift.org/swift-book/ReferenceManual/Expressions.html#ID544" target="_blank" rel="noopener noreferrer">Expressions - The Swift Programming Language (Swift 5.2)</a></li>
<li><a href="https://medium.com/@cyrilcermak/swift-is-passing-by-value-faster-than-passing-by-reference-d30b6522d065" target="_blank" rel="noopener noreferrer">Swift: Is passing by value faster than passing by reference?</a></li>
</ul>]]></content>
        <category label="swift" term="swift"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[SwiftUI - Data Flow Patterns]]></title>
        <id>https://yongseongkim.github.io/blog/2020/05/26/swiftui-data-flow-patterns/</id>
        <link href="https://yongseongkim.github.io/blog/2020/05/26/swiftui-data-flow-patterns/"/>
        <updated>2020-05-26T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[SwiftUI 에서 View 는 SwiftUI 가 무엇을 어떻게 그릴 것인지 에 대해 명시한 가상의 객체입니다.]]></summary>
        <content type="html"><![CDATA[<p>SwiftUI 에서 View 는 SwiftUI 가 무엇을 어떻게 그릴 것인지 에 대해 명시한 가상의 객체입니다.
다양한 데이터를 보여주기 위해 SwiftUI 에서는 여러 Component 를 만들고 Component 들 간의 데이터 전달하는 과정이 필요합니다.
이번 글에서는 SwiftUI 에서 Parent 와 Child 간 데이터를 전달하는 방법들을 정리해봤습니다.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="initializer">Initializer<a href="https://yongseongkim.github.io/blog/2020/05/26/swiftui-data-flow-patterns/#initializer" class="hash-link" aria-label="Direct link to Initializer" title="Direct link to Initializer">​</a></h2>
<p>Parent 의 값을 전달받는 가장 기본적인 방법으로는 Child View 의 Initializer 로 전달하는 방법이 있습니다.
SwiftUI 에서 <code>@State</code> 를 선언한 property 의 값이 바뀔 때마다 var body: some View 에 선언된 자식 View 들을 새로 그립니다.
State 가 바뀔 때 마다 자식 View 들을 매번 새로 생성해서 갱신된 데이터를 보여줄 수 있습니다.</p>
<div class="language-swift codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-swift codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">ParentView</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">View</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token attribute atrule" style="color:#00a4db">@State</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> items</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token class-name">Item</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> body</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">some</span><span class="token plain"> </span><span class="token class-name">View</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">List</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">items</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> item </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token class-name">ChildView</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">item</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> item</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">ChildView</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">View</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> item</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">Item</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> body</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">some</span><span class="token plain"> </span><span class="token class-name">View</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">VStack</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token class-name">Text</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">item</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">name</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic">/*...*/</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">onTapGesture </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token function" style="color:#d73a49">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">item</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">name</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="environment">Environment<a href="https://yongseongkim.github.io/blog/2020/05/26/swiftui-data-flow-patterns/#environment" class="hash-link" aria-label="Direct link to Environment" title="Direct link to Environment">​</a></h2>
<p><code>@Environment</code> property wrapper 는 모든 View 에서 접근할 수 있는 데이터 입니다.
그래서 보통 Dark / Light 모드 인지, Core Data Managed Object Context 와 같은 요소들에 적합합니다.
<code>@Environment</code> 로 접근할 수 있는 목록은 <a href="https://developer.apple.com/documentation/swiftui/environmentvalues" target="_blank" rel="noopener noreferrer">링크</a>를 보면 됩니다.</p>
<p><code>.environment()</code> 를 통해서 특정 자식 View Tree 에는 다른 환경을 적용할 수 있습니다.
예를 들면 자식 A, 자식 B 이 있을 때 자식 A 에 <code>.environment(\.colorScheme, .light)</code> 와 같이 선언하면 자식 A 의 Subtree 는 모두 light 적용됩니다.
기존에 존재하는 값들 외에도 <code>EnvironmentKey</code> 와 <code>EnvironmentValues</code> 를 이용하여 custom 값을 저장할 수도 있습니다.</p>
<div class="language-swift codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-swift codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// 출처: https://swiftwithmajid.com/2019/08/21/the-power-of-environment-in-swiftui/</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">ItemsPerPageKey</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">EnvironmentKey</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">/*...*/</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">extension</span><span class="token plain"> </span><span class="token class-name">EnvironmentValues</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> itemsPerPage</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">Int</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">get</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">self</span><span class="token punctuation" style="color:#393A34">[</span><span class="token class-name">ItemsPerPageKey</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">self</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">set</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">self</span><span class="token punctuation" style="color:#393A34">[</span><span class="token class-name">ItemsPerPageKey</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">self</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> newValue </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">RelatedProductsView</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">View</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token attribute atrule" style="color:#00a4db">@Environment</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">\</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">itemsPerPage</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> count</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p><code>@EnvironmentObject</code> 를 이용하면 <code>ObservableObject</code> 을 추가하여 Scope 를 만들 수도 있습니다.</p>
<div class="language-swift codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-swift codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">ItemStore</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">ObservableObject</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">/*...*/</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">ItemDetailStore</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">ObservableObject</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">/*...*/</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">ContentView</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">View</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token attribute atrule" style="color:#00a4db">@EnvironmentObject</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> store</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">ItemStore</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> body</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">some</span><span class="token plain"> </span><span class="token class-name">View</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">NavigationView</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token class-name">List</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token class-name">ForEach</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">store</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">items</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> item </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token comment" style="color:#999988;font-style:italic">// ItemDetailView 내에서는 ItemStore, ItemDetailStore 에 대해</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token comment" style="color:#999988;font-style:italic">// EnvironmentObject 로 접근이 가능합니다.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token class-name">ItemDetailView</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">environmentObject</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">ItemDetailStore</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">item</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> item</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">ItemDetailView</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">View</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// ItemDetailView 는 ItemView 에 포함되므로 ItemStore 에도 접근이 가능하다.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token attribute atrule" style="color:#00a4db">@EnvironmentObject</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> store</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">ItemStore</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token attribute atrule" style="color:#00a4db">@EnvironmentObject</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> detailStore</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">ItemDetailStore</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> body</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">some</span><span class="token plain"> </span><span class="token class-name">View</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">/*...*/</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p>위 예제와 같이 <code>ObservableObject</code> 를 주입하여 주입한 Scope 아래 View 들은 해당 객체에 접근이 가능합니다.</p>
<h1>From Child to Parent</h1>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="initializer---callback">Initializer - Callback<a href="https://yongseongkim.github.io/blog/2020/05/26/swiftui-data-flow-patterns/#initializer---callback" class="hash-link" aria-label="Direct link to Initializer - Callback" title="Direct link to Initializer - Callback">​</a></h2>
<p>부모 Component 가 자식 Component 에게 Callback 을 전달하여 데이터에 접근하는 방법이 있습니다.</p>
<div class="language-swift codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-swift codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">ParentView</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">View</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> body</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">some</span><span class="token plain"> </span><span class="token class-name">View</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">ItemSelector</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            items</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            onConfirmed</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> selectedItems </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token comment" style="color:#999988;font-style:italic">// Do something with selected items.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// Confirm Button 을 눌렀을 때 선택한 Item 들만 Parent 에게 전달할 수 있다.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">ItemSelector</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">View</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> items</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token class-name">Item</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> onConfirmed</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">Set</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token class-name">Item</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token attribute atrule" style="color:#00a4db">@State</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> selectedItems</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">Set</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token class-name">Item</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> body</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">some</span><span class="token plain"> </span><span class="token class-name">View</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">VStack</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token class-name">List</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">items</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> id</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">name</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> item </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token class-name">ItemRow</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    item</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> item</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    isSelected</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">selectedItems</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">contains</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">item</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">onTapGesture </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">/* Insert if it already exists or remove if it doesn't exist. */</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token class-name">Button</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                action</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">onConfirmed</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">selectedItems</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                label</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token class-name">Text</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string-literal string" style="color:#e3116c">"Confirm"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="binding">Binding<a href="https://yongseongkim.github.io/blog/2020/05/26/swiftui-data-flow-patterns/#binding" class="hash-link" aria-label="Direct link to Binding" title="Direct link to Binding">​</a></h2>
<p><code>@Binding</code> property wrapper 를 이용하여 부모에게 데이터를 전달하는 방법이 있습니다.
부모의 <code>@State</code> property 와 <code>@Binding</code> 을 이용하여 자식 View 를 다시 그려 갱신된 데이터를 보여주는 방법입니다.</p>
<div class="language-swift codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-swift codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">ScoreBoard</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">View</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token attribute atrule" style="color:#00a4db">@State</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> scoreA</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">Int</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token attribute atrule" style="color:#00a4db">@State</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> scoreB</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">Int</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> body</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">some</span><span class="token plain"> </span><span class="token class-name">View</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">VStack</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token class-name">Text</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string-literal string" style="color:#e3116c">"Total: </span><span class="token string-literal interpolation-punctuation punctuation" style="color:#393A34">\(</span><span class="token string-literal interpolation">scoreA </span><span class="token string-literal interpolation operator" style="color:#393A34">+</span><span class="token string-literal interpolation"> scoreB</span><span class="token string-literal interpolation-punctuation punctuation" style="color:#393A34">)</span><span class="token string-literal string" style="color:#e3116c">"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token class-name">ScoreController</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">score</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> $scoreA</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token class-name">ScoreController</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">score</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> $scoreB</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">ScoreController</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">View</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 부모 ScoreBoard 의 @State property 를 변경시켜서 View 를 새로 그립니다.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token attribute atrule" style="color:#00a4db">@Binding</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> score</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">Int</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> body</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">some</span><span class="token plain"> </span><span class="token class-name">View</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">HStack</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token class-name">Text</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string-literal string" style="color:#e3116c">"</span><span class="token string-literal interpolation-punctuation punctuation" style="color:#393A34">\(</span><span class="token string-literal interpolation">score</span><span class="token string-literal interpolation-punctuation punctuation" style="color:#393A34">)</span><span class="token string-literal string" style="color:#e3116c">"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token class-name">Button</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                action</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">score </span><span class="token operator" style="color:#393A34">-=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                label</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token class-name">Text</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string-literal string" style="color:#e3116c">"-"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token class-name">Button</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                action</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">score </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                label</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token class-name">Text</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string-literal string" style="color:#e3116c">"+"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p>위와 같은 예제는 변경된 데이터를 바로 보여주고 싶지 않은 경우엔 적절하지 않을 수 있습니다.
확인 버튼을 눌렀을 때 View 를 새로 그리고 싶은 경우 <code>@State</code> 를 사용하지 않고 Class 를 이용하는 방법도 있습니다.
아래 코드와 같이 score 값에 따라 View 를 갱신하는 로직을 Class 안에 숨길 수 있습니다.
store 내에 score 값은 갱신했지만 View 를 새로 그리는 로직은 Store 내에서 정할 수 있습니다.</p>
<div class="language-swift codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-swift codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">ScoreBoard</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">View</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// @Published property wrapper 를 이용하여</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// `음수인 score 에 대해서는 화면을 갱신하지 않는다.` 와 같은 로직을 숨길 수 있다.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token attribute atrule" style="color:#00a4db">@ObservedObject</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> store</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">ScoreStore</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> body</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">some</span><span class="token plain"> </span><span class="token class-name">View</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">VStack</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token class-name">ScoreController</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                score</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">init</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token keyword" style="color:#00009f">get</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">store</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">score </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token keyword" style="color:#00009f">set</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">store</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">score </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token short-argument">$0</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="preference">Preference<a href="https://yongseongkim.github.io/blog/2020/05/26/swiftui-data-flow-patterns/#preference" class="hash-link" aria-label="Direct link to Preference" title="Direct link to Preference">​</a></h2>
<p>자식이 부모에게 데이터를 전해주는 방법으로 Preference 를 이용하는 방법이 있습니다.
자식 View 는 Preference 값을 등록하고 부모는 <code>onPreferenceChange</code> 를 통하여 자식 View 들의 Preference 값 변화를 감지할 수 있습니다.
같은 Prefenece Key 값을 사용하는 모든 자식들의 Preference 값에 차례대로 접근합니다.</p>
<div class="language-swift codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-swift codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// 값을 대입하는 경우 제일 마지막 Preference 의 값이 반영됩니다.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">CustomPreferenceKey</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">PreferenceKey</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> defaultValue</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">String</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string-literal string" style="color:#e3116c">"default string"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function-definition function" style="color:#d73a49">reduce</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">value</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">inout</span><span class="token plain"> </span><span class="token class-name">String</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> nextValue</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token class-name">String</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        value </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">nextValue</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 모든 Child 의 Preference 를 모을 수 있습니다.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">CustomPreferenceKey</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">PreferenceKey</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> defaultValue</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token class-name">String</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string-literal string" style="color:#e3116c">"default string"</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function-definition function" style="color:#d73a49">reduce</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">value</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">inout</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token class-name">String</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> nextValue</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token class-name">String</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        value </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> value </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">nextValue</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p>위의 예제 코드에서 첫 번째 Preference 는 모든 자식을 만날 때마다 값을 갱신하기 때문에 제일 마지막 자식 Preference 가 저장됩니다.
그래서 첫째 자식 View 의 Preference 가 변경되었다 하더라도 마지막 View 의 Preference 가 변경되지 않았다면 부모의 <code>onPreferenceChange</code> 가 불리지 않습니다.
모든 자식의 Preference 를 모아 어떤 값을 쓸 지 정하고 싶다면 예제 코드에서 아래 Preference Key 처럼 리스트를 이용하면 모든 자식의 Preference 변화를 감지할 수 있습니다.</p>
<p><code>onPreferenceChange</code> 를 통해 같은 Preference 를 감지하고 있어도 자식이 아닌 경우에는 호출되지 않습니다.</p>
<p><img decoding="async" loading="lazy" alt="Preference Propagation Example" src="https://yongseongkim.github.io/assets/images/from-child-to-parent-preference-example-b405b06344e9ceba7e5d25abc4a3c8ef.png" width="860" height="540" class="img_ev3q"></p>
<p>위의 그림을 예로 들면 B 의 자식 B`, B`` 의 Preference 가 변경되면 A 에 같은 Preference Key 로 <code>onPreferenceChange</code> 를 등록해놨다 하더라도 불리지 않습니다.</p>
<h1>Conclusion</h1>
<p>이번 글에서는 Component 간 데이터를 전달하는 방법에 대해서 정리해봤습니다.
Callback 을 전달하는 것과 Binding 을 이용하는 것은 부모의 자식의 사이가 먼 경우
모든 Component 에서 Parameter 로 전달해야 하기 때문에 Preference Key 를 활용하는 게 편리합니다.
Initializer, Callback, Binding, Preference 와 같이
부모와 자식 View 간에 데이터를 주고 받는 방법이 다양하기 때문에 적절하게 사용하는 게 중요합니다.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="reference">Reference<a href="https://yongseongkim.github.io/blog/2020/05/26/swiftui-data-flow-patterns/#reference" class="hash-link" aria-label="Direct link to Reference" title="Direct link to Reference">​</a></h2>
<ul>
<li><a href="https://swiftui-lab.com/communicating-with-the-view-tree-part-1/" target="_blank" rel="noopener noreferrer">Communicating with the view tree part 1</a></li>
<li><a href="https://swiftui-lab.com/communicating-with-the-view-tree-part-2/" target="_blank" rel="noopener noreferrer">Communicating with the view tree part 2</a></li>
<li><a href="https://swiftwithmajid.com/2019/08/21/the-power-of-environment-in-swiftui/" target="_blank" rel="noopener noreferrer">The power of environment in SwiftUI</a></li>
<li><a href="https://medium.com/flawless-app-stories/swiftui-understanding-state-8afa23fd9f1f" target="_blank" rel="noopener noreferrer">Understanding SwiftUI State</a></li>
<li><a href="https://swiftwithmajid.com/2019/08/21/the-power-of-environment-in-swiftui/" target="_blank" rel="noopener noreferrer">The power of Environment in SwiftUI</a></li>
</ul>]]></content>
        <category label="swiftui" term="swiftui"/>
        <category label="swift" term="swift"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[SwiftUI - Layout System]]></title>
        <id>https://yongseongkim.github.io/blog/2020/05/25/swiftui-layout-system/</id>
        <link href="https://yongseongkim.github.io/blog/2020/05/25/swiftui-layout-system/"/>
        <updated>2020-05-25T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[최근에 SwiftUI 를 이용해 앱을 만들어 보면서 알게 된 사실들을 정리해보려 합니다. 이번 글은 View 사이즈를 계산하고 배치하는 방법과 과정에 대해 정리해봤습니다.]]></summary>
        <content type="html"><![CDATA[<p>최근에 SwiftUI 를 이용해 앱을 만들어 보면서 알게 된 사실들을 정리해보려 합니다. 이번 글은 View 사이즈를 계산하고 배치하는 방법과 과정에 대해 정리해봤습니다.</p>
<ol>
<li>
<p>먼저 부모 View 는 자식 View 에게 가능한 영역의 크기를 알려줍니다. 가장 최상위 View 에서는 safe area 를 제외한 스크린 크기가 되겠네요.</p>
<img src="https://yongseongkim.github.io/assets/images/screen-without-safearea-73ba972a760eeb57946145964102fd8a.png" width="320">
<p>출처: <a href="https://kean.github.io/post/swiftui-layout-system" target="_blank" rel="noopener noreferrer">hareenlaks's blog</a></p>
</li>
<li>
<p>부모 View 가 알려준 영역을 기반으로 자식 View 는 자신의 크기를 계산합니다.</p>
</li>
<li>
<p>자식 View 는 자신의 크기를 부모 View 에게 알려주고 부모는 자식 View 를 자신의 영역에서 배치합니다.</p>
</li>
</ol>
<div class="language-swift codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-swift codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">ContentView</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">View</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> body</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">some</span><span class="token plain"> </span><span class="token class-name">View</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">Text</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string-literal string" style="color:#e3116c">"Hello World!"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// Parent 크기가 `Hellow World!` 를 보여줄 수 있는 크기보다 크다면 Text View 사이즈는</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// `Hellow World!` 를 담을 정도의 크기만 가집니다.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 하지만 Parent 크기가 그정도로 크지 않다면 Text View 크기도 Parent 의 크기를 따라갑니다.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">ContentView_Previews</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">PreviewProvider</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> previews</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">some</span><span class="token plain"> </span><span class="token class-name">View</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">Group</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token class-name">ContentView</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token class-name">ContentView</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">previewLayout</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">fixed</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">width</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">50</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> height</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">30</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p>과정 2번에서 자식 View 들은 크기를 어떻게 정할까요?</p>
<h1>Size Calculation</h1>
<p>사이즈를 계산하는 방식에는 Fit 과 Fill 이 있습니다.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="fit-vs-fill">Fit vs. Fill<a href="https://yongseongkim.github.io/blog/2020/05/25/swiftui-layout-system/#fit-vs-fill" class="hash-link" aria-label="Direct link to Fit vs. Fill" title="Direct link to Fit vs. Fill">​</a></h2>
<p>View 가 크기를 계산하는 방식은 두 가지로 나눌 수 있습니다. 컨텐츠를 기반으로 계산하는 Fit 과 부모로 부터 전달받은 영역을 채우는 Fill 이 있습니다.
컨텐츠를 기반으로 계산하는 Fit 방식으로는 Text, Stack 등이 있고 가능한 영역을 채우는 Fill 방식으로는 GeometryReader, Spacer 등이 있습니다.</p>
<div class="language-swift codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-swift codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// 여기서 RootView 는 Text 에게 가능한 영역의 크기는 Screen 으로 알려줍니다.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// Text 는 컨텐츠 문자열 만큼의 크기를 부모에게 전달합니다.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 부모 View 는 전달받은 크기를 기반으로 중앙 정렬합니다.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">RootView</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">View</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> body</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">some</span><span class="token plain"> </span><span class="token class-name">View</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">Text</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string-literal string" style="color:#e3116c">"test"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// Color 이외에 다른 View 가 없다면 가능한 영역을 전부 채웁니다.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">RootView</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">View</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> body</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">some</span><span class="token plain"> </span><span class="token class-name">View</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">Color</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">red</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p><img decoding="async" loading="lazy" alt="Text in Root" src="https://yongseongkim.github.io/assets/images/text-in-root-b9005c759017afb486805eb54015bb86.png" width="640" height="350" class="img_ev3q">
<img decoding="async" loading="lazy" alt="Color in Root" src="https://yongseongkim.github.io/assets/images/color-in-root-4ebb3175f63e3e72412ec2b56d1749f8.png" width="640" height="350" class="img_ev3q">
Text 는 Parent 에게 전달받은 영역이 아무리 커도 컨텐츠 만큼 크기를 차지하는 반면에 Color 는 부모가 제시한 크기만큼 크기를 차지합니다.</p>
<p>Image 는 <code>resizable</code> modifier 에 따라 동작이 다릅니다. <code>resizable</code> 을 사용하지 않은 Image 는 컨텐츠 크기 만큼 영역을 차지합니다.
큰 이미지의 경우 스크린 영역을 벗어날 수 있습니다.
하지만 <code>resizable</code> modifier 가 붙으면 가능한 영역 안에서 컨텐츠를 보여 줍니다.</p>
<div class="language-swift codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-swift codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">ContentView</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">View</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> body</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">some</span><span class="token plain"> </span><span class="token class-name">View</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">Image</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">systemName</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string-literal string" style="color:#e3116c">"xmark"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">ContentView</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">View</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> body</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">some</span><span class="token plain"> </span><span class="token class-name">View</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">Image</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">systemName</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string-literal string" style="color:#e3116c">"xmark"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">resizable</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p><img decoding="async" loading="lazy" alt="Preview of Image without resizable" src="https://yongseongkim.github.io/assets/images/image-preview-without-resizable-8ea368efb4ef5949c92447454c88a62c.png" width="400" height="350" class="img_ev3q">
<img decoding="async" loading="lazy" alt="Preview of Image with resizable" src="https://yongseongkim.github.io/assets/images/image-preview-with-resizable-8aa36cdbe2d522bc760ad6a5c461dc81.png" width="400" height="352" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="layout-process-in-stack">Layout Process in Stack<a href="https://yongseongkim.github.io/blog/2020/05/25/swiftui-layout-system/#layout-process-in-stack" class="hash-link" aria-label="Direct link to Layout Process in Stack" title="Direct link to Layout Process in Stack">​</a></h2>
<p>SwiftUI 에서는 여러 View 들을 한 화면에 보여주기 위해 Stack 을 사용합니다.
HSack, VStack 내에 View 들은 크기를 계산하는 과정에서 서로 영향을 줍니다. Stack 내에서 추가로 거치는 레이아웃 과정은 아래와 같습니다.</p>
<ol>
<li>먼저 부모 View 가 제시한 영역에서 자식 View 간 spacing 을 제외합니다.</li>
<li>spacing 을 제외한 영역을 동등하게 나눕니다. 그리고 고정할 수 있는 자식부터 크기를 정합니다.
고정할 수 있는 자식 View 의 크기를 정한 후 1번에서 계산한 영역에서 제외합니다.
이후 크기를 정한 자식들을 영역에서 제외하면서 나머지 자식 View 들의 크기도 정합니다.<!-- -->
<ul>
<li>예를 들어 <code>HStack { Text, Image, Text }</code> 와 같은 경우 Image 는 이미지 크기가 정해져 있으니 크기를 고정할 수 있습니다.
이후 우선순위가 높은 Text View 크기를 먼저 정하고 차례대로 반복합니다. 위 예에서는 우선순위가 같으니 같은 크기를 가집니다.</li>
</ul>
</li>
<li>모든 자식 View 의 크기가 정해지면 배치 옵션에 따라 배치합니다.</li>
</ol>
<div class="language-swift codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-swift codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">ContentView</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">View</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> body</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">some</span><span class="token plain"> </span><span class="token class-name">View</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">HStack</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">spacing</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token class-name">Text</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string-literal string" style="color:#e3116c">"Loremipsumdolorsitamet,consecteturadipiscingelit.Praesent et ipsum nulla."</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">border</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">Color</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">green</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token class-name">Image</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">systemName</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string-literal string" style="color:#e3116c">"xmark"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">border</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">Color</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">red</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token class-name">Text</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string-literal string" style="color:#e3116c">"Loremipsumdolorsitamet"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">border</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">Color</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">blue</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p><img decoding="async" loading="lazy" alt="Compare views in stack" src="https://yongseongkim.github.io/assets/images/compare-text-image-text-in-stack-10c97242faf69d413b07f7d2454a1fde.png" width="880" height="650" class="img_ev3q">
컨텐츠 양은 다르지만 정해진 영역에서 같은 크기를 같는 Text</p>
<p>Stack 내에 Fill 타입의 View 가 존재하면 Stack 의 크기도 Parent 를 가득 채우게 크기가 결정됩니다.</p>
<div class="language-swift codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-swift codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">ContentView</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">View</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> body</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">some</span><span class="token plain"> </span><span class="token class-name">View</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">HStack</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">spacing</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token class-name">Text</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string-literal string" style="color:#e3116c">"None"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">border</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">Color</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">blue</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic">// GeometryReader 는 Fill 타입의 View</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token class-name">GeometryReader</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> geometry </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token class-name">Text</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string-literal string" style="color:#e3116c">"None"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">border</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">Color</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">red</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p><img decoding="async" loading="lazy" alt="Fit and Fill views in stack" src="https://yongseongkim.github.io/assets/images/fit-fill-in-stack-d11408dc1b14597473072987b0030c61.png" width="900" height="350" class="img_ev3q"></p>
<h1>Alignments</h1>
<p>화면에 배치할 View 들의 크기가 어떻게 정해지는지 알았다면 어떻게 배치하는지 알아야 합니다.
가장 기본적인 배치로는 Stack Initializer 에서 alignment 파라미터
혹은 <code>frame(width: CGFloat, height: CGFloat, alignment: Alignment)</code> 에서 어떻게 배치할지를 설정할 수 있습니다.</p>
<div class="language-swift codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-swift codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// 각 Text view 들은 다른 크기를 갖고 다른 baseline 을 갖습니다.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// leading, center, trailing 등 option 도 있지만</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// Stack 에는 firstTextBaseline, lastTextBaseline option 도 있습니다.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">ContentView</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">View</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> body</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">some</span><span class="token plain"> </span><span class="token class-name">View</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">VStack</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">alignment</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">trailing</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> spacing</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token class-name">HStack</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">alignment</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">lastTextBaseline</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token class-name">Text</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string-literal string" style="color:#e3116c">"Live"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">font</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">caption</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">border</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">Color</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">red</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token class-name">Text</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string-literal string" style="color:#e3116c">"long"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">border</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">Color</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">red</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token class-name">Text</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string-literal string" style="color:#e3116c">"and"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">font</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">title</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">border</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">Color</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">red</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">border</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">Color</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">blue</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token class-name">Color</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">gray</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p><img decoding="async" loading="lazy" alt="Alignment last text baseline" src="https://yongseongkim.github.io/assets/images/alignment-last-text-baseline-8eba723e1a8dcb6c57bffc1a41e1dd8d.png" width="640" height="220" class="img_ev3q"></p>
<p>그 외에 custom 하게 배치하고 싶을 때 쓰는 modifier 가 있습니다.
<code>alignmentGuide()</code> 는 바꾸고 싶은 alignment guide 와 새로운 alignment 를 정하는 closure 를 필요로 합니다.
closure 내에서 view 의 width, height, edge 정보를 가진 <code>ViewDimension</code> 객체에 접근하여 새롭게 배치할 수 있습니다.</p>
<div class="language-swift codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-swift codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">ContentView</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">View</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> body</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">some</span><span class="token plain"> </span><span class="token class-name">View</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">VStack</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">alignment</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">leading</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token class-name">ForEach</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">..&lt;</span><span class="token number" style="color:#36acaa">4</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> idx </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token class-name">Text</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string-literal string" style="color:#e3116c">"Index: </span><span class="token string-literal interpolation-punctuation punctuation" style="color:#393A34">\(</span><span class="token string-literal interpolation">idx</span><span class="token string-literal interpolation-punctuation punctuation" style="color:#393A34">)</span><span class="token string-literal string" style="color:#e3116c">"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">alignmentGuide</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">leading</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token omit keyword" style="color:#00009f">_</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token class-name">CGFloat</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">idx</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">30</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token class-name">Text</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string-literal string" style="color:#e3116c">"Out of Index"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">alignmentGuide</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">leading</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> dimension </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> dimension</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">width </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">border</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">Color</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">red</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p><img decoding="async" loading="lazy" alt="Example of custom alignmentGuide" src="https://yongseongkim.github.io/assets/images/custom-alignment-guide-1004246afe3e9067c5c4bc8271c3beb5.png" width="900" height="480" class="img_ev3q"></p>
<h1>Conclusion</h1>
<p>이번 글에서는 SwiftUI 에서 View 크기를 어떻게 계산하고 배치하는 지에 대해 정리해봤습니다.
AutoLayout 을 사용할 때에는 부모 View 와 자식 View Constraint 가 양방향으로 동작하기 때문에
Constraint 를 변경하거나 추가할 때 충돌이나 Ambiguous 경고가 뜨는 경우가 많았습니다.
Xib 와 View 코드 사이를 이동해서 커서로 Constraint 를 추가해야하는 부분도 번거로웠습니다.
또한 코드에서 각 View 의 depth 를 파악하기 힘들었습니다.
그에 비해 SwiftUI 에서 Layout 에 대한 어떤 정보를 입력하지 않아도 에러나 경고가 뜨지 않습니다.
또한 View 의 Depth 파악도 Indent 로 구분되어 알아보기 편했습니다.
Stack 이나 GeometryReader 를 통해 위치를 조정하다 보니 View 를 선언하는 Indent Depth 가 깊어지긴 하나
View 를 Component 로 잘 묶어내면 이러한 부분은 해결할 수 있다고 생각합니다.</p>
<h1>Reference</h1>
<ul>
<li><a href="https://kean.github.io/post/swiftui-layout-system" target="_blank" rel="noopener noreferrer">SwiftUI Layout System</a></li>
<li><a href="https://www.hackingwithswift.com/books/ios-swiftui/how-layout-works-in-swiftui" target="_blank" rel="noopener noreferrer">How layout works in SwiftUI</a></li>
<li><a href="https://medium.com/@suyash.srijan/intro-to-swiftui-part-2-6b7e792c21ef" target="_blank" rel="noopener noreferrer">Intro to SwiftUI</a></li>
<li><a href="https://swiftwithmajid.com/2020/05/20/fitting-and-filling-view-in-swiftui/" target="_blank" rel="noopener noreferrer">Fitting and Filling views in SwiftUI</a></li>
</ul>]]></content>
        <category label="swiftui" term="swiftui"/>
        <category label="swift" term="swift"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[Introduction to Steganography]]></title>
        <id>https://yongseongkim.github.io/blog/2020/02/09/introduction-to-steganography/</id>
        <link href="https://yongseongkim.github.io/blog/2020/02/09/introduction-to-steganography/"/>
        <updated>2020-02-09T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[2020 년 새해를 맞아 사내 개발팀 워크샵 라이트닝 톡 발표를 위해 준비한 소재 Steganography 정리해봤습니다.]]></summary>
        <content type="html"><![CDATA[<p>2020 년 새해를 맞아 <a href="http://engineering.vcnc.co.kr/2019/01/vcnc-workshop-for-developers/" target="_blank" rel="noopener noreferrer">사내 개발팀 워크샵</a> 라이트닝 톡 발표를 위해 준비한 소재 Steganography 정리해봤습니다.</p>
<p>Steganography 는 메시지를 숨길 때 사용하는 기술로 다른 집단 혹은 개인에게 들키지 않고 메시지를 전달하는 게 목적입니다. 현대에서는 Watermarking 이나 FingerPrint 분야에서도 쓰입니다.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="steganography-vs-encryption">Steganography vs. Encryption<a href="https://yongseongkim.github.io/blog/2020/02/09/introduction-to-steganography/#steganography-vs-encryption" class="hash-link" aria-label="Direct link to Steganography vs. Encryption" title="Direct link to Steganography vs. Encryption">​</a></h2>
<p>Encryption 은 모든 사람이 메세지를 볼 수 있습니다. 하지만 정보를 얻으려면 암호화된 메세지를 풀 수 있는 열쇠가 필요하죠. 그래서 Encryption 은 풀기보다 못 읽게 하거나 없애는 게 더 쉽습니다.
Steganography 는 메시지 존재 자체를 숨기는 기술입니다. 전달하는 사람과 받는 사람 이외에 사람들은 비밀리에 메시지를 주고 받는 것도 모를 수 있습니다.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="history">History<a href="https://yongseongkim.github.io/blog/2020/02/09/introduction-to-steganography/#history" class="hash-link" aria-label="Direct link to History" title="Direct link to History">​</a></h2>
<p>Steganography 의 역사는 기원전 440년부터 시작합니다. 고대 그리스에서는 나무에 메시지를 적고 왁스로 덮는 방식을 이용했다고 합니다.
히스타이오스(Histiaeus)는 그리스에게 페르시안 공격을 전하기 위해 친애하는 노예의 머리를 밀고 메시지를 타투로 새겼습니다. 머리가 자라면서 메시지는 숨겨졌습니다.</p>
<p><img decoding="async" loading="lazy" src="http://4.bp.blogspot.com/-I-EUME4witY/TZbFjKb22SI/AAAAAAAAAGQ/0dJPgTDOo6w/s200/hh.jpg" alt="Tattoo on Head hidden by hair" class="img_ev3q"></p>
<p>출처: <a href="https://hareenlaks.blogspot.com/2011/04/history-of-steganography.html" target="_blank" rel="noopener noreferrer">hareenlaks's blog</a></p>
<p>세계 2차 대전에는 프랑스 저항군이 보이지 않는 잉크를 이용하여 메시지를 전달했습니다. 또한 간첩들은 microdots 을 이용해서 비밀 메시지를 담은 이미지를 생성하고 사용했습니다.
microdots 을 종이에 적고 collodion 용액으로 덮었습니다. 메시지는 빛을 비추면 보였습니다.
인형 딜러로 위장한 스파이는 얼마나 많은 인형을 배에 실을지에 대한 주문서에 메시지를 숨겨 배의 움직임을 알렸습니다.</p>
<p><img decoding="async" loading="lazy" src="http://1.bp.blogspot.com/-sWs2AStWpSI/TZbHnlrF3WI/AAAAAAAAAGY/C5RmqQOS7WM/s1600/md.jpg" alt="Enlarge view of a microdot" class="img_ev3q"></p>
<p>출처: <a href="https://hareenlaks.blogspot.com/2011/04/history-of-steganography.html" target="_blank" rel="noopener noreferrer">hareenlaks's blog</a></p>
<p>또한 911 테러에도 오사마 빈라덴이 테러에 스테가노그래피를 이용했다고 합니다. <a href="https://usatoday30.usatoday.com/life/cyber/tech/2001-02-05-binladen.htm" target="_blank" rel="noopener noreferrer">포르노 사진, 스포츠 채팅 창에서의 글들을 이용하여 미국 테러에 대한 지령을 전달했다고 합니다.</a></p>
<h1>Techniques for Steganography</h1>
<p>위의 역사에서 보듯이 메시지를 숨기는 방법은 다양합니다. 간단하게 사용되고 있는 여러 기술들을 소개하겠습니다.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="binary-file-techniques">Binary File Techniques<a href="https://yongseongkim.github.io/blog/2020/02/09/introduction-to-steganography/#binary-file-techniques" class="hash-link" aria-label="Direct link to Binary File Techniques" title="Direct link to Binary File Techniques">​</a></h2>
<p>CopyRight 를 프로그램 내에 새기는 방법 중 하나입니다.</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">a = 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">b = 3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">c = b + 3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">d = b + c</span><br></span></code></pre></div></div>
<p>위와 같은 코드에서 <code>a = 1</code> 의 위치는 중요하지 않습니다. <code>a = 1</code> 의 위치를 통해서 0 과 1 을 표현할 수 있습니다.
이 방법을 이용하기 위해 먼저 전체 코드를 n 개의 블락으로 나눕니다. 이렇게 나눈 n 개의 블락에서 <code>a = 1</code> 와 같은 코드의 위치를 변경하거나 그대로 둠으로써 숨기려는 메시지를 n 자리 이진수로 표현합니다.</p>
<p>[<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>w</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">w_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span></span></span></span>, <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>w</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">w_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span></span></span></span>, ..., <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>w</mi><mi>n</mi></msub></mrow><annotation encoding="application/x-tex">w_n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span></span></span></span>] (<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>w</mi><mo>=</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">w = 0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em"></span><span class="mord mathnormal" style="margin-right:0.02691em">w</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:0.6444em"></span><span class="mord">0</span></span></span></span> or <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>w</mi><mo>=</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">w = 1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em"></span><span class="mord mathnormal" style="margin-right:0.02691em">w</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:0.6444em"></span><span class="mord">1</span></span></span></span>)</p>
<p>이렇게 작업한 파일과 원본 파일을 비교해서 삽입된 메시지를 추출할 수 있습니다.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="text-techniques">Text Techniques<a href="https://yongseongkim.github.io/blog/2020/02/09/introduction-to-steganography/#text-techniques" class="hash-link" aria-label="Direct link to Text Techniques" title="Direct link to Text Techniques">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="whitespace-manipulation">Whitespace Manipulation<a href="https://yongseongkim.github.io/blog/2020/02/09/introduction-to-steganography/#whitespace-manipulation" class="hash-link" aria-label="Direct link to Whitespace Manipulation" title="Direct link to Whitespace Manipulation">​</a></h3>
<p>여백을 이용하는 여러 방법이 있습니다. 그 중 하나로 Line Shift 가 있습니다. 문서의 라인을 미세하게 올리거나 내려서 0 과 1 을 표현합니다. 약 1/300 인치를 이동시키기 때문에 사람의 눈으로는 파악하기가 힘듭니다. 또 Line Shift 와 비슷하게 Word Shift 가 있습니다. 단어를 아래 그림과 같이 왼쪽 오른쪽으로 미세하게 이동시켜 0 과 1을 표현할 수 있습니다.</p>
<p><img decoding="async" loading="lazy" alt="Word Shift Coding Example" src="https://yongseongkim.github.io/assets/images/text-technique-word-shift-coding-54ad6019922f38f34d1deed49e18bddf.png" width="568" height="98" class="img_ev3q"></p>
<p>또한 글 단락 사이라던지 문장의 끝에 특정 양의 빈 여백을 넣어 메시지를 표현할 수도 있습니다.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="feature-coding">Feature Coding<a href="https://yongseongkim.github.io/blog/2020/02/09/introduction-to-steganography/#feature-coding" class="hash-link" aria-label="Direct link to Feature Coding" title="Direct link to Feature Coding">​</a></h3>
<p>다양한 특성들을 이용하는 방법입니다. 예를 들면 특정 글자의 높이라던지 i 와 j 의 점을 이용하거나 f 와 t 처럼 수평적인 획의 길이를 이용하기도 합니다.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="xml">XML<a href="https://yongseongkim.github.io/blog/2020/02/09/introduction-to-steganography/#xml" class="hash-link" aria-label="Direct link to XML" title="Direct link to XML">​</a></h3>
<div class="language-xml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-xml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">img</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">img</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"> -&gt; 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">img</span><span class="token tag punctuation" style="color:#393A34">/&gt;</span><span class="token plain"> -&gt; 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">favorite</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">fruit</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">SOMETHING</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">fruit</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">favorite</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"> -&gt; 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">fruit</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">favorite</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">SOMETHING</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">favorite</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">fruit</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"> -&gt; 1</span><br></span></code></pre></div></div>
<p>위와 같이 데이터에 영향을 주지 않는 일정한 규칙을 통해 메시지를 나타낼 수 있습니다.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="image-techniques">Image Techniques<a href="https://yongseongkim.github.io/blog/2020/02/09/introduction-to-steganography/#image-techniques" class="hash-link" aria-label="Direct link to Image Techniques" title="Direct link to Image Techniques">​</a></h2>
<p>이미지를 이용한 간단한 방법을 소개합니다. 해킹 챌린지 사이트 <a href="http://www.wechall.net/challenge/training/" target="_blank" rel="noopener noreferrer">Wechall</a> 에서도 이미지와 관련된 steganography 문제를 다루고 있습니다.
해당 사이트에서 stegano1 디렉토리에 들어가면 아래와 같은 이미지를 볼 수 있습니다. 실제 크기는 굉장히 작습니다.</p>
<p><img decoding="async" loading="lazy" alt="Stegenography Image Technique Example" src="https://yongseongkim.github.io/assets/images/img-technique-wechall-example-4145f5e132c3fe13a81fba088f095211.png" width="188" height="192" class="img_ev3q"></p>
<p>이 파일을 읽으면 <code>BMf6(0Look what the hex-edit revealed: passwd:steganoI</code> 와 같은 메시지를 볼 수 있습니다. 이와 같이 단순한 이미지를 통해 메시지를 담는 방법을 알아보겠습니다.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="insertion">Insertion<a href="https://yongseongkim.github.io/blog/2020/02/09/introduction-to-steganography/#insertion" class="hash-link" aria-label="Direct link to Insertion" title="Direct link to Insertion">​</a></h3>
<p>파일마다 끝을 나타내는 EOF 바이트가 존재합니다. JPEG의 경우에는 <code>FF D9</code> 바이트로 끝나고 PNG 의 경우에는 <code>89 50 4E 47 0D 0A 1A 0A</code> 값으로 시작합니다. 파일이 끝났음을 나타내는 바이트 뒤 데이터는 무시합니다. 이 원리를 이용하여 파일이 끝났음을 나타내는 바이트 뒤로 데이터를 숨길 수 있습니다. 끝에 숨기는 것과 비슷하게 헤더에도 데이터를 숨길 수 있습니다. 파일 헤더 중 이미지에 영향을 주지 않는 부분에 데이터를 숨길 수 있습니다.
<a href="http://www.wechall.net/challenge/training/stegano/attachment/" target="_blank" rel="noopener noreferrer">Wechall</a> 에 들어가면 아래와 같은 이미지를 다운 받을 수 있습니다.</p>
<p><img decoding="async" loading="lazy" alt="Stegenography Image Technique Example - Insertion" src="https://yongseongkim.github.io/assets/images/img-technique-wechall-insertion-66a689633faf58d4bde68c3e99177419.png" width="221" height="350" class="img_ev3q"></p>
<p>단순히 이미지만 보면 예전에 인기를 끌었던 표지입니다.</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">with</span><span class="token plain"> </span><span class="token builtin">open</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'./ghostbusters.png'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'rb'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> f</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    result </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> f</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">read</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    b </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token builtin">bytearray</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">result</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<p>위 이미지를 bytearray 로 읽어오는 파이썬 코드를 작성해봅니다.</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">(생략)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x4a 0x3 0xff 0xd9 0x50 0x4b 0x3 0x4 0xa 0x0 0x0 0x0 0x0 0x0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x43 0x46 0x3a 0x50 0x26 0xbd 0xd2 0xfd 0xc 0x0 0x0 0x0 0xc 0x0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x0 0x0 0xc 0x0 0x0 0x0 0x73 0x6f 0x6c 0x75 0x74 0x69 0x6f 0x6e</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x2e 0x74 0x78 0x74 0x43 0x42 0x4e 0x53 0x50 0x45 0x42 0x41 0x45</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x47 0x48 0x41 0x50 0x4b 0x1 0x2 0x3f 0x3 0xa 0x0 0x0 0x0 0x0 0x0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x43 0x46 0x3a 0x50 0x26 0xbd 0xd2 0xfd 0xc 0x0 0x0 0x0 0xc 0x0 0x0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x0 0xc 0x0 0x0 0x0 0x0 0x0 0x0 0x0 0x0 0x0 0x0 0x0 0xb6 0x81 0x0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x0 0x0 0x0 0x73 0x6f 0x6c 0x75 0x74 0x69 0x6f 0x6e 0x2e 0x74 0x78</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x74 0x50 0x4b 0x5 0x6 0x0 0x0 0x0 0x0 0x1 0x0 0x1 0x0 0x3a 0x0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x0 0x0 0x36 0x0 0x0 0x0 0x0 0x0</span><br></span></code></pre></div></div>
<p>여기서 자세히 보면 JPEG Footer Signature 인 <code>0xff 0xd9</code> 값을 찾을 수 있습니다. 파일이 끝났다는 signature 이후에도 많은 데이터가 있는 것으로 보아 이 부분만을 추출해봅니다.
이후에 바로 이어지는 <code>0x50 0x4B 0x3 0x4</code> 는 ZIP Header Signature 이기도 합니다.</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">another </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">None</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> i </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token builtin">range</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token builtin">len</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">b</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token builtin">hex</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">b</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'0x50'</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token builtin">hex</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">b</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'0x4b'</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token builtin">hex</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">b</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'0x3'</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token builtin">hex</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">b</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'0x4'</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    another </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> b</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">with</span><span class="token plain"> </span><span class="token builtin">open</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'./ghosterbusters-extract.zip'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'wb'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> f</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    f</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">write</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">another</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<p>파이썬을 이용하여 JPEG 이후 데이터를 ZIP 파일로 저장합니다. 이후 압축을 풀면 'solution.txt' text file 을 얻을 수 있습니다.
<code>solution.text</code> 에는 <code>CBNSPEBAEGHA</code> 와 같은 코드명이 담겨있네요.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="lsb">LSB<a href="https://yongseongkim.github.io/blog/2020/02/09/introduction-to-steganography/#lsb" class="hash-link" aria-label="Direct link to LSB" title="Direct link to LSB">​</a></h3>
<p>다음으로 알아 볼 방법은 LSB (Least Significant Bit) 입니다. 24 비트 이미지 파일은 RGB 를 각 8비트씩 이용하여 색을 표현합니다.
여기서 1비트만 수정하여 메시지를 숨길 수 있습니다. 1비트만 수정하기 때문에 사람 눈으로는 알아채기 쉽지 않습니다.</p>
<p><a href="http://www.wechall.net/challenge/training/stegano/LSB/" target="_blank" rel="noopener noreferrer">Wechall</a> 에서도 LSB 에 대한 문제를 찾을 수 있습니다.</p>
<p><img decoding="async" loading="lazy" alt="Stegenography Image Technique Example - LSB" src="https://yongseongkim.github.io/assets/images/img-technique-wechall-lsb-a7623aff743c75621eaa7920e782af57.png" width="480" height="212" class="img_ev3q"></p>
<p>위 그림만 보면 전자제품의 부품 같네요. 이 이미지를 OpenCV 를 이용하여 풀어보겠습니다.</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> cv2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> numpy </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> np</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">img </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> cv2</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">imread</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'./lsb.png'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> cv2</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">IMREAD_COLOR</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">idx </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">bit </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token plain"> idx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Blue</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">img</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> np</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">bitwise_and</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">img</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> np</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">full</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">img</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">shape</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> img</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">shape</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> bit</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Green</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">img</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> np</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">zeros</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">img</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">shape</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> img</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">shape</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Red</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">img</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> np</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">zeros</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">img</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">shape</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> img</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">shape</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">img</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">img </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> bit</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">255</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cv2</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">imwrite</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'./lsb-modified.png'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> img</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<p>해당 이미지를 읽어 RGB 에 해당하는 LSB 와 AND 연산을 하는 코드입니다.</p>
<p>아래 이미지는 BLUE 0 번 비트와 AND 연산한 결과입니다.</p>
<p><img decoding="async" loading="lazy" alt="Stegenography Image Technique Example - LSB - 0" src="https://yongseongkim.github.io/assets/images/img-technique-wechall-lsb-idx0-8e8906277c998724d21de4bafac8bdd1.png" width="480" height="212" class="img_ev3q"></p>
<p>아래 이미지는 BLUE 1 번 비트와 AND 연산한 결과입니다.</p>
<p><img decoding="async" loading="lazy" alt="Stegenography Image Technique Example - LSB - 0" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAeAAAADUCAIAAADLKmfNAAAH50lEQVR4Ae3BAY7cyJYEQY/7HzoWBB6Qy0J1kWyN9FNqNwuSpC0FSdKWgiRpS0GStKUgSdpSkCRtKUiSthQkSVsKkqQtBUnSloIkaUtBkrSlIEnaUpAkbSlIkrYUJElbCpKkLQVJ0paCJGlLQZK0pSBJ2lKQJG0pSJK2FCRJWwqSpC0FSdKWgiRpS0GStKUgSdpSkCRtKUiSthQkSVsKkqQtBUnSloIkaUtBkrSlIEnaUpAkbSlIkrYUJElbCpKkLQVJ0paCJGlLQdIfVQjSDUHS71XeCNKVIOm/VG4J0pUg6b9UbgnSlSDpQhnhWnkVpG8Jki6UEa6VEaRfEyRdKCNcKyNIvyZIP1QZ4UJZwoWyBOkXBOmHKiNcKEu4VkaQfkGQ/kHlJLxRRrhWRrhWRnijHIJ0JUj/jvJJOClLuFBGuFZGGOWNIH0UpH9BuSUsZQkXygjXyi1B+ihI/4JyEg7lVTgpI1woI1wr14J0JUibKm+EN8oSXpURXpURLpQRbiknQXouSNspF8JJGeGZMsKFsoRrZQTpu4K0l3JLWMoIz5QRrpURrpURpO8K0p9QXoU3ykk4KSdhlBGeKSNcKyNcKyNI3xWk36LcEpayhPfKEkYZ4ZmyhAtlhGtlBOm7gvQfK8+EUUb4pIwwyl3hVRnhQhnhWlmC9C1Beqa8CifljbCUkzDKCJ+UJYzyQFjKCBfKEq6VEaRvCdKFcksYZQlfKiMcyhIulBGWcldYygjXygjXygjStwRpKSMcyjPhUJbwpbIEygjXyggPlCWMMsK1MsKrsoRDGUH6liCNsoRDeSMs5SSMMsInZQTKCNfKCM+UEUZZwoUyAuVL4VCWID0X9COU98JJGeFQlvClMsIoI3xSRqCMcK0s4YEywlJGuFBuCYeyBOm5oH9cuRCWsgTKEr5UlnAoI3ypLOFQRrhWRnigjLCUEV6VJVA+CdJ/KuifVe4KoyzhUEb4pIxwKCN8qSzhUEa4VkZ4oIywlBEoXwqUkyD9TkF/k7KET8qrsJQlLGUJhzLCJ2WEUQ7hjXISRhnhWhnhpBDeK0tYyi1B+rOC/hrlJHxSlvBGOYRXZYRDGeFLZQmjjDDKG2EpI1wrI4yyhFdlCSflkyD9jwT9Ncqr8KUywjNlhEMZ4UtlCaNcCydlhAtlhFEeCCflJEh7CPprlFfhvbKEZ8oIoxzCG+UkLOWT8F4Z4ZMywii3BOnvEfSnlRGeKW+EN8oIj5URRhlhlDfCSXkVrpUlvFeWsJRPgvS3CfrTygjPlPfCqzLCY2UJh3ItvFEO4YFyEk7KSZD+aUG/SzkJo4zwTBmBsoRXZYTvKCMcyifhS+UQnim3BOlfF/S7lJMwyhIeKCNQTsJJGeFL5VUYZYRDeRVuKSM8Uy4E6QcI+l3KSRhlCXeVJRzKEl6VEV6VL4VDGWGUQ3imjPBYeS9IP0bQLeUkXCsnYSkj3FWWMMoSTsoIr8qXwqGMMMohPFNGkPRc0C3lVfikvApLGeGusoRRlnBSRnhVRhhlhENZwqGM8EAZQdJzQbeUV+GT8iosZYS7yggnZQlLGeFaGeFQlnAoIzxQliDpoaBbyhvhS+WNMMoId5URTspJGGUJF8oIo4xwKCM8UJYg6aGgW8ob4UvljTDKCLeUu8JSRrhQRhhlhEMZQdKfEnRXeSO8V0agjDDKEq6VB8IoS/hSWcIoS6AsQdIfEXRXeS+8UUagjLCUEa6VB8JSTsJJOQlLWQJlCZL+iKC7ygiUJbwqIxzKCEsZ4VpZwhvlJCzllnBSliDpfyHorjLCoSzhpIxwKEsYZYRrZQnvlZOwlAtB0n6C7iojHMpJWMoIo4wwyggXyhK+VE7Cq/IqSNpY0F1lCYeyhKWMMMoIoyzhk7KET8pJkPQ3C3qgjDDKEg5lCaOMsJQRPilL+KSMIOnvF/RAGWGUk0AZYSkjLGWEV+W9IOnHCHqgjLCUJVBGWMoSRhmBckuQ9GMEPVBGWMp7YSlLGOWWIOlHCnqgLGEpb4SlLGGUT4Kkny3omTLCSXkVTsoIo5wESfp/gp4pI5yUk/CqLEGSrgQ9U0Z4VZbwqowgSTcEPVOWcFKWIEm/JuiZsgRJ+m2CnilLkKTfJkiSthQkSVsKkqQtBUnSloIkaUtBkrSlIEnaUpAkbSlIkrYUJElbCpKkLQVJ0paCJGlLQZK0pSBJ2lKQJG0pSJK2FCRJWwqSpC0FSdKWgiRpS0GStKUgSdpSkCRtKUiSthQkSVsKkqQtBUnSloIkaUtBkrSlIEnaUpAkbSlIkrYUJElbCpKkLQVJ0paCJGlLQZK0pSBJ2lKQJG0pSJK2FCRJWwqSpC0FSdKWgiRpS0GStKUgSdpSkCRtKUiSthQkSVsKkqQtBUnSloIkaUtBkrSlIEnaUpAkbSlIkrYUJElbCpKkLQVJ0paCJGlLQZK0pSBJ2lKQJG0pSJK2FCRJWwqSpC0FSdKWgiRpS0GStKUgSdpSkCRtKUiSthQkSVsKkqQtBUnSloIkaUtBkrSlIEnaUpAkbSlIkrYUJElbCpKkLQVJ0paCJGlLQZK0pSBJ2lKQJG0pSJK2FCRJWwqSpC0FSdKWgiRpS0GStKUgSdpSkCRtKUiSthQkSVsKkqQtBUnSloIkaUtBkrSlIEnaUpAkbSlIkrYUJElbCpKkLQVJ0paCJGlLQZK0pSBJ2lKQJG3p/wD+GH3kQvejugAAAABJRU5ErkJggg==" width="480" height="212" class="img_ev3q"></p>
<p>위와 같이 메세지가 숨겨져 있는 것을 볼 수 있습니다.
이 방법은 비트가 올라가면 올라갈수록 원 이미지를 훼손하게 됩니다.</p>
<p><img decoding="async" loading="lazy" alt="Stegenography Image Technique Example - LSB - Bit Used" src="https://yongseongkim.github.io/assets/images/img-technique-lsb-bit-used-a6b33cf0224d3294f10b20eea65073af.jpg" width="576" height="416" class="img_ev3q"></p>
<p>출처: <a href="https://www.cs.bham.ac.uk/~mdr/teaching/modules03/security/students/SS5/Steganography.htm" target="_blank" rel="noopener noreferrer">Steganography And Digital WaterMarking</a></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="deep-learning">Deep Learning<a href="https://yongseongkim.github.io/blog/2020/02/09/introduction-to-steganography/#deep-learning" class="hash-link" aria-label="Direct link to Deep Learning" title="Direct link to Deep Learning">​</a></h3>
<p>마지막으로 알아볼 기술은 Deep Learning 을 이용한 기술입니다. 아래 그림과 같은 네트워크를 이용하여 이미지를 만들어냅니다.</p>
<p><img decoding="async" loading="lazy" alt="Stegenography Image Technique Example - Deep Learning Network" src="https://yongseongkim.github.io/assets/images/img-technique-deep-learning-network-be005b6e4f661dc562774f2f12d83bfe.png" width="1183" height="321" class="img_ev3q"></p>
<p>출처: <a href="https://buzzrobot.com/hiding-images-using-ai-deep-steganography-b7726bd58b06" target="_blank" rel="noopener noreferrer">Hiding Images using AI — Deep Steganography</a></p>
<p>숨기려는 이미지 (Secret Image) 와 포장하려는 이미지 (Cover Image) 를 Input 으로 Covered Output 을 만듭니다. 그리고 이를 해석할 Reveal Network 를 통해 다시 Secret 이미지를 추출합니다.
여기서에 오차는 (Input 으로 사용한 Cover 이미지 - 비밀이미지를 담은 결과물) + (Input 으로 사용한 Secret 이미지 - Reveal Network 으로 뽑아낸 Secret 이미지) 로 합니다.</p>
<p><img decoding="async" loading="lazy" alt="Stegenography Image Technique Example - Deep Learning" src="https://yongseongkim.github.io/assets/images/img-technique-deep-learning-17b926823a3cc86c371f555e065c0746.png" width="1172" height="654" class="img_ev3q"></p>
<p>출처: <a href="https://buzzrobot.com/hiding-images-using-ai-deep-steganography-b7726bd58b06" target="_blank" rel="noopener noreferrer">Hiding Images using AI — Deep Steganography</a></p>
<p>위 사진은 이전에 설명한 네트워크의 결과물입니다. 더 자세한 내용은 해당 블로그 <a href="https://buzzrobot.com/hiding-images-using-ai-deep-steganography-b7726bd58b06" target="_blank" rel="noopener noreferrer">Hiding Images using AI</a> 참고하시면 됩니다.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="sound-techniques">Sound Techniques<a href="https://yongseongkim.github.io/blog/2020/02/09/introduction-to-steganography/#sound-techniques" class="hash-link" aria-label="Direct link to Sound Techniques" title="Direct link to Sound Techniques">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="spectogram">Spectogram<a href="https://yongseongkim.github.io/blog/2020/02/09/introduction-to-steganography/#spectogram" class="hash-link" aria-label="Direct link to Spectogram" title="Direct link to Spectogram">​</a></h3>
<p>Spectogram 은 소리나 파동을 시각화하는 방법입니다. 시간축, 주파수 축 변화에 따라 진폭의 차이를 색상의 차이로 나타냅니다. 이와 같이 소리에도 메시지를 숨길 수 있습니다.</p>
<p><img decoding="async" loading="lazy" alt="Stegenography Sound Technique Example" src="https://yongseongkim.github.io/assets/images/sounnd-technique-example-622e0523c29dcbd3183fc7eb99d1abb7.png" width="250" height="225" class="img_ev3q"></p>
<p><a href="http://www.bastwood.com/?page_id=10" target="_blank" rel="noopener noreferrer">The Apex Face</a> 의 글을 보시면 재밌는 이미지를 볼 수 있습니다.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="echo-hiding">Echo Hiding<a href="https://yongseongkim.github.io/blog/2020/02/09/introduction-to-steganography/#echo-hiding" class="hash-link" aria-label="Direct link to Echo Hiding" title="Direct link to Echo Hiding">​</a></h3>
<p>에코를 이용하여 데이터를 숨기는 방법도 있습니다. 진폭, Decay 비율, Offset 을 사람들이 알아채지 못할 정도로 설정하여 메시지를 전달합니다.</p>
<h1>Conclusion</h1>
<p>메시지를 숨기는 간단한 방법들을 알아봤습니다. Sound Technique 에는 1940년 대 군에서 많이 쓰인 Spread Spectrum, Parity Bit 개념을 이용한 Parity Coding, 사람들이 파악하기 힘든 Phase 변조를 통한 Phase Coding 등이 있습니다.
또한 이미지와 소리 기술은 비디오에서도 적용할 수 있습니다. 현대에서는 Watermarking 문제를 위해 이러한 기술들이 발전되고 있으니 다른 기술들도 찾아보시면 재밌겠네요.</p>
<h1>Reference</h1>
<ul>
<li><a href="http://hareenlaks.blogspot.com/2011/04/history-of-steganography.html#more" target="_blank" rel="noopener noreferrer">Steganography 의 역사</a></li>
<li><a href="https://bpsecblog.wordpress.com/2016/08/21/amalmot_4/" target="_blank" rel="noopener noreferrer">Wechall 문제 해석</a></li>
<li><a href="https://www.cs.bham.ac.uk/~mdr/teaching/modules03/security/students/SS5/Steganography.htm" target="_blank" rel="noopener noreferrer">Steganography And Digital Watermarking</a></li>
<li><a href="https://buzzrobot.com/hiding-images-using-ai-deep-steganography-b7726bd58b06" target="_blank" rel="noopener noreferrer">Hiding Images using AI</a></li>
</ul>]]></content>
        <category label="steganography" term="steganography"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[AlphaGo Paper Review (2)]]></title>
        <id>https://yongseongkim.github.io/blog/2019/02/02/alphago-zero/</id>
        <link href="https://yongseongkim.github.io/blog/2019/02/02/alphago-zero/"/>
        <updated>2019-02-02T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[이세돌과의 경기로 AlphaGo Lee 에 대한 존재와 원리는 어느 정도 알고는 있었지만,]]></summary>
        <content type="html"><![CDATA[<p>이세돌과의 경기로 AlphaGo Lee 에 대한 존재와 원리는 어느 정도 알고는 있었지만,
다음 버전 AlphaGo Zero 에 대해서는 상대적으로 관심이 적어 찾아볼 생각을 하지 않았었습니다.
AlphaGo Lee 를 공부하게 되면서 AlphaGo Zero 에 대해서도 찾아보고 정리를 하게 되었습니다.</p>
<p>AlphaGo Zero 는 2017년 5/32 부터 5/27 까지 프로바둑기사 커제(KeJie) 와 바둑 게임을 한 딥러닝 모델입니다.
AlphaGo Zero 는 커제와의 경기에서 3:0 으로 승리를 거둡니다. 그리고 이전 AlphaGo 모델과의 경기는 100-0 으로 승리합니다.</p>
<h1>AlphaGo Zero vs. AlphaGo Lee</h1>
<p>AlphaGo Zero 는 AlphaGo Lee 와 어떤 점이 다를까요?</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="사람의-지식-없이-훈련되었다">사람의 지식 없이 훈련되었다.<a href="https://yongseongkim.github.io/blog/2019/02/02/alphago-zero/#%EC%82%AC%EB%9E%8C%EC%9D%98-%EC%A7%80%EC%8B%9D-%EC%97%86%EC%9D%B4-%ED%9B%88%EB%A0%A8%EB%90%98%EC%97%88%EB%8B%A4" class="hash-link" aria-label="Direct link to 사람의 지식 없이 훈련되었다." title="Direct link to 사람의 지식 없이 훈련되었다.">​</a></h3>
<p>AlphaGo Lee 에서는 전문가의 기보를 SL Policy Network, Rollout Policy Network 가 학습하여 다음 수를 예측했습니다.
하지만 AlphaGo Zero 에서는 사람의 지식 없이 무작위로 수를 두면서 학습합니다.
논문의 이름도 'Mastering the game of Go without Human Knowledge' 입니다.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="바둑판의-상태만-입력으로-받았다">바둑판의 상태만 입력으로 받았다.<a href="https://yongseongkim.github.io/blog/2019/02/02/alphago-zero/#%EB%B0%94%EB%91%91%ED%8C%90%EC%9D%98-%EC%83%81%ED%83%9C%EB%A7%8C-%EC%9E%85%EB%A0%A5%EC%9C%BC%EB%A1%9C-%EB%B0%9B%EC%95%98%EB%8B%A4" class="hash-link" aria-label="Direct link to 바둑판의 상태만 입력으로 받았다." title="Direct link to 바둑판의 상태만 입력으로 받았다.">​</a></h3>
<p>AlphaGo Lee 에서는 Rollout Policy Network 가 <a href="https://senseis.xmp.net/?Nakade" target="_blank" rel="noopener noreferrer">일종의 패턴</a>을 입력으로 받았습니다.
하지만 AlphaGo Zero 에서는 단순히 바둑판의 상태만을 입력으로 받습니다.
현재 흑의 위치, 7수만큼의 흑의 위치, 현재 백의 위치, 7수만큼의 백의 위치 그리고 현재 플레이하고 있는 돌의 색깔까지 해서 총 17가지를 입력으로 받습니다. (<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>19</mn><mo>∗</mo><mn>19</mn><mo>∗</mo><mn>17</mn></mrow><annotation encoding="application/x-tex">19*19*17</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em"></span><span class="mord">19</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:0.6444em"></span><span class="mord">19</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:0.6444em"></span><span class="mord">17</span></span></span></span>)</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="단-하나의-neural-network-를-사용했다">단 하나의 Neural Network 를 사용했다.<a href="https://yongseongkim.github.io/blog/2019/02/02/alphago-zero/#%EB%8B%A8-%ED%95%98%EB%82%98%EC%9D%98-neural-network-%EB%A5%BC-%EC%82%AC%EC%9A%A9%ED%96%88%EB%8B%A4" class="hash-link" aria-label="Direct link to 단 하나의 Neural Network 를 사용했다." title="Direct link to 단 하나의 Neural Network 를 사용했다.">​</a></h3>
<p>AlphaGo Lee 에서 Policy Network, Value Network 를 따로 두었던 것과는 다르게 AlphaGo Zero 에서는 하나로 합칩니다.
단일 Network 는 바둑판의 상태를 입력으로 받아 다음 수의 확률분포와 승률을 같이 출력합니다.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="학습에-mcts-를-사용한다">학습에 MCTS 를 사용한다.<a href="https://yongseongkim.github.io/blog/2019/02/02/alphago-zero/#%ED%95%99%EC%8A%B5%EC%97%90-mcts-%EB%A5%BC-%EC%82%AC%EC%9A%A9%ED%95%9C%EB%8B%A4" class="hash-link" aria-label="Direct link to 학습에 MCTS 를 사용한다." title="Direct link to 학습에 MCTS 를 사용한다.">​</a></h3>
<p>사람의 지식 없이 어떻게 훈련을 하는지에 대한 핵심입니다.
다양한 시뮬레이션으로 어떤 수가 좋은 지 스스로 배워갑니다.
AlphaGo Lee 에서 수 읽기 시간에 다음 수를 두기 위해서만 MCTS 를 사용했지만, AlphaGo Zero 는 학습에 MCTS 를 활용합니다.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="new-reinforcement-learning-algorithm">New Reinforcement Learning Algorithm<a href="https://yongseongkim.github.io/blog/2019/02/02/alphago-zero/#new-reinforcement-learning-algorithm" class="hash-link" aria-label="Direct link to New Reinforcement Learning Algorithm" title="Direct link to New Reinforcement Learning Algorithm">​</a></h2>
<p>전문가들의 기보 없이 어떻게 스스로 성장할까요?</p>
<p>이 알고리즘의 가장 중요한 점은 매 수를 두는 과정에서 매번 MCTS 를 사용한다는 것입니다.
다양한 시뮬레이션을 통해 얻은 수가 랜덤 확률의 수보다 승률이 높은 점을 이용하여 전문가의 기보 없이도 성장할 수 있었던 것입니다.
새로운 Network 의 입력으로는 현재 바둑판의 상태와 7수 정도의 기록을 봅니다. 그리고 수가 놓이는 확률분포와 승률을 출력으로 내뱉습니다.
기존에는 단순히 CNN 을 썼던 것과는 다르게, 많은 Residual block 을 함께 썼습니다.
Residual network 는 Image Recognition 대회에서 좋은 성적을 거둔 Network 의 하나입니다.</p>
<p><img decoding="async" loading="lazy" alt="MCTS in training" src="https://yongseongkim.github.io/assets/images/mcts-training-data-9e3659dc26114dddda49efdb5edcb354.png" width="480" height="180" class="img_ev3q"></p>
<p>출처: <a href="https://www.nature.com/articles/nature24270" target="_blank" rel="noopener noreferrer">Mastering the game of Go without Human Knowledge</a></p>
<p>위 그림처럼 매 상태 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>s</mi><mi>t</mi></msub></mrow><annotation encoding="application/x-tex">s_t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em"></span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span></span></span></span>마다 가장 최근에 학습시킨 Neural Network 를 이용해서 MCTS 계산을 합니다.
학습되기 전 초기 Neural Network 는 랜덤 위치에 둘 것입니다.
MCTS 계산을 하면 다음 수의 위치가 확률 분포가 나오고 이게 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>π</mi><mi>t</mi></msub></mrow><annotation encoding="application/x-tex">\pi_t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em">π</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span></span></span></span>가 됩니다.
여기서 나온 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>π</mi><mi>t</mi></msub></mrow><annotation encoding="application/x-tex">\pi_t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em">π</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span></span></span></span> 에서 가장 큰 값의 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>a</mi><mi>t</mi></msub></mrow><annotation encoding="application/x-tex">a_t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em"></span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span></span></span></span> 를 선택하여 다음 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>s</mi><mrow><mi>t</mi><mo>+</mo><mn>1</mn></mrow></msub></mrow><annotation encoding="application/x-tex">s_{t+1}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6389em;vertical-align:-0.2083em"></span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em"><span></span></span></span></span></span></span></span></span></span> 상태로 넘어갑니다.
이와 같은 과정을 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>s</mi><mi>T</mi></msub></mrow><annotation encoding="application/x-tex">s_T</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em"></span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em">T</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span></span></span></span> 게임이 끝난 상태까지 반복하게 됩니다.
종료 상태에 도달하게 되면 게임에 대한 승패 (+1, -1) 보상 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>z</mi></mrow><annotation encoding="application/x-tex">z</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em"></span><span class="mord mathnormal" style="margin-right:0.04398em">z</span></span></span></span> 가 결정됩니다.
이렇게 한 게임이 끝날 때마다 데이터 (<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>s</mi><mn>1</mn></msub><mo separator="true">,</mo><msub><mi>π</mi><mn>1</mn></msub><mo separator="true">,</mo><mi>z</mi></mrow><annotation encoding="application/x-tex">s_1, \pi_1, z</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em"></span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em">π</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord mathnormal" style="margin-right:0.04398em">z</span></span></span></span>), (<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>s</mi><mn>2</mn></msub><mo separator="true">,</mo><msub><mi>π</mi><mn>2</mn></msub><mo separator="true">,</mo><mi>z</mi></mrow><annotation encoding="application/x-tex">s_2, \pi_2, z</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em"></span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em">π</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord mathnormal" style="margin-right:0.04398em">z</span></span></span></span>) ... (<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>s</mi><mi>t</mi></msub><mo separator="true">,</mo><msub><mi>π</mi><mi>t</mi></msub><mo separator="true">,</mo><mi>z</mi></mrow><annotation encoding="application/x-tex">s_t, \pi_t, z</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em"></span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em">π</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord mathnormal" style="margin-right:0.04398em">z</span></span></span></span>) 가 모입니다.</p>
<p><img decoding="async" loading="lazy" alt="MCTS Leaning" src="https://yongseongkim.github.io/assets/images/mcts-learning-c55130504e8765f385731adefc9f5c94.png" width="499" height="285" class="img_ev3q"></p>
<p>출처: <a href="https://www.nature.com/articles/nature24270" target="_blank" rel="noopener noreferrer">Mastering the game of Go without Human Knowledge</a></p>
<p>이 그림은 위에서 얻은 데이터 집합으로 학습하는 그림입니다.
함수 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi><mo stretchy="false">(</mo><mi>θ</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">f(\theta)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord mathnormal" style="margin-right:0.10764em">f</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.02778em">θ</span><span class="mclose">)</span></span></span></span> 의 입력으로 상태 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>s</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">s_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em"></span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span></span></span></span> 을 넣으면 결과로 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>p</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">p_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em"></span><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span></span></span></span> 과 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>v</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">v_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span></span></span></span> 이 나옵니다.
여기서 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>p</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">p_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em"></span><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span></span></span></span> 과 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>π</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">\pi_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em">π</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span></span></span></span> 이 비슷해지도록, <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>v</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">v_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span></span></span></span> 과 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>z</mi></mrow><annotation encoding="application/x-tex">z</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em"></span><span class="mord mathnormal" style="margin-right:0.04398em">z</span></span></span></span> 의 차이를 줄이는 방향으로 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>θ</mi></mrow><annotation encoding="application/x-tex">\theta</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em"></span><span class="mord mathnormal" style="margin-right:0.02778em">θ</span></span></span></span> 를 업데이트합니다.
또 상태 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>s</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">s_2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em"></span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span></span></span></span> 을 넣어 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>p</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">p_2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em"></span><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span></span></span></span>, <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>v</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">v_2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span></span></span></span> 를 구하고 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>π</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">\pi_2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em">π</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span></span></span></span>, <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>z</mi></mrow><annotation encoding="application/x-tex">z</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em"></span><span class="mord mathnormal" style="margin-right:0.04398em">z</span></span></span></span> 와 비슷해지도록 학습합니다.
위와 같은 과정을 반복하여 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi><mo stretchy="false">(</mo><mi>θ</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">f(\theta)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord mathnormal" style="margin-right:0.10764em">f</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.02778em">θ</span><span class="mclose">)</span></span></span></span> 가 상태 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi></mrow><annotation encoding="application/x-tex">s</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em"></span><span class="mord mathnormal">s</span></span></span></span> 를 입력으로 받아 다음 수에 대한 확률분포, 승률을 예측하는 Neural Network 로 완성됩니다.</p>
<p>여기서 오차함수는 아래와 같이 정의합니다.</p>
<p><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>l</mi><mo>=</mo><mo stretchy="false">(</mo><mi>z</mi><mo>−</mo><mi>v</mi><msup><mo stretchy="false">)</mo><mn>2</mn></msup><mo>−</mo><msup><mi>π</mi><mi>T</mi></msup><mi>l</mi><mi>o</mi><mi>g</mi><mo stretchy="false">(</mo><mi>p</mi><mo stretchy="false">)</mo><mo>+</mo><mi>c</mi><mi mathvariant="normal">∣</mi><mi mathvariant="normal">∣</mi><mi>θ</mi><mi mathvariant="normal">∣</mi><msup><mi mathvariant="normal">∣</mi><mn>2</mn></msup></mrow><annotation encoding="application/x-tex">l = (z-v)^2 - \pi^T log(p) + c ||\theta||^2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em"></span><span class="mord mathnormal" style="margin-right:0.01968em">l</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.04398em">z</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:1.0641em;vertical-align:-0.25em"></span><span class="mord mathnormal" style="margin-right:0.03588em">v</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em"><span style="top:-3.063em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:1.0913em;vertical-align:-0.25em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em">π</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em"><span style="top:-3.063em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em">T</span></span></span></span></span></span></span></span><span class="mord mathnormal" style="margin-right:0.01968em">l</span><span class="mord mathnormal">o</span><span class="mord mathnormal" style="margin-right:0.03588em">g</span><span class="mopen">(</span><span class="mord mathnormal">p</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:1.0641em;vertical-align:-0.25em"></span><span class="mord mathnormal">c</span><span class="mord">∣∣</span><span class="mord mathnormal" style="margin-right:0.02778em">θ</span><span class="mord">∣</span><span class="mord"><span class="mord">∣</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em"><span style="top:-3.063em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span></p>
<h1>MCTS: Monte Carlo Tree Search</h1>
<p><img decoding="async" loading="lazy" alt="MCTS Leaning" src="https://yongseongkim.github.io/assets/images/mcts-step-5f599d2dcc04624f21c0eebefc7dedfc.png" width="790" height="220" class="img_ev3q"></p>
<p>출처: <a href="https://www.nature.com/articles/nature24270" target="_blank" rel="noopener noreferrer">Mastering the game of Go without Human Knowledge</a></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="select">Select<a href="https://yongseongkim.github.io/blog/2019/02/02/alphago-zero/#select" class="hash-link" aria-label="Direct link to Select" title="Direct link to Select">​</a></h3>
<p>AlphaGoLee 에서와 같이 트리에서 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Q</mi><mo>+</mo><mi>U</mi></mrow><annotation encoding="application/x-tex">Q+U</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em"></span><span class="mord mathnormal">Q</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:0.6833em"></span><span class="mord mathnormal" style="margin-right:0.10903em">U</span></span></span></span> 값이 큰 방향으로 선택하며 내려갑니다.
상태 s 에서 행동 a 를 취했을 때 얼마만큼의 가치가 있는지를 나타내는 게 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Q</mi><mo stretchy="false">(</mo><mi>s</mi><mo separator="true">,</mo><mi>a</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">Q(s, a)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord mathnormal">Q</span><span class="mopen">(</span><span class="mord mathnormal">s</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord mathnormal">a</span><span class="mclose">)</span></span></span></span> 입니다.
<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>U</mi></mrow><annotation encoding="application/x-tex">U</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em"></span><span class="mord mathnormal" style="margin-right:0.10903em">U</span></span></span></span> 는 방문 횟수 N(s, a) 와 사전확률 P(s, a) 에 따라 값이 달라집니다.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="expand-and-evaluate">Expand and Evaluate<a href="https://yongseongkim.github.io/blog/2019/02/02/alphago-zero/#expand-and-evaluate" class="hash-link" aria-label="Direct link to Expand and Evaluate" title="Direct link to Expand and Evaluate">​</a></h3>
<p><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Q</mi><mo>+</mo><mi>U</mi></mrow><annotation encoding="application/x-tex">Q+U</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em"></span><span class="mord mathnormal">Q</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:0.6833em"></span><span class="mord mathnormal" style="margin-right:0.10903em">U</span></span></span></span> 값을 따라 내려간 후 둔 수에서 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi><mo stretchy="false">(</mo><mi>θ</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">f(\theta)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord mathnormal" style="margin-right:0.10764em">f</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.02778em">θ</span><span class="mclose">)</span></span></span></span> 를 이용해 수를 둡니다. 그리고 그 수에 대한 평가 과정을 거칩니다.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="backup">Backup<a href="https://yongseongkim.github.io/blog/2019/02/02/alphago-zero/#backup" class="hash-link" aria-label="Direct link to Backup" title="Direct link to Backup">​</a></h3>
<p>평가한 후 따라갔던 트리 노드들의 값들도 갱신해줍니다.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="play">Play<a href="https://yongseongkim.github.io/blog/2019/02/02/alphago-zero/#play" class="hash-link" aria-label="Direct link to Play" title="Direct link to Play">​</a></h3>
<p>트리를 만들고 나면 어느 정도 시뮬레이션을 거친 다음 수에 대한 확률분포를 얻게 되는데 이 값을 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>π</mi></mrow><annotation encoding="application/x-tex">\pi</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em"></span><span class="mord mathnormal" style="margin-right:0.03588em">π</span></span></span></span> 라고 합니다.</p>
<h1>Resources and Performance</h1>
<p>AlphaGo Zero 는 전문가의 수를 배우지 않고 스스로 랜덤한 수부터 시작하여 나중에는 월등한 실력을 보여줍니다.</p>
<p><img decoding="async" loading="lazy" alt="MCTS Leaning" src="https://yongseongkim.github.io/assets/images/elo-rating-0c47d2f5db2c237345b9858868e856f8.png" width="260" height="260" class="img_ev3q"></p>
<p>출처: <a href="https://www.nature.com/articles/nature24270" target="_blank" rel="noopener noreferrer">Mastering the game of Go without Human Knowledge</a></p>
<p>그것도 단 3일 만에 AlphaGo Lee 를 뛰어넘습니다. 참고로 <a href="https://ko.wikipedia.org/wiki/%EC%97%98%EB%A1%9C_%ED%8F%89%EC%A0%90_%EC%8B%9C%EC%8A%A4%ED%85%9C" target="_blank" rel="noopener noreferrer">Elo Rating</a>
은 평점 산출법의 하나입니다.
매번 MCTS 를 수행하는 AlphaGo Zero 에서 얼마만큼의 MCTS 를 하느냐도 중요합니다.
너무 많이 MCTS 를 수행하면 시간이 오래 걸리고 또 적게 한다면 학습 속도가 느려질 수 있기 때문입니다.
AlphaGo Zero 는 매번 1600 의 MCTS 과정을 거쳤다고 합니다. 또한 490만 self-play 를 했다고 합니다.</p>
<p><img decoding="async" loading="lazy" alt="MCTS Leaning" src="https://yongseongkim.github.io/assets/images/prediction-professional-move-d124c6a16e8a20d012d5d3773b099d7d.png" width="290" height="310" class="img_ev3q"></p>
<p>출처: <a href="https://www.nature.com/articles/nature24270" target="_blank" rel="noopener noreferrer">Mastering the game of Go without Human Knowledge</a></p>
<p>또 재밌는 점은 전문가 수 예측 확률이 기존에 전문가 수를 배운 Network 보다 더 낮습니다.
실제로 바둑 기사들이 두는 수가 최적이 아닐 수도 있겠네요.</p>
<h1>Conclusion</h1>
<p>AlphaGo Zero 는 AlphaGo Lee 와 가장 크게 다른 점은 사람의 지식 없이 학습했다는 것입니다.
스스로 매 게임 매 수마다 다양하게 수를 경험하며 쌓은 MCTS 로 성장합니다.
단일 Network 로 학습 속도도 빠르며 실력도 월등히 좋아졌습니다.</p>]]></content>
        <category label="reinforcement learning" term="reinforcement learning"/>
        <category label="alphago" term="alphago"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[AlphaGo Paper Review]]></title>
        <id>https://yongseongkim.github.io/blog/2019/01/19/alphago-lee/</id>
        <link href="https://yongseongkim.github.io/blog/2019/01/19/alphago-lee/"/>
        <updated>2019-01-19T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[최근 David Silver 교수의 Reinforcement Learning Course 를 보면서 강화학습에 대해 공부하다 연장선상으로 뒤늦게 AlphaGo 논문을 읽었습니다.]]></summary>
        <content type="html"><![CDATA[<p>최근 David Silver 교수의 <a href="https://youtu.be/2pWv7GOvuf0" target="_blank" rel="noopener noreferrer">Reinforcement Learning Course</a> 를 보면서 강화학습에 대해 공부하다 연장선상으로 뒤늦게 AlphaGo 논문을 읽었습니다.
바둑에 대해 전혀 모르더라도 AlphaGo 가 어떻게 동작하는지는 이해할 수 있었습니다.
벌써 2-3년이 지난 논문이지만 간단하게 정리해봤습니다.</p>
<p>AlphaGo Lee 는 2016년 3/9 부터 3/15 까지 프로바둑 기사 이세돌과 바둑 게임을 한 딥러닝 모델입니다.
이세돌과 경기를 하기 전에는 유럽 바둑대회를 우승했던 Fan Hui 와 붙어 이겼습니다.
AlphaGo 는 크게 AlphaGo Lee / AlphaGo Zero 버전으로 나뉘는데 여기서는 AlphaGo Lee 만 정리하려 합니다.</p>
<p>바둑은 두 플레이어가 각각 흑백 돌을 두면서 많은 진영을 가진 자가 이기는 게임입니다.
돌을 두기까지 제한된 시간을 쓸 수 있는데 AlphaGo 는 이 시간 동안 트리를 이용하여 경우의 수를 탐색한 후 가장 좋은 수를 둡니다.
이미 컴퓨터로 정복된 체스는 경우의 수가 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mn>10</mn><mn>120</mn></msup></mrow><annotation encoding="application/x-tex">10^{120}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8141em"></span><span class="mord">1</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em"><span style="top:-3.063em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">120</span></span></span></span></span></span></span></span></span></span></span></span> 입니다.
하지만 바둑의 경우의 수는 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mn>10</mn><mn>170</mn></msup></mrow><annotation encoding="application/x-tex">10^{170}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8141em"></span><span class="mord">1</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em"><span style="top:-3.063em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">170</span></span></span></span></span></span></span></span></span></span></span></span> 으로 모든 경우의 수를 계산하려면 컴퓨터로 수십억 년이 걸린다고 합니다.
AlphaGo 는 이 많은 경우의 수를 어떻게 처리했을까요?</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="가능성이-있는-수들만-탐색해본다">가능성이 있는 수들만 탐색해본다.<a href="https://yongseongkim.github.io/blog/2019/01/19/alphago-lee/#%EA%B0%80%EB%8A%A5%EC%84%B1%EC%9D%B4-%EC%9E%88%EB%8A%94-%EC%88%98%EB%93%A4%EB%A7%8C-%ED%83%90%EC%83%89%ED%95%B4%EB%B3%B8%EB%8B%A4" class="hash-link" aria-label="Direct link to 가능성이 있는 수들만 탐색해본다." title="Direct link to 가능성이 있는 수들만 탐색해본다.">​</a></h3>
<p>이기기 위해 굳이 엉뚱한 곳에 수를 두고 경우의 수를 탐색할 필요는 없습니다.
승산이 있어 보이는 곳에 수를 두고 그 이후 경우의 수를 탐색해보면 됩니다.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="승산이-없는-게임은-굳이-더-탐색하지-않는다">승산이 없는 게임은 굳이 더 탐색하지 않는다.<a href="https://yongseongkim.github.io/blog/2019/01/19/alphago-lee/#%EC%8A%B9%EC%82%B0%EC%9D%B4-%EC%97%86%EB%8A%94-%EA%B2%8C%EC%9E%84%EC%9D%80-%EA%B5%B3%EC%9D%B4-%EB%8D%94-%ED%83%90%EC%83%89%ED%95%98%EC%A7%80-%EC%95%8A%EB%8A%94%EB%8B%A4" class="hash-link" aria-label="Direct link to 승산이 없는 게임은 굳이 더 탐색하지 않는다." title="Direct link to 승산이 없는 게임은 굳이 더 탐색하지 않는다.">​</a></h3>
<p>흔히 우리는 게임을 볼 때 어떤 상황에서 누가 이겼는지 졌는지를 판단하곤 합니다.
게임의 진행 정도가 지나면 지날수록 초보들도 누가 이겼는지 졌는지를 판단할 수 있습니다.
이처럼 이미 승패가 어느 정도 기운 상태에서는 굳이 그 이후의 수까지 탐색할 필요가 없습니다.</p>
<p>그러면 승산이 있을 만한 곳이 어디인지, 바둑판만 보고 내가 승산이 있는지 없는지는 어떻게 파악할까요?</p>
<h1>필요한 Networks</h1>
<p>이전에 언급했던 것과 같이 터무니없는 수를 두지 않기 위해, 바둑판을 보고 승산이 있는지 없는지를 알기 위해서는 몇 개의 준비물이 필요합니다.</p>
<ol>
<li>SL policy network</li>
<li>Rollout policy network</li>
<li>RL policy network</li>
<li>Value network</li>
</ol>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="sl-policy-network">SL Policy Network<a href="https://yongseongkim.github.io/blog/2019/01/19/alphago-lee/#sl-policy-network" class="hash-link" aria-label="Direct link to SL Policy Network" title="Direct link to SL Policy Network">​</a></h3>
<p>Supervised Learning Policy Network 는 바둑판의 상태를 입력으로 다음 수가 어디에 놓일지 예측하는 Network 입니다.
다음 수를 어느 곳에 둘지 나타내는 확률 분포가 출력으로 나옵니다.</p>
<p><img decoding="async" loading="lazy" alt="distribution" src="https://yongseongkim.github.io/assets/images/next-step-distribution-753409a0280373e5d3d876e22b4cbc2b.png" width="450" height="440" class="img_ev3q"></p>
<p>출처: <a href="https://www.nature.com/articles/nature16961" target="_blank" rel="noopener noreferrer">Mastering the game of Go with deep neural networks and tree search</a></p>
<p>전문가들의 기보를 기반으로 트레이닝하여 다음 수를 예측하는 데 대략 57% 의 정확도를 보였다고 합니다.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="rollout-policy-network">Rollout Policy Network<a href="https://yongseongkim.github.io/blog/2019/01/19/alphago-lee/#rollout-policy-network" class="hash-link" aria-label="Direct link to Rollout Policy Network" title="Direct link to Rollout Policy Network">​</a></h3>
<p>위 SL Policy Network 와 같이 전문가의 기보를 학습시킵니다. 출력도 다음 수에 관한 확률 분포로 위의 Policy Network 와 거의 비슷합니다.
하지만 입력에 대해 CNN을 사용하지 않고 사람이 생각하는 특징들을 입력으로 받으며 상대적으로 SL Policy Network 보다 가볍게 만든 Network 입니다.
정확도는 24% 정도로 SL Policy Network 보다 많이 낮습니다. 하지만 처리 시간은 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>2</mn><mi>μ</mi><mi>s</mi></mrow><annotation encoding="application/x-tex">2{\mu}s</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8389em;vertical-align:-0.1944em"></span><span class="mord">2</span><span class="mord"><span class="mord mathnormal">μ</span></span><span class="mord mathnormal">s</span></span></span></span> 로 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>3</mn><mi>m</mi><mi>s</mi></mrow><annotation encoding="application/x-tex">3ms</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em"></span><span class="mord">3</span><span class="mord mathnormal">m</span><span class="mord mathnormal">s</span></span></span></span> 걸리는 SL Policy Network 보다 1,000배가 넘게 빠릅니다.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="rl-policy-network">RL Policy Network<a href="https://yongseongkim.github.io/blog/2019/01/19/alphago-lee/#rl-policy-network" class="hash-link" aria-label="Direct link to RL Policy Network" title="Direct link to RL Policy Network">​</a></h3>
<p>Reinforcement Learning Policy Network 로 Network 끼리 플레이를 하면서 Game 을 이기는 방향으로 성장합니다.
Network 구조는 SL Policy Network 와 같습니다. 초기 사이사이 Weight 도 SL Policy Network 와 같은 값으로 초기화합니다.
경쟁 상대는 학습시켜오던 과정 중에 있던 Network 들을 모아 임의로 추출합니다.
예를 들면 SL Policy Network, 500번 학습한 RL Policy Network, 1000번 학습한 RL Policy Network ... 와 같이 Opponent Pool 에 저장한 후 이 Pool 에서 임의로 선택한 Network 와 시합을 하며 성장합니다.
Overfitting 을 막기 위해 많이 학습한 RL Policy Network 끼리 학습시키지 않고 다양한 적들과 상대합니다.
나중에 결과물의 RL Policy Network 는 SL Policy Network 를 상대로 80% 승률을 보였다고 합니다.
정교한 MCTS 를 이용한 프로그램 Pachi 를 상대로는 85% 승률을 보였다고 합니다.
SL Policy Network 는 Pachi 를 상대로 11% 승률을 보였다고 합니다.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="value-network">Value Network<a href="https://yongseongkim.github.io/blog/2019/01/19/alphago-lee/#value-network" class="hash-link" aria-label="Direct link to Value Network" title="Direct link to Value Network">​</a></h3>
<p>Value Network 는 바둑판의 상태를 보고 승률을 예측합니다.
위에서 설명한 Policy Network 들은 바둑판의 상태를 보고 다음 수에 대한 확률 분포를 내뱉습니다.
하지만 Value Network 는 같은 구조로 구성되지만, 승률만 내뱉습니다.</p>
<p><img decoding="async" loading="lazy" alt="Policy Network, Value network 의 Output" src="https://yongseongkim.github.io/assets/images/policy-value-network-output-636bfdadf8954c241d11f11b880500aa.png" width="800" height="760" class="img_ev3q"></p>
<p>출처: <a href="https://www.nature.com/articles/nature16961" target="_blank" rel="noopener noreferrer">Mastering the game of Go with deep neural networks and tree search</a></p>
<p>KGS 데이터로 학습시킨 Value Network 는 일반적으로 승률을 계산하기보다는 그전 결과들을 기억하여 트레이닝 데이터에서는 MSE 가 0.19이었지만 테스트 데이터에서는 0.37이 나왔습니다.
이러한 Overfitting 문제를 피하고자 RL Policy Network 끼리 경기한 3,000만 플레이 데이터를 모았다고 합니다.</p>
<p><img decoding="async" loading="lazy" alt="Value Network 성능 비교" src="https://yongseongkim.github.io/assets/images/value-network-mse-compare-8eb6e5d26374d080c2f473d73617941f.png" width="1000" height="480" class="img_ev3q"></p>
<p>출처: <a href="https://www.nature.com/articles/nature16961" target="_blank" rel="noopener noreferrer">Mastering the game of Go with deep neural networks and tree search</a></p>
<p>위에 표에서 X 축 오른쪽으로 갈수록 경기가 많이 진행됐음을 의미한다. 경기가 진행되면 될수록 초보자도 승패를 알 수 있으니 대체적으로 error 가 낮아집니다.
하지만 여기서 Policy Network 로 예측한 승률과 Value Network 의 승률 계산이 크게 차이 나지 않음을 볼 수 있습니다.
Policy Network 가 수를 두면서 결괏값을 예측하는 것보다 바둑판의 상태를 보고 승률을 예측하는 Value Network 가 매우 빠르므로 Value Network 를 사용합니다.</p>
<h1>MCTS: Monte Carlo Tree Search</h1>
<p>Monte Carlo 는 계산하려는 값을 구하기 힘들 때 수많은 시도를 통해 근사적으로 계산하는 방법을 말한다.
아래 그림은 수많은 점을 찍어 원주율을 계산하는 과정입니다.</p>
<p><img decoding="async" loading="lazy" alt="Monte Carlo Example" src="https://yongseongkim.github.io/assets/images/Pi_30K-e925f899ac858bd1df31047eec8ea00d.gif" width="500" height="500" class="img_ev3q"></p>
<p>출처: <a href="https://ko.wikipedia.org/wiki/%EB%AA%AC%ED%85%8C%EC%B9%B4%EB%A5%BC%EB%A1%9C_%EB%B0%A9%EB%B2%95" target="_blank" rel="noopener noreferrer">위키피디아 - 몬테카를로 방법</a></p>
<p>MCTS 는 가상으로 수많은 수를 두면서 트리를 구성하는 방식이다. 많은 게임을 하면 할수록 트리는 더 다양한 상황을 탐색하고 더 좋은 수를 알아낼 수 있습니다.
MCTS 는 크게 4 step(Selection, Expansion, Evaluation, Backup) 으로 나눌 수 있습니다.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="selection-expansion">Selection, Expansion<a href="https://yongseongkim.github.io/blog/2019/01/19/alphago-lee/#selection-expansion" class="hash-link" aria-label="Direct link to Selection, Expansion" title="Direct link to Selection, Expansion">​</a></h3>
<p>MCTS 의 첫 과정 Selection, Expansion 은 SL Policy 를 이용하여 트리를 만들어나갑니다.
트리에는 상태 s 에서 행동 a 를 취했을 때 얼마만큼의 가치가 있는지를 나타내는 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Q</mi><mo stretchy="false">(</mo><mi>s</mi><mo separator="true">,</mo><mi>a</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">Q(s, a)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord mathnormal">Q</span><span class="mopen">(</span><span class="mord mathnormal">s</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord mathnormal">a</span><span class="mclose">)</span></span></span></span>, 방문 횟수 N(s, a) 그리고 사전확률 P(s, a) 등을 저장합니다.</p>
<p><img decoding="async" loading="lazy" alt="MCTS Selection" src="https://yongseongkim.github.io/assets/images/mcts-step-selection-37ddc2b3c889025ee28dd9d724d22b2c.png" width="411" height="412" class="img_ev3q"></p>
<p>출처: <a href="https://www.nature.com/articles/nature16961" target="_blank" rel="noopener noreferrer">Mastering the game of Go with deep neural networks and tree search</a></p>
<p>먼저 위 그림과 같이 루트에서 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Q</mi><mo>+</mo><mi>u</mi><mo stretchy="false">(</mo><mi>p</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">Q+u(p)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em"></span><span class="mord mathnormal">Q</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord mathnormal">u</span><span class="mopen">(</span><span class="mord mathnormal">p</span><span class="mclose">)</span></span></span></span> 큰 값의 상태를 따라 내려갑니다.</p>
<p><img decoding="async" loading="lazy" alt="MCTS Expansion" src="https://yongseongkim.github.io/assets/images/mcts-step-expansion-2d966d87817724f97f75d7ce791d85f7.png" width="317" height="433" class="img_ev3q"></p>
<p>출처: <a href="https://www.nature.com/articles/nature16961" target="_blank" rel="noopener noreferrer">Mastering the game of Go with deep neural networks and tree search</a></p>
<p>값이 높은 방향으로 선택하면서 내려가다가 이미 방문했던 상태 이외에 큰 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Q</mi><mo>+</mo><mi>u</mi><mo stretchy="false">(</mo><mi>p</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">Q+u(p)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em"></span><span class="mord mathnormal">Q</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord mathnormal">u</span><span class="mopen">(</span><span class="mord mathnormal">p</span><span class="mclose">)</span></span></span></span> 를 만나면 그림처럼 가지를 뻗어 나갑니다.
<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>u</mi><mo stretchy="false">(</mo><mi>p</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">u(p)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord mathnormal">u</span><span class="mopen">(</span><span class="mord mathnormal">p</span><span class="mclose">)</span></span></span></span> 는 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi><mo stretchy="false">(</mo><mi>s</mi><mo separator="true">,</mo><mi>a</mi><mo stretchy="false">)</mo><mi mathvariant="normal">/</mi><mi>N</mi><mo stretchy="false">(</mo><mi>s</mi><mo separator="true">,</mo><mi>a</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">P(s, a) / N(s, a)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord mathnormal" style="margin-right:0.13889em">P</span><span class="mopen">(</span><span class="mord mathnormal">s</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord mathnormal">a</span><span class="mclose">)</span><span class="mord">/</span><span class="mord mathnormal" style="margin-right:0.10903em">N</span><span class="mopen">(</span><span class="mord mathnormal">s</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord mathnormal">a</span><span class="mclose">)</span></span></span></span> 값에 비례합니다.
초기에는 exploration 관점에서 낮은 방문 횟수의 상태를 선호하지만, 점근적으로 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Q</mi></mrow><annotation encoding="application/x-tex">Q</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em"></span><span class="mord mathnormal">Q</span></span></span></span>가 큰 값을 선택합니다.
방문을 많이 하면 할수록 시뮬레이션을 많이 하고 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Q</mi></mrow><annotation encoding="application/x-tex">Q</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em"></span><span class="mord mathnormal">Q</span></span></span></span> 값은 더 정교해집니다.
여기서 RL Policy Network 를 쓰지 않는 이유는 SL Policy Network 가 성능이 더 좋았다고 합니다.</p>
<p><code>Humans select a diverse beam of promising moves, whereas RL potimizes for the single best move</code></p>
<p>출처: <a href="https://www.nature.com/articles/nature16961" target="_blank" rel="noopener noreferrer">Mastering the game of Go with deep neural networks and tree search</a></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="evaluation">Evaluation<a href="https://yongseongkim.github.io/blog/2019/01/19/alphago-lee/#evaluation" class="hash-link" aria-label="Direct link to Evaluation" title="Direct link to Evaluation">​</a></h2>
<p>Selection, Expansion 으로 바둑돌을 놓은 후 얼마나 좋은 수인지 가치를 매깁니다.</p>
<p><img decoding="async" loading="lazy" alt="MCTS Evaluation" src="https://yongseongkim.github.io/assets/images/mcts-step-evaluation-3c7c685eb773d014014f9fbb5df0e98d.png" width="425" height="531" class="img_ev3q"></p>
<p>출처: <a href="https://www.nature.com/articles/nature16961" target="_blank" rel="noopener noreferrer">Mastering the game of Go with deep neural networks and tree search</a></p>
<p>여기서 판단하는 방식이 2가지가 있는데, 첫 번째로는 Value Network 를 써서 바둑판의 상태를 보고 승률을 예측해봅니다.
두 번째로 위에서 언급했던 SL Policy Network 보다 가볍고 빠른 Rollout Policy Network 을 이용해서 가상으로 끝까지 게임을 플레이 합니다.
예를 들면 끝까지 게임을 두어서 내가 흑돌로 플레이 한 상태로 흑돌이 이겼으면 +1 졌으면 -1 보상을 받습니다.
Value Network 의 값과 Rollout Policy Network 로 플레이한 게임의 결과를 합하여 그 수가 얼마나 좋은지 판단합니다.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="backup">Backup<a href="https://yongseongkim.github.io/blog/2019/01/19/alphago-lee/#backup" class="hash-link" aria-label="Direct link to Backup" title="Direct link to Backup">​</a></h2>
<p>이렇게 Selection, Expansion, Evaluation 을 해서 얻은 값을 지나온 경로의 상태들에 반영됩니다.
반영된 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Q</mi></mrow><annotation encoding="application/x-tex">Q</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em"></span><span class="mord mathnormal">Q</span></span></span></span> 값을 보고 다음 Selection, Expansion, Evaluation 을 반복합니다.</p>
<p><img decoding="async" loading="lazy" alt="MCTS Backup" src="https://yongseongkim.github.io/assets/images/mcts-step-backup-cbb46c7fdee13ed0f47acb1f3a005e85.png" width="513" height="546" class="img_ev3q"></p>
<p>출처: <a href="https://www.nature.com/articles/nature16961" target="_blank" rel="noopener noreferrer">Mastering the game of Go with deep neural networks and tree search</a></p>
<h1>Conclusion</h1>
<p>바둑에서는 셀 수 없이 많은 경우의 수가 존재하지만 AlphaGo 는 탐색할 경우의 수를 줄이면서 프로 바둑 기사에게 승리를 거둡니다.
수 읽기 시간에 많은 시뮬레이션을 통해 가능한 경우의 수들을 트리로 구성합니다.
트리를 구성하는 과정에서 전문가들의 기보를 학습한 Policy Network 로 가능성이 있는 수들만 탐색하고,
Value Network 와 Rollout Policy Network 을 이용하여 승률을 예측합니다.
많은 수를 경험하면 트리의 정확도는 올라가지만 바둑에서는 시간이 제한적이기 때문에 탐색 수를 적절하게 조절해야 합니다.
Atari 게임에서 강화학습을 이용한 사례들과는 다르게 사람의 기보를 기반으로 만든 Network 를 사용한다는 한계가 있습니다.</p>]]></content>
        <category label="reinforcement learning" term="reinforcement learning"/>
        <category label="alphago" term="alphago"/>
    </entry>
</feed>